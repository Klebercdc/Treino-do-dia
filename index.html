<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Smart Log</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>

    <link rel="icon" href="Logo.png" type="image/png" />

    <style>
      :root {
        --bg: #0b1220; --card: #161e2e; --blue: #3182ce; --text: #f7fafc;
        --orange: #f6ad55; --green: #38b2ac; --red: #e53e3e;
      }
      body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }

      .top-header { padding: 15px; background: var(--card); border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
      .date-badge { font-size: 0.8rem; color: var(--orange); font-weight: bold; background: #0b1220; padding: 4px 10px; border-radius: 15px; }

      .setup-panel { background: var(--card); padding: 20px; border-bottom: 3px solid var(--blue); display: block; }
      .field { margin-bottom: 15px; }
      .field label { font-size: 0.7rem; color: #a0aec0; display: block; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
      .field select, .field input { width: 100%; padding: 12px; background: #0b1220; color: #fff; border: 1px solid var(--blue); border-radius: 8px; box-sizing: border-box; }

      .nav-pills { display: flex; gap: 8px; padding: 10px; background: var(--bg); overflow-x: auto; border-bottom: 1px solid #2d3748; }
      .pill { flex: none; padding: 12px 20px; border-radius: 8px; background: #1a202c; font-weight: bold; font-size: 0.75rem; border: 1px solid #2d3748; cursor: pointer; color: #a0aec0; position: relative; }
      .pill.active { background: var(--blue); border-color: var(--blue); color: #fff; }

      .section { display: none; }
      .section.active { display: block; }

      .exercise-card { background: var(--card); border-radius: 12px; padding: 15px; margin: 10px; border: 1px solid #2d3748; animation: fadeIn 0.3s ease; position: relative; }
      .ex-title { font-weight: 800; font-size: 1.1rem; color: var(--blue); text-decoration: underline dotted; cursor: pointer; }
      
      .rm-mini-badge { font-size: 0.6rem; color: var(--green); font-family: monospace; display: block; margin-top: 2px; }

      .series-grid { display: grid; grid-template-columns: 40px 1fr 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 8px; }
      .header-grid { text-align: center; font-size: 0.6rem; color: #718096; font-weight: bold; }
      .input-box { background: #0b1220; border: 1px solid #2d3748; border-radius: 6px; }
      .input-box input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.1rem; padding: 8px 0; outline: none; font-weight: bold; }

      .footer-actions { padding: 20px 10px; display: flex; gap: 8px; flex-wrap: wrap; }
      .btn { padding: 15px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; flex: 1; text-align: center; font-size: 0.75rem; text-transform: uppercase; min-width: 80px; }
      .btn-save { background: var(--green); color: #fff; box-shadow: 0 4px 0 #2d8a84; }
      .btn-config { background: #2d3748; color: var(--blue); border: 1px solid var(--blue); }
      .btn-ia { background: #1a202c; color: var(--orange); border: 1px solid var(--orange); }

      dialog { background: #161e2e; color: #fff; border: 1px solid var(--blue); border-radius: 12px; width: 90%; max-width: 500px; padding: 20px; }
      #csvTextarea { width: 100%; height: 200px; padding: 12px; background: #0b1220; border: 1px solid var(--blue); border-radius: 8px; color: #fff; font-family: monospace; resize: none; outline: none; }

      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <div class="top-header">
      <div class="header-left">
        <h1 style="margin: 0; font-size: 1.1rem; color: var(--blue)">TITAN <span style="color: #fff">PRO</span></h1>
      </div>
      <div class="date-badge" id="displayDate">--/--/--</div>
    </div>

    <div class="setup-panel" id="setupPanel">
      <div class="field">
        <label>NVIDIA API KEY (Nemotron-70B)</label>
        <input type="password" id="apiKeyInput" placeholder="Sua chave nvapi-..." onchange="saveApiKey()">
      </div>
      <div class="field">
        <label>Frequ√™ncia Semanal</label>
        <select id="freq" onchange="gerarProtocolo()">
          <option value="3" selected>3 Dias (ABC)</option>
          <option value="4">4 Dias (ABCD)</option>
          <option value="5">5 Dias (ABCDE)</option>
        </select>
      </div>
      <button class="btn btn-save" onclick="closeConfig()" style="margin-top: 12px">ABRIR TREINO</button>
    </div>

    <div class="nav-pills" id="nav"></div>
    <main id="container"></main>

    <div class="footer-actions">
      <button class="btn btn-config" onclick="openConfig()">‚öôÔ∏è CONFIG</button>
      <button class="btn btn-ia" onclick="enviarParaIA()">ü§ñ IA ANALYST</button>
      <button class="btn btn-save" onclick="salvarTreino()">SALVAR SESS√ÉO</button>
      <button class="btn btn-config" onclick="abrirCSVModal()" style="background: var(--orange); color: white; flex: 0.5">üìä ARQUIVOS</button>
    </div>

    <dialog id="modalCSV">
      <h3 style="color: var(--orange)">Arquivos e Fichas</h3>
      <textarea id="csvTextarea" placeholder="Cole o CSV aqui..."></textarea>
      <div style="display: flex; gap: 8px; margin-top: 10px;">
        <button class="btn" style="background: var(--green); color: white; flex: 1" onclick="importarCSV()">‚úì IMPORTAR</button>
      </div>
      <button class="btn" onclick="document.getElementById('modalCSV').close()" style="width: 100%; margin-top: 10px; background: #2d3748; color: white">Fechar</button>
    </dialog>

    <script>
      const STORAGE = {
        apiKey: "titanpro_nvidia_key",
        draft: "titanpro_draft"
      };

      function saveApiKey() {
        const val = document.getElementById('apiKeyInput').value;
        localStorage.setItem(STORAGE.apiKey, val);
      }

      function calcularBrzycki(peso, reps, rpe) {
        const K = parseFloat(String(peso || "").replace(",", "."));
        const R = parseFloat(reps);
        const E = parseFloat(rpe) || 10;
        if (!K || !R) return 0;
        const rir = 10 - E;
        return K / (1.0278 - (0.0278 * (R + rir)));
      }

      function criarCard(nome, sectionId) {
        const id = "ex-" + Math.random().toString(36).slice(2, 9);
        const sec = document.getElementById(sectionId);
        const card = document.createElement("div");
        card.className = "exercise-card";
        card.setAttribute("data-ex-id", id);
        card.setAttribute("data-ex-name", nome);

        let rowsHtml = "";
        for (let s = 0; s < 4; s++) {
          rowsHtml += `
            <div class="series-grid">
              <div style="text-align:center">
                <span style="font-size:0.7rem; font-weight:bold; color:#718096">S${s+1}</span>
                <span class="rm-mini-badge" id="rm-val-${id}-${s}">-</span>
              </div>
              <div class="input-box"><input type="number" placeholder="KG" oninput="updateRowRM('${id}', ${s})"></div>
              <div class="input-box"><input type="number" placeholder="REPS" oninput="updateRowRM('${id}', ${s})"></div>
              <div class="input-box"><input type="number" placeholder="RPE" oninput="updateRowRM('${id}', ${s})"></div>
            </div>`;
        }

        card.innerHTML = `<span class="ex-title">${nome}</span>${rowsHtml}`;
        sec.appendChild(card);
      }

      function updateRowRM(exId, rowIdx) {
        const card = document.querySelector(`[data-ex-id="${exId}"]`);
        const row = card.querySelectorAll(".series-grid")[rowIdx];
        const inps = row.querySelectorAll("input");
        const rm = calcularBrzycki(inps[0].value, inps[1].value, inps[2].value);
        const display = document.getElementById(`rm-val-${exId}-${rowIdx}`);
        if(display) display.innerText = rm > 0 ? Math.round(rm) + "kg" : "-";
      }

      async function enviarParaIA() {
        const key = localStorage.getItem(STORAGE.apiKey);
        if(!key || key.trim() === "") return alert("‚ö†Ô∏è Configure a API Key no bot√£o CONFIG (Engrenagem).");
        
        const treino = [...document.querySelectorAll(".exercise-card")].map(c => ({
          nome: c.getAttribute("data-ex-name"),
          series: [...c.querySelectorAll(".series-grid")].map(r => {
            const i = r.querySelectorAll("input");
            return { kg: i[0].value, reps: i[1].value, rpe: i[2].value };
          })
        }));

        try {
          const res = await fetch("https://integrate.api.nvidia.com/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
              model: "nvidia/llama-3.1-nemotron-70b-instruct",
              messages: [{ role: "user", content: `Analise meu treino: ${JSON.stringify(treino)}` }]
            })
          });
          const data = await res.json();
          if(data.choices) alert("ü§ñ IA: " + data.choices[0].message.content);
          else alert("Erro na resposta da API.");
        } catch(e) { alert("Erro ao conectar na API."); }
      }

      function openConfig() { document.getElementById("setupPanel").style.display = "block"; }
      function closeConfig() { document.getElementById("setupPanel").style.display = "none"; }
      function abrirCSVModal() { document.getElementById("modalCSV").showModal(); }

      function gerarProtocolo() {
        const f = document.getElementById("freq").value;
        const nav = document.getElementById("nav");
        const cont = document.getElementById("container");
        nav.innerHTML = ""; cont.innerHTML = "";
        for(let i=0; i<f; i++) {
          const label = "Treino " + String.fromCharCode(65 + i);
          nav.innerHTML += `<div class="pill ${i===0?'active':''}" onclick="tab(${i})">${label}</div>`;
          const sec = document.createElement("div");
          sec.id = "sec"+i; sec.className = "section "+(i===0?'active':'');
          cont.appendChild(sec);
          criarCard("Exerc√≠cio Inicial", sec.id);
        }
      }

      function tab(idx) {
        document.querySelectorAll(".section, .pill").forEach(el => el.classList.remove("active"));
        document.getElementById(`sec${idx}`).classList.add("active");
        document.querySelectorAll(".pill")[idx].classList.add("active");
      }

      window.onload = () => {
        document.getElementById("displayDate").innerText = new Date().toLocaleDateString("pt-BR");
        // CORRE√á√ÉO: Carrega a chave salva ao abrir o app
        const savedKey = localStorage.getItem(STORAGE.apiKey);
        if(savedKey) document.getElementById("apiKeyInput").value = savedKey;
        gerarProtocolo();
      };
    </script>
  </body>
</html>
