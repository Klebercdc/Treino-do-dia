<script>
let ultimaSessao = null;

function buscarValoresAntigos(nome) {
  if (!ultimaSessao) return [];
  for (const sec of ultimaSessao.sections || []) {
    for (const card of sec.cards || []) {
      if ((card.name || "").trim().toLowerCase() === nome.trim().toLowerCase()) {
        return card.values || [];
      }
    }
  }
  return [];
}

const originalCriarCard = criarCard;
criarCard = function(nome, sectionId, series = null, reps = null, rpe = null, values = null) {
  const o = document.getElementById("obj").value;
  const meta = reps || (o === "forca" ? "3-5 Reps" : (o === "hipertrofia" ? "8-12 Reps" : "15-20 Reps"));
  const sets = series || (o === "forca" ? 5 : (o === "definicao" ? 3 : 4));
  const id = "ex-" + Math.random().toString(36).substr(2, 7);

  const card = document.createElement("div");
  card.className = "exercise-card";
  card.setAttribute("data-ex-id", id);
  card.setAttribute("data-ex-name", nome);
  card.setAttribute("data-ex-sets", String(sets));
  card.setAttribute("data-ex-meta", meta);
  card.setAttribute("data-ex-rpehint", rpe || "");

  const antigos = buscarValoresAntigos(nome);

  const rows = Array.from({ length: sets }, (_, s) => {
    const ant = antigos[s] || {};
    const kgVal = values && values[s] ? (values[s].kg ?? "") : "";
    const repsVal = values && values[s] ? (values[s].reps ?? "") : "";
    const rpeVal = values && values[s] ? (values[s].rpe ?? "") : "";
    return `
      <div class="series-grid">
        <span style="font-size:0.7rem; color:#718096; text-align:center;">S${s + 1}</span>
        <div class="input-box"><input type="number" inputmode="decimal" value="${kgVal}" placeholder="${ant.kg ? ant.kg + 'kg' : ''}" style="opacity:0.85;"></div>
        <div class="input-box"><input type="number" value="${repsVal}" placeholder="${ant.reps ? ant.reps + ' reps' : ''}" style="opacity:0.85;"></div>
        <div class="input-box"><input type="number" value="${rpeVal}" placeholder="${ant.rpe ? 'RPE ' + ant.rpe : ''}" style="opacity:0.85;"></div>
      </div>`;
  }).join("");

  card.innerHTML = `
    <span class="remove-ex" onclick="this.parentElement.remove(); scheduleDraftSave();">Ã—</span>
    <span class="ex-title" id="${id}" onclick="abrirLibParaTrocar('${id}')">${nome}</span>
    <span class="ex-target">${sets} Sets x ${meta}</span>
    <div class="series-grid header-grid"><span>SET</span><span>KG</span><span>REPS</span><span>RPE</span></div>
    ${rows}
  `;

  document.getElementById(sectionId).appendChild(card);
  attachAutosaveToCard(card);
  scheduleDraftSave();
};

window.addEventListener("DOMContentLoaded", () => {
  try {
    const raw = localStorage.getItem("titanpro_history_v2");
    if (raw) {
      const hist = JSON.parse(raw);
      if (Array.isArray(hist) && hist.length > 0 && hist[0].state) {
        ultimaSessao = hist[0].state;
      }
    }
  } catch (_) {}
});
</script>