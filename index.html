<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Periodization Coach</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <link rel="icon" href="Logo.png" type="image/png" />

    <style>
      :root { --bg:#0b1220; --card:#161e2e; --blue:#3182ce; --text:#f7fafc; --orange:#f6ad55; --green:#38b2ac; --red:#e53e3e; }
      body { background:var(--bg); color:var(--text); font-family:-apple-system,sans-serif; margin:0; padding-bottom:20px; }

      /* HEADER */
      .top-header { padding:15px; background:var(--card); border-bottom:1px solid #2d3748; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; }
      .date-badge { font-size:.8rem; color:var(--orange); font-weight:bold; background:#0b1220; padding:4px 10px; border-radius:15px; }
      .header-left { display:flex; align-items:center; gap:12px; }
      .logo-img { height:45px; width:auto; object-fit:contain; filter:drop-shadow(0 0 8px rgba(49,130,206,.6)); }

      /* TIMER */
      .timer-area { background:#1a202c; padding:12px; border-bottom:2px solid var(--blue); text-align:center; }
      #timerDisplay { font-size:2.2rem; font-weight:800; color:var(--blue); font-family:monospace; margin-bottom:8px; }
      .timer-btns { display:flex; gap:6px; justify-content:center; margin-bottom:5px; }
      .btn-t { background:#2d3748; color:#fff; border:none; padding:8px 12px; border-radius:8px; font-size:.75rem; cursor:pointer; font-weight:bold; }
      .btn-t.active { background:var(--blue); }
      .btn-ctrl { background:var(--green); color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; font-size:.8rem; }

      /* SETUP PANEL */
      .setup-panel { background:var(--card); padding:20px; border-bottom:3px solid var(--blue); display:block; }
      .field { margin-bottom:15px; }
      .field label { font-size:.7rem; color:#a0aec0; display:block; margin-bottom:5px; font-weight:bold; text-transform:uppercase; }
      .field select { width:100%; padding:12px; background:#0b1220; color:#fff; border:1px solid var(--blue); border-radius:8px; font-weight:bold; }

      /* TABS / PILLS */
      .nav-pills { display:flex; gap:8px; padding:10px; background:var(--bg); overflow-x:auto; border-bottom:1px solid #2d3748; }
      .pill { flex:none; padding:12px 20px; border-radius:8px; background:#1a202c; font-weight:bold; font-size:.75rem; border:1px solid #2d3748; cursor:pointer; color:#a0aec0; position:relative; padding-right:34px; }
      .pill.active { background:var(--blue); border-color:var(--blue); color:#fff; }
      .pill .pill-x { position:absolute; right:10px; top:50%; transform:translateY(-50%); color:var(--red); font-weight:900; font-size:1rem; line-height:1; padding:2px 6px; border-radius:8px; cursor:pointer; }
      .pill.add-pill { padding-right:20px; border:2px dashed var(--blue); color:var(--blue); background:#1a202c; }

      /* EXERCISES */
      .section { display:none; }
      .section.active { display:block; }
      .exercise-card { background:var(--card); border-radius:12px; padding:15px; margin:10px; border:1px solid #2d3748; animation:fadeIn .3s ease; position:relative; }
      .ex-title { font-weight:800; font-size:1.1rem; color:var(--blue); text-decoration:underline dotted; cursor:pointer; }
      .ex-target { font-size:.75rem; color:var(--orange); font-weight:bold; margin:4px 0 5px 0; display:block; }
      .remove-ex { position:absolute; top:10px; right:10px; color:var(--red); font-size:1.2rem; cursor:pointer; font-weight:bold; padding:5px; }
      .rpe-suggest { display:block; font-size:0.7rem; color:var(--green); margin-bottom:10px; font-family:monospace; }

      .series-grid { display:grid; grid-template-columns:40px 1fr 1fr 1fr; gap:8px; align-items:center; margin-bottom:8px; }
      .header-grid { text-align:center; font-size:.6rem; color:#718096; font-weight:bold; }
      .input-box { background:#0b1220; border:1px solid #2d3748; border-radius:6px; padding:8px 0; transition: border-color 0.3s ease; }
      .input-box.filled { border-color: var(--green); box-shadow: 0 0 5px rgba(56, 178, 172, 0.3); }
      .input-box input { background:transparent; border:none; color:#fff; width:100%; text-align:center; font-size:1.1rem; outline:none; font-weight:bold; }
      
      .btn-add-ex { background:#1a202c; color:var(--blue); border:2px dashed var(--blue); width:calc(100% - 20px); margin:15px 10px; padding:15px; border-radius:12px; font-weight:800; cursor:pointer; }

      /* FOOTER */
      .footer-actions { padding:20px 10px 40px 10px; display:flex; gap:12px; background:transparent; flex-wrap:wrap;}
      .btn { padding:15px; border-radius:10px; border:none; font-weight:800; cursor:pointer; flex:1; text-align:center; font-size:.75rem; text-transform:uppercase; min-width: 80px; }
      .btn-save { background:var(--green); color:#fff; box-shadow:0 4px 0 #2d8a84; flex:2; }
      .btn-config { background:#2d3748; color:var(--blue); border:1px solid var(--blue); }

      /* MODALS */
      dialog { background:#161e2e; color:#fff; border:1px solid var(--blue); border-radius:12px; width:90%; max-width:500px; padding:20px; }
      dialog::backdrop { background: rgba(0,0,0,0.8); }
      .lib-item { padding:12px; border-bottom:1px solid #2d3748; cursor:pointer; }
      
      #csvTextarea { width:100%; height:220px; padding:12px; background:#0b1220; border:1px solid var(--blue); border-radius:8px; color:#fff; font-family:monospace; font-size:.8rem; resize:none; margin-bottom:12px; outline:none; }
      .csv-info { font-size:.7rem; color:#a0aec0; margin-bottom:12px; line-height:1.4; }
      .csv-buttons { display:flex; gap:8px; flex-wrap:wrap; }
      .csv-buttons button, .csv-buttons label { flex:1; padding:12px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; min-width:130px; text-align:center; font-size: 0.8rem; display:flex; align-items:center; justify-content:center;}
      .btn-import { background:var(--green); color:#fff; }
      .btn-cancel { background:#2d3748; color:var(--blue); }

      #histList { max-height:360px; overflow-y:auto; border:1px solid #2d3748; border-radius:10px; }
      .hist-item { padding:12px; border-bottom:1px solid #2d3748; cursor:pointer; }
      .hist-item strong { color:var(--orange); }
      .hist-actions { display:flex; gap:8px; margin-top:12px; }
      .hist-actions button { flex:1; padding:12px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; }

      #tplList { max-height:220px; overflow-y:auto; border:1px solid #2d3748; border-radius:10px; margin-top:10px; }
      .tpl-item { padding:10px 12px; border-bottom:1px solid #2d3748; cursor:pointer; }
      .tpl-item small { color:#a0aec0; display:block; margin-top:4px; font-size:.7rem; }
      .tpl-actions { display:flex; gap:8px; margin-top:10px; }
      
      @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to { opacity:1; transform:translateY(0);} }
    </style>
  </head>

  <body>
    <div class="top-header">
      <div class="header-left">
        <img src="Logo.png" alt="Logo" class="logo-img" />
        <h1 style="margin:0; font-size:1.1rem; color:var(--blue);">TITAN <span style="color:#fff">PRO</span></h1>
      </div>
      <div class="date-badge" id="displayDate">--/--/--</div>
    </div>

    <div class="timer-area">
      <div id="timerDisplay">01:00</div>
      <div class="timer-btns">
        <button class="btn-t active" onclick="setT(60, this)">1m</button>
        <button class="btn-t" onclick="setT(120, this)">2m</button>
        <button class="btn-t" onclick="setT(180, this)">3m</button>
        <button class="btn-t" onclick="setT(300, this)">5m</button>
      </div>
      <div class="timer-btns">
        <button id="ctrlBtn" class="btn-ctrl" onclick="toggleT()">INICIAR</button>
        <button class="btn-ctrl" style="background:var(--red)" onclick="resetT()">ZERAR</button>
      </div>
    </div>

    <div class="setup-panel" id="setupPanel">
      <div class="field">
        <label>Frequ√™ncia Semanal</label>
        <select id="freq" onchange="gerarProtocolo()">
          <option value="2">2 Dias (Full Body)</option>
          <option value="3" selected>3 Dias (ABC)</option>
          <option value="4">4 Dias (Upper/Lower)</option>
          <option value="5">5 Dias (ABCDE)</option>
          <option value="6">6 Dias (PPL x2)</option>
        </select>
      </div>

      <div class="field">
        <label>Objetivo do Mesociclo</label>
        <select id="obj" onchange="gerarProtocolo()">
          <option value="hipertrofia">Hipertrofia (Foco Geral)</option>
          <option value="forca">For√ßa (Baixas Reps / Alta Carga)</option>
          <option value="resistencia">Resist√™ncia/RML (15+ Reps)</option>
        </select>
      </div>
      
      <button class="btn btn-config" onclick="limparApenasValores()" style="width:100%; border:1px solid var(--red); color:var(--red); margin-top:10px;">‚ôªÔ∏è NOVA SEMANA (LIMPAR CARGAS)</button>
      
      <button class="btn btn-save" onclick="closeConfig()" style="margin-top:12px;">ABRIR TREINO</button>
    </div>

    <div class="nav-pills" id="nav"></div>
    <main id="container"></main>
    <button class="btn-add-ex" onclick="abrirLibParaNovo()">+ ADICIONAR EXERC√çCIO</button>

    <div class="footer-actions">
      <button class="btn btn-config" onclick="openConfig()">‚öôÔ∏è CONFIG</button>
      <button class="btn btn-config" onclick="showEvoChart()">üìà EVOLU√á√ÉO</button>
      <button class="btn btn-save" onclick="salvarTreino()">SALVAR SESS√ÉO</button>
      <button class="btn btn-config" onclick="abrirCSVModal()" style="flex:0.5; background:var(--orange); color:white;">üìä ARQUIVOS</button>
      <button class="btn btn-config" onclick="verHistorico()" style="flex:0.4">üìú HIST</button>
    </div>

    <dialog id="modalLib">
      <h3 id="libHeader" style="margin:0 0 15px 0; color:var(--orange)">Trocar Exerc√≠cio</h3>
      <div style="margin-bottom:15px; display:flex; gap:5px;">
        <input type="text" id="manualName" placeholder="Nome personalizado..." style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--blue); background:#0b1220; color:white; outline:none;">
        <button onclick="adicionarManual()" style="background:var(--blue); color:white; border:none; border-radius:8px; padding:0 15px; font-weight:bold;">+</button>
      </div>
      <div id="libContent" style="max-height:300px; overflow-y:auto;"></div>
      <button class="btn" onclick="document.getElementById('modalLib').close()" style="width:100%; margin-top:10px; background:#2d3748; color:white;">Fechar</button>
    </dialog>

    <dialog id="modalCSV">
      <h3 style="margin:0 0 15px 0; color:var(--orange)">Importar & Backup</h3>
      <div class="csv-info">
        <strong>Op√ß√£o 1 (PDF):</strong> Use o bot√£o "LER PDF" para abrir ficha do celular.<br />
        <strong>Op√ß√£o 2 (CSV):</strong> Cole o CSV do Excel/Sheets.<br />
      </div>

      <textarea id="csvTextarea" placeholder="Cole o CSV ou use o bot√£o PDF..."></textarea>

      <div class="csv-buttons">
        <label class="btn-cancel" style="background:var(--blue); color:white;">
          üìÑ LER PDF
          <input type="file" id="pdfUpload" accept=".pdf" style="display:none" onchange="extrairTextoPDF(this)">
        </label>
        
        <button class="btn-import" onclick="importarCSV()">‚úì IMPORTAR</button>
        <button class="btn-config" onclick="fazerBackup()" style="background:#4a5568; color:white;">‚òÅÔ∏è BACKUP</button>
        
        <button class="btn-cancel" onclick="salvarModeloCSV()">üíæ SALVAR MOD</button>
        <button class="btn-cancel" onclick="mostrarModelosCSV()">üìö MODELOS</button>
        <button class="btn-cancel" onclick="document.getElementById('modalCSV').close()">‚úï FECHAR</button>
      </div>

      <div id="tplArea" style="display:none; margin-top:12px;">
        <div style="color:var(--orange); font-weight:bold; margin-bottom:8px;">Modelos salvos</div>
        <div id="tplList"></div>
        <div class="tpl-actions">
          <button class="btn-cancel" onclick="limparModelosCSV()">üóëÔ∏è LIMPAR MODELOS</button>
          <button class="btn-import" onclick="hideModelosCSV()">OK</button>
        </div>
      </div>
    </dialog>

    <dialog id="modalHIST">
      <h3 style="margin:0 0 15px 0; color:var(--orange)">Hist√≥rico de Sess√µes</h3>
      <div id="histList"></div>
      <div class="hist-actions">
        <button class="btn-cancel" onclick="limparHistorico()">üóëÔ∏è LIMPAR</button>
        <button class="btn-import" onclick="document.getElementById('modalHIST').close()">FECHAR</button>
      </div>
    </dialog>

    <script>
      /* =========================================
         1. CAT√ÅLOGO DE TREINOS COM PERIODIZA√á√ÉO (L√ìGICA ANINHADA)
         ========================================= */
      const TREINOS_PRONTOS = {
        "3": {
            "hipertrofia": [
                { nome: "A (Push - Volume)", exs: ["Supino Inclinado Halter", "Supino Reto Barra", "Desenvolvimento M√°quina", "Eleva√ß√£o Lateral", "Tr√≠ceps Corda", "Tr√≠ceps Testa"] },
                { nome: "B (Pull - Volume)", exs: ["Puxada Alta Aberta", "Remada Curvada", "Remada Baixa Tri√¢ngulo", "Face Pull", "Rosca Direta", "Rosca Scott"] },
                { nome: "C (Legs - Volume)", exs: ["Agachamento Livre", "Leg Press 45", "Cadeira Extensora", "Mesa Flexora", "Stiff Halter", "Panturrilha Sentado"] }
            ],
            "forca": [
                { nome: "A (Push - For√ßa)", exs: ["Supino Reto (Foco Carga)", "Desenvolvimento Militar", "Supino Fechado", "Paralelas"] },
                { nome: "B (Pull - For√ßa)", exs: ["Levantamento Terra", "Remada Pendlay", "Barra Fixa (com peso)", "Rosca Martelo"] },
                { nome: "C (Legs - For√ßa)", exs: ["Agachamento Livre (Low Bar)", "Agachamento Frontal", "Stiff Barra", "Panturrilha em P√©"] }
            ],
            "resistencia": [
                { nome: "A (Full Body 1)", exs: ["Agachamento Ta√ßa", "Flex√£o de Bra√ßo", "Remada Invertida", "Abdominal Supra", "Polichinelo"] },
                { nome: "B (Full Body 2)", exs: ["Afundo", "Desenvolvimento Halter", "Puxada Alta", "Prancha", "Burpees"] },
                { nome: "C (Full Body 3)", exs: ["Leg Press", "Supino M√°quina", "Rosca Direta", "Tr√≠ceps Banco", "Corrida Estacion√°ria"] }
            ]
        },
        "4": {
            "hipertrofia": [
                { nome: "A (Upper - Foco Peito/Costas)", exs: ["Supino Inclinado", "Remada Curvada", "Voador", "Puxada Alta", "Eleva√ß√£o Lateral", "Rosca Direta"] },
                { nome: "B (Lower - Foco Quads)", exs: ["Agachamento Livre", "Leg Press", "Extensora", "Passada", "Panturrilha em P√©"] },
                { nome: "C (Upper - Foco Ombros/Bra√ßos)", exs: ["Desenvolvimento", "Barra Fixa", "Eleva√ß√£o Lateral Polia", "Tr√≠ceps Corda", "Rosca Scott", "Face Pull"] },
                { nome: "D (Lower - Foco Posterior)", exs: ["Levantamento Terra", "Mesa Flexora", "Stiff", "Cadeira Abdutora", "Panturrilha Sentado"] }
            ],
            "forca": [
                { nome: "A (Upper - Press√£o)", exs: ["Supino Reto (Pausa)", "Supino Inclinado", "Desenvolvimento Militar", "Tr√≠ceps Testa"] },
                { nome: "B (Lower - Agachamento)", exs: ["Agachamento Livre", "Agachamento Pausado", "Extensora Unilateral", "Abdominal Roda"] },
                { nome: "C (Upper - Puxada)", exs: ["Remada Curvada", "Barra Fixa (Carga)", "Remada Unilateral", "Rosca Martelo Pesada"] },
                { nome: "D (Lower - Terra)", exs: ["Levantamento Terra", "Stiff", "Leg Press Pesado", "Prancha com Peso"] }
            ]
        },
        "5": {
            "hipertrofia": [
                { nome: "A (Peito)", exs: ["Supino Reto", "Supino Inclinado", "Crucifixo", "Crossover", "Tr√≠ceps Corda"] },
                { nome: "B (Costas)", exs: ["Puxada Alta", "Remada Curvada", "Remada Serrote", "Pulldown", "Rosca Direta"] },
                { nome: "C (Pernas)", exs: ["Agachamento", "Leg Press", "Extensora", "Flexora", "Panturrilha"] },
                { nome: "D (Ombros)", exs: ["Desenvolvimento", "Eleva√ß√£o Lateral", "Eleva√ß√£o Frontal", "Encolhimento", "Face Pull"] },
                { nome: "E (Bra√ßos)", exs: ["Rosca Direta", "Tr√≠ceps Testa", "Rosca Scott", "Tr√≠ceps Franc√™s", "Rosca Punho"] }
            ]
        }
      };

      const STORAGE = Object.freeze({
        draftKey: "titanpro_draft_v4", // v4 pois a estrutura mudou
        historyKey: "titanpro_history_v4",
        csvTplKey: "titanpro_csv_templates_v1",
        maxHistory: 80,
        maxTemplates: 20
      });

      const divisoesGen = {
        "2": ["A", "B"], "3": ["A", "B", "C"], "4": ["A", "B", "C", "D"], "5": ["A", "B", "C", "D", "E"], "6": ["A", "B", "C", "D", "E", "F"]
      };

      const biblioteca = {
        "Peito": ["Supino Inclinado", "Supino Reto", "Crossover", "Voador", "Flex√£o", "Supino Halter"],
        "Costas": ["Puxada Alta", "Remada Curvada", "Remada Baixa", "Levantamento Terra", "Pulldown", "Barra Fixa"],
        "Pernas": ["Agachamento Livre", "Leg Press 45", "Extensora", "Mesa Flexora", "Stiff", "Passada", "Panturrilha"],
        "Ombros": ["Desenvolvimento", "Eleva√ß√£o Lateral", "Crucifixo Inverso", "Encolhimento", "Face Pull"],
        "Bra√ßos": ["Rosca Direta", "Tr√≠ceps Corda", "Rosca Martelo", "Tr√≠ceps Testa", "Rosca Scott", "Tr√≠ceps Franc√™s"]
      };

      /* =========================================
         2. CORE: TIMER & UI
         ========================================= */
      function openConfig() { document.getElementById("setupPanel").style.display = "block"; }
      function closeConfig() { document.getElementById("setupPanel").style.display = "none"; }

      let timeLeft = 60, baseTime = 60, timerInt = null, isRunning = false;
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playBeep() {
        try {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.connect(gain); gain.connect(audioCtx.destination);
          osc.frequency.value = 880; gain.gain.value = 0.1;
          osc.start(); osc.stop(audioCtx.currentTime + 0.4);
        } catch (_) {}
      }

      function setT(s, btn) {
        if (isRunning) return;
        timeLeft = baseTime = s; updateT();
        document.querySelectorAll(".btn-t").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      }
      function updateT() {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        document.getElementById("timerDisplay").innerText = `${m}:${s < 10 ? "0" : ""}${s}`;
      }
      function toggleT() {
        if (audioCtx.state === "suspended") { try { audioCtx.resume(); } catch (_) {} }
        const btn = document.getElementById("ctrlBtn");
        if (isRunning) {
          clearInterval(timerInt); isRunning = false;
          btn.innerText = "CONTINUAR"; btn.style.background = "var(--green)";
        } else {
          isRunning = true; btn.innerText = "PAUSAR"; btn.style.background = "var(--orange)";
          timerInt = setInterval(() => {
            if (timeLeft > 0) { timeLeft--; updateT(); }
            else {
              clearInterval(timerInt); isRunning = false;
              playBeep(); setTimeout(playBeep, 600);
              btn.innerText = "INICIAR"; btn.style.background = "var(--green)";
              timeLeft = baseTime; updateT();
            }
          }, 1000);
        }
      }
      function resetT() {
        clearInterval(timerInt); isRunning = false;
        timeLeft = baseTime; updateT();
        document.getElementById("ctrlBtn").innerText = "INICIAR";
        document.getElementById("ctrlBtn").style.background = "var(--green)";
      }

      /* =========================================
         3. GERA√á√ÉO DE PROTOCOLO (Smart Periodization)
         ========================================= */
      let currentExId = null;
      let isAddingNew = false;

      function gerarProtocolo() {
        const f = document.getElementById("freq").value; // ex: "3"
        const obj = document.getElementById("obj").value; // ex: "forca"
        
        const nav = document.getElementById("nav");
        const cont = document.getElementById("container");
        nav.innerHTML = ""; cont.innerHTML = "";

        // Tenta buscar o treino espec√≠fico: Frequ√™ncia -> Objetivo
        let preset = TREINOS_PRONTOS[f]?.[obj];

        // Se n√£o houver espec√≠fico (ex: for√ßa 6 dias), tenta o fallback para hipertrofia
        if (!preset && TREINOS_PRONTOS[f]?.["hipertrofia"]) {
            preset = TREINOS_PRONTOS[f]["hipertrofia"];
        }

        if (preset) {
           preset.forEach((treino, i) => {
             const labelCurto = treino.nome.split(" ")[0]; // "A", "B" etc
             nav.innerHTML += `<div class="pill ${i === 0 ? "active" : ""}" id="p${i}" onclick="tab(${i})">${labelCurto}</div>`;
             
             const sec = document.createElement("div");
             sec.id = `sec${i}`;
             sec.className = `section ${i === 0 ? "active" : ""}`;
             sec.setAttribute("data-treino-key", treino.nome);
             cont.appendChild(sec);

             treino.exs.forEach(exNome => {
               criarCard(exNome, sec.id); 
             });
           });
        } else {
           // Fallback Gen√©rico para quando n√£o houver config no JSON
           const divs = divisoesGen[f] || ["A","B"];
           divs.forEach((nome, i) => {
             nav.innerHTML += `<div class="pill ${i === 0 ? "active" : ""}" id="p${i}" onclick="tab(${i})">Treino ${nome}</div>`;
             const sec = document.createElement("div");
             sec.id = `sec${i}`;
             sec.className = `section ${i === 0 ? "active" : ""}`;
             sec.setAttribute("data-treino-key", `Treino ${nome}`);
             cont.appendChild(sec);
             criarCard("Exerc√≠cio Livre", sec.id);
           });
        }
        addPillControls();
        scheduleDraftSave();
      }

      function criarCard(nome, sectionId, series = null, reps = null, rpe = null, values = null) {
        const o = document.getElementById("obj").value;
        // L√≥gica de Sets/Reps baseada no objetivo
        const meta = reps || (o === "forca" ? "3-5 Reps" : (o === "hipertrofia" ? "6-15 Reps" : "15-20+ Reps"));
        const sets = series || (o === "forca" ? 3 : (o === "resistencia" ? 3 : 4));
        const id = "ex-" + Math.random().toString(36).substr(2, 7);

        const card = document.createElement("div");
        card.className = "exercise-card";
        card.setAttribute("data-ex-id", id);
        card.setAttribute("data-ex-name", nome);
        card.setAttribute("data-ex-sets", String(sets));
        card.setAttribute("data-ex-meta", meta);

        const rows = Array.from({ length: sets }, (_, s) => {
          const kgVal = values && values[s] ? (values[s].kg ?? "") : "";
          const repsVal = values && values[s] ? (values[s].reps ?? "") : "";
          const rpeVal = values && values[s] ? (values[s].rpe ?? "") : "";
          
          return `
            <div class="series-grid">
              <span style="font-size:0.7rem; color:#718096; text-align:center;">S${s + 1}</span>
              <div class="input-box ${kgVal && repsVal ? 'filled' : ''}"><input type="number" inputmode="decimal" value="${escapeAttr(kgVal)}" oninput="updateSuggests('${id}')"></div>
              <div class="input-box ${kgVal && repsVal ? 'filled' : ''}"><input type="number" inputmode="decimal" value="${escapeAttr(repsVal)}" oninput="updateSuggests('${id}')"></div>
              <div class="input-box"><input type="number" inputmode="decimal" placeholder="RPE" value="${escapeAttr(rpeVal)}" oninput="updateSuggests('${id}')" style="color:var(--orange)"></div>
            </div>`;
        }).join("");

        card.innerHTML = `
          <span class="remove-ex" onclick="this.parentElement.remove(); scheduleDraftSave();">√ó</span>
          <span class="ex-title" id="${id}" onclick="abrirLibParaTrocar('${id}')">${nome}</span>
          <span class="ex-target">${sets} Sets x ${meta}</span>
          <span class="rpe-suggest">1RM Est: <span id="1rm-${id}">-</span> | <span id="rpe-${id}">-</span></span>
          <div class="series-grid header-grid"><span>SET</span><span>KG</span><span>REPS</span><span>RPE (0-10)</span></div>
          ${rows}
        `;

        document.getElementById(sectionId).appendChild(card);
        attachAutosaveToCard(card);
        setTimeout(() => updateSuggests(id), 0);
        scheduleDraftSave();
      }

      function updateSuggests(id) {
        const card = document.querySelector(`[data-ex-id="${id}"]`);
        if(!card) return;
        const inputs = card.querySelectorAll("input");
        let maxKg = 0, maxReps = 0, maxRpe = 0;
        
        for(let i=0; i < inputs.length; i+=3) {
           const kgIn = inputs[i];
           const repIn = inputs[i+1];
           const rpeIn = inputs[i+2];

           const kg = parseFloat(kgIn.value) || 0;
           const reps = parseFloat(repIn.value) || 0;
           const rpe = parseFloat(rpeIn.value) || 0;
           
           if(kgIn.value && repIn.value) {
              kgIn.parentElement.classList.add("filled");
              repIn.parentElement.classList.add("filled");
              if(kg >= maxKg) { maxKg = kg; maxReps = reps; maxRpe = rpe; }
           } else {
              kgIn.parentElement.classList.remove("filled");
              repIn.parentElement.classList.remove("filled");
           }
        }

        const el1rm = document.getElementById(`1rm-${id}`);
        const elStatus = document.getElementById(`rpe-${id}`);

        if (maxKg && maxReps) {
            const epley1rm = maxKg * (1 + maxReps/30);
            if(el1rm) el1rm.textContent = Math.round(epley1rm) + "kg";
            if(elStatus) {
                if(maxRpe >= 9) elStatus.textContent = "üî• Falha";
                else if(maxRpe >= 7) elStatus.textContent = "‚úÖ Eficiente";
                else if(maxRpe > 0) elStatus.textContent = "‚ö†Ô∏è Leve";
                else elStatus.textContent = "Intensidade?";
                elStatus.style.color = maxRpe >= 7 ? "var(--green)" : "var(--orange)";
            }
        } else {
            if(el1rm) el1rm.textContent = "-";
            if(elStatus) elStatus.textContent = "-";
        }
      }

      /* =========================================
         4. IMPORTA√á√ÉO (PDF & CSV)
         ========================================= */
      async function extrairTextoPDF(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const btnLabel = input.parentElement;
        btnLabel.innerText = "Lendo...";
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
          let fullText = "TREINO,EXERC√çCIO,S√âRIES,REPS\n"; 
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(" ");
            const linhas = pageText.split(/ {2,}|\n/).filter(l => l.trim().length > 3);
            linhas.forEach(linha => {
               if(/[a-zA-Z]/.test(linha)) { fullText += `Treino A,${linha.trim().replace(/,/g, "")},4,8-12\n`; }
            });
          }
          document.getElementById("csvTextarea").value = fullText;
          alert("‚úÖ Texto extra√≠do! Ajuste o CSV e clique em IMPORTAR.");
        } catch (err) { alert("‚ùå Erro ao ler PDF."); } finally {
          btnLabel.innerHTML = `üìÑ LER PDF <input type="file" id="pdfUpload" accept=".pdf" style="display:none" onchange="extrairTextoPDF(this)">`;
          input.value = "";
        }
      }

      function importarCSVFromText(csvText, alsoSaveAsTemplate = false) {
        const csv = String(csvText || "").trim();
        if (!csv) { alert("‚ö†Ô∏è Cole o CSV!"); return false; }
        const linhas = csv.split(/\r?\n/).filter(l => l.trim());
        if (linhas.length < 2) return false;
        const delim = detectDelimiter(linhas[0]);
        const header = splitCSVLine(linhas[0], delim).map(h => h.trim().toUpperCase());
        
        // Mapeamento b√°sico
        const idxTreino = header.indexOf("TREINO");
        const idxEx = header.indexOf("EXERC√çCIO") >= 0 ? header.indexOf("EXERC√çCIO") : header.indexOf("EXERCICIO");
        const idxSeries = header.indexOf("S√âRIES") >= 0 ? header.indexOf("S√âRIES") : header.indexOf("SERIES");
        const idxReps = header.indexOf("REPS");
        
        if (idxTreino < 0 || idxEx < 0) { alert("‚ö†Ô∏è CSV inv√°lido. Requer colunas TREINO e EXERC√çCIO."); return false; }

        const grouped = {};
        const orderOfAppearance = [];

        for (let i = 1; i < linhas.length; i++) {
          const cols = splitCSVLine(linhas[i], delim);
          const treinoKey = normalizeTreinoKey(cols[idxTreino]);
          if (!treinoKey) continue;
          const exercicio = (cols[idxEx] || "").trim();
          if (!exercicio) continue;
          const series = parseInt(String(cols[idxSeries]||"").replace(/\D/g, ""), 10) || 4;
          const reps = idxReps >= 0 ? (cols[idxReps] || "").trim() : "8-12";

          if (!grouped[treinoKey]) { grouped[treinoKey] = []; orderOfAppearance.push(treinoKey); }
          grouped[treinoKey].push({ exercicio, series, reps });
        }

        buildTabsFromGrouped(grouped, orderOfAppearance);
        scheduleDraftSave();
        if (alsoSaveAsTemplate) trySaveTemplate(csv);
        return true;
      }

      function importarCSV() {
        if (importarCSVFromText(document.getElementById("csvTextarea").value, false)) {
          document.getElementById("modalCSV").close();
          alert("‚úÖ Treino importado!");
        }
      }

      /* =========================================
         5. FUN√á√ïES AUXILIARES
         ========================================= */
      function escapeAttr(v) { return String(v ?? "").replace(/&/g, "&amp;").replace(/"/g, "&quot;"); }
      function escapeHTML(s) { return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
      
      function attachAutosaveToCard(card) {
        card.querySelectorAll("input").forEach(inp => {
          inp.addEventListener("input", scheduleDraftSave, { passive: true });
        });
      }

      function abrirLibParaNovo() { isAddingNew = true; document.getElementById("libHeader").innerText = "Adicionar Exerc√≠cio"; mostrarLib(); }
      function abrirLibParaTrocar(id) { isAddingNew = false; currentExId = id; document.getElementById("libHeader").innerText = "Trocar Exerc√≠cio"; mostrarLib(); }
      
      function mostrarLib() {
        const lib = document.getElementById("libContent");
        lib.innerHTML = "";
        for (let cat in biblioteca) {
          lib.innerHTML += `<div style="color:var(--blue); font-weight:bold; margin:15px 0 5px; border-bottom:1px solid #2d3748">${cat}</div>`;
          biblioteca[cat].forEach(ex => { lib.innerHTML += `<div class="lib-item" onclick="selecionar('${ex}')">${ex}</div>`; });
        }
        document.getElementById("modalLib").showModal();
      }
      function selecionar(n) {
        if (isAddingNew) { const active = document.querySelector(".section.active"); if (active) criarCard(n, active.id); } 
        else { const el = document.getElementById(currentExId); if (el) { el.innerText = n; el.closest(".exercise-card").setAttribute("data-ex-name", n); scheduleDraftSave(); } }
        document.getElementById("modalLib").close();
      }
      function adicionarManual() { const val = document.getElementById("manualName").value; if (val) { selecionar(val); document.getElementById("manualName").value = ""; } }

      function tab(idx) {
        document.querySelectorAll(".section, .pill").forEach(el => el.classList.remove("active"));
        document.getElementById(`sec${idx}`).classList.add("active");
        document.getElementById(`p${idx}`).classList.add("active");
        scheduleDraftSave();
      }

      function abrirCSVModal() { document.getElementById("csvTextarea").value = ""; hideModelosCSV(); document.getElementById("modalCSV").showModal(); }
      function normalizeTreinoKey(raw) { return String(raw || "").trim().replace(/\s+/g, " ") || null; }
      function treinoLabel(key) { const k = String(key || "").trim(); const up = k.toUpperCase(); return (/^[A-F]$/.test(up) || up.startsWith("TREINO")) ? (up.startsWith("TREINO") ? k : `Treino ${k}`) : `Treino ${k}`; }
      
      function splitCSVLine(line, delim) {
        const out = []; let cur = ""; let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') { if (inQuotes && line[i+1] === '"') { cur += '"'; i++; } else { inQuotes = !inQuotes; } }
          else if (!inQuotes && ch === delim) { out.push(cur.trim()); cur = ""; } else { cur += ch; }
        }
        out.push(cur.trim()); return out;
      }
      function detectDelimiter(headerLine) {
        const cComma = (headerLine.match(/,/g)||[]).length, cSemi = (headerLine.match(/;/g)||[]).length, cTab = (headerLine.match(/\t/g)||[]).length;
        return (cTab >= cSemi && cTab >= cComma) ? "\t" : (cSemi >= cComma ? ";" : ",");
      }
      function buildTabsFromGrouped(grouped, order) {
        const nav = document.getElementById("nav"); const cont = document.getElementById("container");
        nav.innerHTML = ""; cont.innerHTML = "";
        order.slice(0, 6).forEach((key, idx) => {
          nav.innerHTML += `<div class="pill ${idx===0?"active":""}" id="p${idx}" onclick="tab(${idx})">${treinoLabel(key)}</div>`;
          const sec = document.createElement("div"); sec.id = `sec${idx}`; sec.className = `section ${idx===0?"active":""}`; sec.setAttribute("data-treino-key", key); cont.appendChild(sec);
          (grouped[key]||[]).forEach(ex => criarCard(ex.exercicio, sec.id, ex.series, ex.reps));
        });
        addPillControls();
      }

      /* ===== STATE & HISTORY ===== */
      let draftSaveTimer = null;
      function scheduleDraftSave() { if (draftSaveTimer) clearTimeout(draftSaveTimer); draftSaveTimer = setTimeout(() => { try { localStorage.setItem(STORAGE.draftKey, JSON.stringify(serializeCurrentState())); } catch {} }, 300); }
      function getActiveIdx() { const p = Array.from(document.querySelectorAll("#nav .pill:not(.add-pill)")); const a = p.find(x => x.classList.contains("active")); return p.indexOf(a) >= 0 ? p.indexOf(a) : 0; }
      
      function serializeCurrentState() {
        const freq = document.getElementById("freq").value;
        const obj = document.getElementById("obj").value;
        const pills = Array.from(document.querySelectorAll("#nav .pill:not(.add-pill)")).map((p,i) => ({ idx: i, label: p.textContent.replace("√ó","").trim() }));
        const sections = Array.from(document.querySelectorAll("#container .section")).map((sec, secIdx) => {
          const treinoKey = sec.getAttribute("data-treino-key") || pills[secIdx]?.label || `Treino ${secIdx+1}`;
          const cards = Array.from(sec.querySelectorAll(".exercise-card")).map(card => {
            const values = Array.from(card.querySelectorAll(".series-grid")).slice(1).map(r => {
               const i = r.querySelectorAll("input"); 
               return { kg: i[0].value, reps: i[1].value, rpe: i[2].value };
            });
            return { name: card.querySelector(".ex-title").textContent, sets: values.length, meta: card.querySelector(".ex-target").textContent, values };
          });
          return { treinoKey, cards };
        });
        return { v: 4, savedAt: new Date().toISOString(), freq, obj, activeIdx: getActiveIdx(), pills, sections };
      }

      function loadState(state) {
        if (!state || !Array.isArray(state.sections)) return false;
        try { if(state.freq) document.getElementById("freq").value = state.freq; if(state.obj) document.getElementById("obj").value = state.obj; } catch{}
        const nav = document.getElementById("nav"); const cont = document.getElementById("container");
        nav.innerHTML = ""; cont.innerHTML = "";
        state.sections.slice(0,6).forEach((secData, idx) => {
           const label = (state.pills && state.pills[idx]) ? state.pills[idx].label : secData.treinoKey;
           nav.innerHTML += `<div class="pill ${idx===0?"active":""}" id="p${idx}" onclick="tab(${idx})">${label}</div>`;
           const sec = document.createElement("div"); sec.id = `sec${idx}`; sec.className = `section ${idx===0?"active":""}`; sec.setAttribute("data-treino-key", secData.treinoKey); cont.appendChild(sec);
           (secData.cards||[]).forEach(c => criarCard(c.name, sec.id, c.sets, c.meta.split("Sets x")[1]?.trim(), null, c.values));
        });
        addPillControls(); tab(state.activeIdx||0);
        return true;
      }

      function salvarTreino() {
        try {
          const peso = prompt("Peso Corporal (kg)? (Opcional)");
          const st = serializeCurrentState();
          const item = { id: "sess_"+Date.now(), createdAt: new Date().toISOString(), state: st, bodyWeight: peso ? parseFloat(peso) : null };
          const hist = JSON.parse(localStorage.getItem(STORAGE.historyKey)||"[]");
          hist.unshift(item); if(hist.length>STORAGE.maxHistory) hist.length = STORAGE.maxHistory;
          localStorage.setItem(STORAGE.historyKey, JSON.stringify(hist));
          alert("‚úÖ Sess√£o Salva!");
        } catch { alert("‚ö†Ô∏è Mem√≥ria cheia."); }
      }

      function limparApenasValores() {
        if(!confirm("Isso apagar√° as cargas para iniciar nova semana. Confirmar?")) return;
        document.querySelectorAll(".input-box input").forEach(i => { i.value = ""; i.parentElement.classList.remove("filled"); });
        scheduleDraftSave();
        closeConfig();
      }

      function fazerBackup() {
        const dados = {
           draft: localStorage.getItem(STORAGE.draftKey),
           history: localStorage.getItem(STORAGE.historyKey),
           templates: localStorage.getItem(STORAGE.csvTplKey)
        };
        const blob = new Blob([JSON.stringify(dados)], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `titan_backup_${new Date().toISOString().slice(0,10)}.json`;
        a.click();
      }

      /* ===== ALERTS & CHARTS ===== */
      function calcVolumeTotal(state) {
        if(!state?.sections) return 0;
        return state.sections.reduce((acc, sec) => acc + sec.cards.reduce((acc2, c) => acc2 + c.values.reduce((acc3, v) => acc3 + ((parseFloat(v.kg)||0)*(parseFloat(v.reps)||0)), 0), 0), 0);
      }

      function showEvoChart() {
        const hist = JSON.parse(localStorage.getItem(STORAGE.historyKey)||"[]").reverse();
        if(!hist.length) { alert("Sem hist√≥rico."); return; }
        const data = hist.map(h => ({ d: new Date(h.createdAt).toLocaleDateString('pt-BR').slice(0,5), v: calcVolumeTotal(h.state) }));
        
        const dialog = document.createElement("dialog");
        dialog.style.cssText = "background:#161e2e; width:95%; max-width:600px; padding:15px; border:1px solid var(--blue); border-radius:12px;";
        const cvs = document.createElement("canvas");
        const btn = document.createElement("button");
        btn.innerText = "FECHAR"; btn.className="btn"; btn.style.cssText="background:var(--red); color:white; margin-top:10px; width:100%";
        btn.onclick = () => { dialog.close(); dialog.remove(); };
        dialog.appendChild(cvs); dialog.appendChild(btn); document.body.appendChild(dialog); dialog.showModal();

        new Chart(cvs, {
          type: 'line',
          data: { labels: data.map(x=>x.d), datasets: [{ label:'Volume Total (Kg)', data: data.map(x=>x.v), borderColor:'#38b2ac', backgroundColor:'rgba(56,178,172,0.2)', fill:true, tension:0.3 }] },
          options: { responsive:true, scales: { y:{beginAtZero:true, grid:{color:'#2d3748'}}, x:{grid:{color:'#2d3748'}} }, plugins:{legend:{labels:{color:'white'}}} }
        });
      }

      function verHistorico() {
        const list = document.getElementById("histList");
        const hist = JSON.parse(localStorage.getItem(STORAGE.historyKey)||"[]");
        list.innerHTML = hist.length ? "" : '<div class="hist-item">Sem sess√µes.</div>';
        hist.forEach(h => {
          const el = document.createElement("div"); el.className="hist-item";
          el.innerHTML = `<strong>${new Date(h.createdAt).toLocaleString('pt-BR')}</strong> ${h.bodyWeight?`| ${h.bodyWeight}kg BW`:""}<br><small>${calcVolumeTotal(h.state)}kg vol total</small>`;
          el.onclick = () => { if(confirm("Carregar sess√£o antiga?")) { loadState(h.state); scheduleDraftSave(); document.getElementById("modalHIST").close(); }};
          list.appendChild(el);
        });
        document.getElementById("modalHIST").showModal();
      }
      function limparHistorico() { if(confirm("Apagar tudo?")) { localStorage.removeItem(STORAGE.historyKey); verHistorico(); } }

      /* ===== PILL CONTROLS & ADD TREINO ===== */
      function adicionarTreino() {
        const st = serializeCurrentState();
        if(st.sections.length >= 7) { alert("M√°ximo atingido."); return; }
        const nome = prompt("Nome (ex: Treino F):"); if(!nome) return;
        st.sections.push({ treinoKey: normalizeTreinoKey(nome), cards: [] });
        st.pills.push({ idx: st.pills.length, label: treinoLabel(nome) });
        st.activeIdx = st.sections.length - 1; loadState(st); scheduleDraftSave();
      }
      function excluirTreinoPorIdx(idx) {
        if(!confirm("Excluir treino?")) return;
        const st = serializeCurrentState();
        if(st.sections.length <= 1) { alert("Mantenha 1 treino."); return; }
        st.sections.splice(idx, 1); st.pills.splice(idx, 1);
        st.activeIdx = 0; loadState(st); scheduleDraftSave();
      }
      function addPillControls() {
        const nav = document.getElementById("nav");
        nav.querySelectorAll(".pill-x, .add-pill").forEach(e => e.remove());
        nav.querySelectorAll(".pill").forEach((p, i) => {
          const x = document.createElement("span"); x.className="pill-x"; x.innerText="√ó";
          x.onclick = (e) => { e.stopPropagation(); excluirTreinoPorIdx(i); }; p.appendChild(x);
        });
        const add = document.createElement("div"); add.className="pill add-pill"; add.innerText="+"; add.onclick=adicionarTreino; nav.appendChild(add);
      }

      /* ===== TEMPLATES STORAGE ===== */
      function getCSVTemplates() { try{return JSON.parse(localStorage.getItem(STORAGE.csvTplKey))||[]}catch{return[]} }
      function trySaveTemplate(csv) {
        const n = prompt("Nome do Modelo:"); if(!n) return;
        const arr = getCSVTemplates(); arr.unshift({id:Date.now(), name:n, date:new Date(), csv});
        localStorage.setItem(STORAGE.csvTplKey, JSON.stringify(arr.slice(0,20))); alert("Salvo!");
      }
      function mostrarModelosCSV() {
        document.getElementById("tplArea").style.display="block";
        const l = document.getElementById("tplList"); const arr = getCSVTemplates();
        l.innerHTML = arr.length ? "" : "<div class='tpl-item'>Vazio.</div>";
        arr.forEach(t => {
          const d = document.createElement("div"); d.className="tpl-item";
          d.innerHTML = `<strong>${escapeHTML(t.name)}</strong><br><small>${new Date(t.date).toLocaleDateString()}</small>`;
          d.onclick = () => { if(confirm("Carregar?")) { importarCSVFromText(t.csv, false); document.getElementById("modalCSV").close(); }};
          d.oncontextmenu = (e) => { e.preventDefault(); if(confirm("Deletar?")) { localStorage.setItem(STORAGE.csvTplKey, JSON.stringify(arr.filter(x=>x.id!==t.id))); mostrarModelosCSV(); }};
          l.appendChild(d);
        });
      }
      function limparModelosCSV() { if(confirm("Apagar tudo?")) localStorage.removeItem(STORAGE.csvTplKey); mostrarModelosCSV(); }
      function hideModelosCSV() { document.getElementById("tplArea").style.display="none"; }
      function salvarModeloCSV() { const v = document.getElementById("csvTextarea").value; if(v) trySaveTemplate(v); else alert("Cole o CSV."); }

      /* ===== BOOT ===== */
      window.onload = () => {
        try { document.getElementById("displayDate").innerText = new Date().toLocaleDateString("pt-BR"); } catch{}
        let loaded = false;
        try { const r = localStorage.getItem(STORAGE.draftKey); if(r) loaded = loadState(JSON.parse(r)); } catch{}
        if(!loaded) gerarProtocolo();
        openConfig();
      };
    </script>
  </body>
</html>
