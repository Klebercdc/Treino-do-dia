<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Smart Log</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>

    <style>
      :root { --bg:#0b1220; --card:#161e2e; --blue:#3182ce; --text:#f7fafc; --orange:#f6ad55; --green:#38b2ac; --red:#e53e3e; }
      body { background:var(--bg); color:var(--text); font-family:-apple-system,sans-serif; margin:0; padding-bottom:20px; user-select: none; }

      .top-header { padding:15px; background:var(--card); border-bottom:1px solid #2d3748; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; }
      .brand { font-weight: 800; font-size: 1.1rem; color: var(--blue); }
      .brand span { color: #fff; }
      .date-badge { font-size:.8rem; color:var(--orange); font-weight:bold; background:#0b1220; padding:4px 10px; border-radius:15px; }

      .timer-area { background:#1a202c; padding:12px; border-bottom:2px solid var(--blue); text-align:center; }
      #timerDisplay { font-size:2.2rem; font-weight:800; color:var(--blue); font-family:monospace; margin-bottom:8px; }
      .timer-btns { display:flex; gap:6px; justify-content:center; margin-bottom:5px; }
      .btn-t { background:#2d3748; color:#fff; border:none; padding:8px 12px; border-radius:8px; font-size:.75rem; cursor:pointer; font-weight:bold; }
      .btn-t.active { background:var(--blue); }
      .btn-ctrl { background:var(--green); color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; font-size:.8rem; }

      .setup-panel { background:var(--card); padding:20px; border-bottom:3px solid var(--blue); }
      .field { margin-bottom:15px; }
      .field label { font-size:.7rem; color:#a0aec0; display:block; margin-bottom:5px; font-weight:bold; text-transform:uppercase; }
      .field select { width:100%; padding:12px; background:#0b1220; color:#fff; border:1px solid var(--blue); border-radius:8px; font-weight:bold; }

      .nav-pills { display:flex; gap:8px; padding:10px; background:var(--bg); overflow-x:auto; border-bottom:1px solid #2d3748; }
      .pill { flex:none; padding:12px 20px; border-radius:8px; background:#1a202c; font-weight:bold; font-size:.75rem; border:1px solid #2d3748; cursor:pointer; color:#a0aec0; -webkit-touch-callout: none; }
      .pill.active { background:var(--blue); border-color:var(--blue); color:#fff; }

      .section { display:none; }
      .section.active { display:block; }
      .exercise-card { background:var(--card); border-radius:12px; padding:15px; margin:10px; border:1px solid #2d3748; position:relative; }
      .ex-title { font-weight:800; font-size:1.1rem; color:var(--blue); text-decoration:underline dotted; cursor:pointer; }
      .remove-ex { position:absolute; top:10px; right:10px; color:var(--red); font-size:1.2rem; cursor:pointer; font-weight:bold; }

      .series-grid { display:grid; grid-template-columns:40px 1fr 1fr 1fr; gap:8px; align-items:center; margin-bottom:8px; }
      .input-box { background:#0b1220; border:1px solid #2d3748; border-radius:6px; padding:8px 0; }
      .input-box input { background:transparent; border:none; color:#fff; width:100%; text-align:center; font-size:1.1rem; outline:none; font-weight:bold; }

      .footer-actions { padding:20px 10px 40px; display:flex; gap:12px; flex-wrap:wrap; }
      .btn { padding:15px; border-radius:10px; border:none; font-weight:800; cursor:pointer; flex:1; font-size:.75rem; text-transform:uppercase; }
      .btn-save { background:var(--green); color:#fff; flex:2; }
      .btn-config { background:#2d3748; color:var(--blue); border:1px solid var(--blue); }

      dialog { background:#161e2e; color:#fff; border:1px solid var(--blue); border-radius:12px; width:95%; max-width: 500px; padding:20px; box-sizing: border-box; }
      textarea { width:100%; height:150px; background:#0b1220; color:#fff; border:1px solid var(--blue); border-radius:8px; padding:10px; margin-top:10px; font-family: monospace; resize: none; box-sizing: border-box; }
      .tpl-item { padding:10px; border-bottom:1px solid #2d3748; cursor:pointer; font-size: 0.8rem; }
    </style>
  </head>

  <body>
    <div class="top-header">
      <div class="brand">TITAN <span>PRO</span></div>
      <div id="displayDate" class="date-badge">--/--/--</div>
    </div>

    <div class="timer-area">
      <div id="timerDisplay">01:00</div>
      <div class="timer-btns">
        <button class="btn-t active" onclick="setT(60, this)">1m</button>
        <button class="btn-t" onclick="setT(120, this)">2m</button>
        <button class="btn-t" onclick="setT(180, this)">3m</button>
      </div>
      <div class="timer-btns" style="margin-top:10px">
        <button id="ctrlBtn" class="btn-ctrl" onclick="toggleT()">INICIAR</button>
        <button class="btn-ctrl" style="background:var(--red)" onclick="resetT()">ZERAR</button>
      </div>
    </div>

    <div class="setup-panel" id="setupPanel">
      <div class="field">
        <label>Protocolos Pr√©-Instalados</label>
        <select id="freq" onchange="gerarProtocoloPreset()">
          <option value="none">Selecione um treino...</option>
          <option value="2">Full Body (2 Dias)</option>
          <option value="3">ABC Push/Pull/Legs (3 Dias)</option>
          <option value="4">Upper/Lower (4 Dias)</option>
          <option value="5">ABCDE Isolado (5 Dias)</option>
        </select>
      </div>
      <button class="btn btn-config" onclick="limparValores()" style="width:100%; color:var(--red); margin-bottom:10px;">‚ôªÔ∏è ZERAR CARGAS</button>
      <button class="btn btn-save" onclick="document.getElementById('setupPanel').style.display='none'" style="width:100%">FECHAR</button>
    </div>

    <div class="nav-pills" id="nav"></div>
    <main id="container"></main>

    <div class="footer-actions">
      <button class="btn btn-config" onclick="document.getElementById('setupPanel').style.display='block'">‚öôÔ∏è CONFIG</button>
      <button class="btn btn-config" onclick="abrirCSVModal()" style="background:var(--orange); color:white;">üìä ARQUIVOS</button>
      <button class="btn btn-save" onclick="salvarEstado()">SALVAR SESS√ÉO</button>
    </div>

    <dialog id="modalCSV">
      <h3 style="margin:0; color:var(--orange)">Arquivos & Modelos</h3>
      <textarea id="csvTextarea" placeholder="Cole CSV ou extraia do PDF..."></textarea>
      <div style="display:flex; gap:8px; margin-top:10px; flex-wrap: wrap;">
        <label class="btn-config" style="flex:1; display:flex; align-items:center; justify-content:center; cursor:pointer; padding:10px">
          üìÑ PDF <input type="file" accept=".pdf" style="display:none" onchange="extrairTextoPDF(this)">
        </label>
        <button class="btn-save" onclick="importarCSV()" style="flex:1">IMPORTAR</button>
        <button class="btn-config" onclick="salvarComoModelo()" style="flex:1; background: var(--green); color: white; border: none;">üíæ SALVAR MOD</button>
      </div>
      <div id="tplList" style="margin-top:15px; border-top: 1px solid #2d3748; max-height: 150px; overflow-y: auto;">
        <p style="font-size: 0.7rem; color: var(--orange); margin: 10px 0;">MEUS MODELOS SALVOS:</p>
      </div>
      <button class="btn" onclick="document.getElementById('modalCSV').close()" style="width:100%; margin-top:10px; background:#2d3748; color:white;">FECHAR</button>
    </dialog>

    <script>
      const PRESETS = {
        "2": [["Agachamento", "Supino", "Remada Curvada", "Desenvolvimento"], ["Terra", "Leg Press", "Puxada Alta", "Paralelas"]],
        "3": [["Supino", "Inclinado", "Eleva√ß√£o Lateral", "Tr√≠ceps"], ["Puxada", "Remada Curvada", "Rosca Direta", "Facepull"], ["Agachamento", "Leg Press", "Flexora", "Panturrilha"]],
        "4": [["Supino", "Remada"], ["Agachamento", "Flexora"], ["Inclinado", "Puxada"], ["Leg Press", "Stiff"]],
        "5": [["Peito"], ["Costas"], ["Pernas"], ["Ombros"], ["Bra√ßos"]]
      };

      let timeLeft = 60, baseTime = 60, timerInt = null, isRunning = false;
      let pressTimer;

      // TIMER
      function setT(s, btn) { timeLeft = baseTime = s; updateT(); document.querySelectorAll(".btn-t").forEach(b => b.classList.remove("active")); btn.classList.add("active"); }
      function updateT() { const m = Math.floor(timeLeft/60); const s = timeLeft%60; document.getElementById("timerDisplay").innerText = `${m}:${s<10?'0':''}${s}`; }
      function toggleT() {
        const btn = document.getElementById("ctrlBtn");
        if (isRunning) { clearInterval(timerInt); isRunning = false; btn.innerText = "INICIAR"; }
        else { isRunning = true; btn.innerText = "PAUSAR"; timerInt = setInterval(() => { if(timeLeft > 0) { timeLeft--; updateT(); } else { clearInterval(timerInt); isRunning = false; btn.innerText = "FIM"; } }, 1000); }
      }
      function resetT() { clearInterval(timerInt); isRunning = false; timeLeft = baseTime; updateT(); document.getElementById("ctrlBtn").innerText = "INICIAR"; }

      // LONG PRESS PARA APAGAR
      function attachDelete(el, idx) {
        const start = () => pressTimer = setTimeout(() => { if(confirm("Apagar este treino?")){ el.remove(); document.getElementById('sec'+idx)?.remove(); salvarEstado(); } }, 800);
        const cancel = () => clearTimeout(pressTimer);
        el.onmousedown = start; el.ontouchstart = start; el.onmouseup = cancel; el.ontouchend = cancel;
      }

      function criarCard(nome, sectionId, values = null) {
        const card = document.createElement("div");
        card.className = "exercise-card";
        card.innerHTML = `
          <span class="remove-ex" onclick="this.parentElement.remove(); salvarEstado();">√ó</span>
          <div class="ex-title">${nome}</div>
          <div class="series-grid" style="margin-top:10px">${[1,2,3,4].map((s)=>`
            <div class="input-box"><input type="number" placeholder="kg" value="${values?.[s-1]?.kg || ''}" oninput="salvarEstado()"></div>
          `).join('')}</div>
        `;
        document.getElementById(sectionId).appendChild(card);
      }

      function tab(idx) {
        document.querySelectorAll(".section, .pill").forEach(el => el.classList.remove("active"));
        if(document.getElementById("sec"+idx)) document.getElementById("sec"+idx).classList.add("active");
        if(document.querySelectorAll(".pill")[idx]) document.querySelectorAll(".pill")[idx].classList.add("active");
      }

      // PRESETS E MODELOS
      function gerarProtocoloPreset() {
        const val = document.getElementById("freq").value;
        if(val === "none") return;
        if(!confirm("Isso apagar√° o treino atual. Continuar?")) return;
        
        const treinos = PRESETS[val];
        const nav = document.getElementById("nav");
        const cont = document.getElementById("container");
        nav.innerHTML = ""; cont.innerHTML = "";

        treinos.forEach((exs, i) => {
          const letras = ["A","B","C","D","E"];
          addTab("Treino "+letras[i], exs.map(e => ({nome: e})));
        });
        document.getElementById("setupPanel").style.display = "none";
        salvarEstado();
      }

      function addTab(nome, exs) {
        const idx = document.querySelectorAll(".pill").length;
        const p = document.createElement("div");
        p.className = `pill ${idx===0?'active':''}`;
        p.innerText = nome;
        p.onclick = () => tab(idx);
        attachDelete(p, idx);
        document.getElementById("nav").appendChild(p);

        const sec = document.createElement("div");
        sec.id = "sec"+idx;
        sec.className = `section ${idx===0?'active':''}`;
        document.getElementById("container").appendChild(sec);
        exs.forEach(ex => criarCard(ex.nome, sec.id, ex.values));
      }

      // SALVAR / CARREGAR
      function salvarEstado() {
        const treinos = Array.from(document.querySelectorAll(".section")).map((sec, i) => ({
          nome: document.querySelectorAll(".pill")[i].innerText,
          exs: Array.from(sec.querySelectorAll(".exercise-card")).map(c => ({
            nome: c.querySelector(".ex-title").innerText,
            values: Array.from(c.querySelectorAll("input")).map(input => ({ kg: input.value }))
          }))
        }));
        localStorage.setItem("TITAN_STATE", JSON.stringify(treinos));
      }

      function carregarEstado() {
        const raw = localStorage.getItem("TITAN_STATE");
        if(raw) {
          const data = JSON.parse(raw);
          data.forEach(t => addTab(t.nome, t.exs));
        }
      }

      // CSV / PDF / MODELOS CUSTOM
      function salvarComoModelo() {
        const nome = prompt("Nome do modelo:");
        if(!nome) return;
        const treinos = localStorage.getItem("TITAN_STATE");
        const mods = JSON.parse(localStorage.getItem("TITAN_MODS") || "{}");
        mods[nome] = treinos;
        localStorage.setItem("TITAN_MODS", JSON.stringify(mods));
        renderTemplates();
      }

      function renderTemplates() {
        const list = document.getElementById("tplList");
        list.innerHTML = '<p style="font-size: 0.7rem; color: var(--orange); margin: 10px 0;">MEUS MODELOS SALVOS:</p>';
        const mods = JSON.parse(localStorage.getItem("TITAN_MODS") || "{}");
        for(let m in mods) {
          const div = document.createElement("div");
          div.className = "tpl-item";
          div.innerHTML = `<span>${m}</span> <span style="color:var(--red); float:right;" onclick="deleteMod('${m}')">Apagar</span>`;
          div.querySelector("span").onclick = () => {
            if(confirm("Carregar modelo "+m+"?")) {
              localStorage.setItem("TITAN_STATE", mods[m]);
              location.reload();
            }
          };
          list.appendChild(div);
        }
      }

      function deleteMod(m) { 
        const mods = JSON.parse(localStorage.getItem("TITAN_MODS") || "{}");
        delete mods[m];
        localStorage.setItem("TITAN_MODS", JSON.stringify(mods));
        renderTemplates();
      }

      async function extrairTextoPDF(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = async function() {
          const typedarray = new Uint8Array(this.result);
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          let text = "";
          for(let i=1; i<=pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(s => s.str).join(" ") + "\n";
          }
          document.getElementById("csvTextarea").value = text;
        };
        reader.readAsArrayBuffer(file);
      }

      function importarCSV() {
        const texto = document.getElementById("csvTextarea").value.trim();
        if(!texto) return;
        const linhas = texto.split("\n").filter(l => l.length > 3);
        addTab("Importado", linhas.map(l => ({nome: l.substring(0,25)})));
        document.getElementById("modalCSV").close();
        salvarEstado();
      }

      function limparValores() {
        if(confirm("Zerar todas as cargas?")) {
          document.querySelectorAll("input").forEach(i => i.value = "");
          salvarEstado();
        }
      }

      function abrirCSVModal() { renderTemplates(); document.getElementById("modalCSV").showModal(); }

      window.onload = () => {
        carregarEstado();
        document.getElementById("displayDate").innerText = new Date().toLocaleDateString('pt-BR');
      };
    </script>
  </body>
</html>
