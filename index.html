<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>TITAN PRO v3.1 - Zero Bug Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --bg: #0b1220; --card: #161e2e; --blue: #3182ce; --text: #f7fafc; 
            --orange: #f6ad55; --green: #38b2ac; --red: #e53e3e; --border: #2d3748;
        }
        body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system; margin: 0; padding-bottom: 80px; overflow-x: hidden; }
        
        /* Sticky Header */
        .header-system { position: sticky; top: 0; z-index: 1000; background: var(--bg); border-bottom: 1px solid var(--border); }
        .pill-nav { display: flex; gap: 10px; padding: 15px; overflow-x: auto; scrollbar-width: none; }
        .pill-nav::-webkit-scrollbar { display: none; }
        
        .pill { 
            padding: 8px 20px; background: var(--card); border: 1px solid var(--border);
            border-radius: 20px; white-space: nowrap; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: 0.2s;
        }
        .pill.active { background: var(--blue); border-color: var(--blue); color: white; box-shadow: 0 0 15px rgba(49,130,206,0.4); }

        /* Card System */
        .exercise-card { 
            background: var(--card); border-radius: 12px; padding: 16px; 
            margin: 12px; border: 1px solid var(--border);
        }
        .metrics-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;
        }
        .metric-box { background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; text-align: center; }
        .metric-label { font-size: 0.6rem; color: #718096; display: block; text-transform: uppercase; }
        .metric-value { font-size: 0.9rem; font-family: monospace; color: var(--green); font-weight: bold; }

        .series-row { 
            display: grid; grid-template-columns: 30px 1fr 1fr 1fr; 
            gap: 8px; align-items: center; margin-bottom: 8px; 
        }
        .input-box { 
            background: #0b1220; border: 1px solid var(--border); 
            border-radius: 6px; padding: 8px 4px;
        }
        .input-box input { 
            background: transparent; border: none; color: #fff; width: 100%; 
            text-align: center; font-size: 1rem; outline: none;
        }

        .footer { 
            position: fixed; bottom: 0; width: 100%; display: grid; 
            grid-template-columns: 1fr 2fr; background: var(--card); border-top: 1px solid var(--border); 
        }
        .btn { padding: 18px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; }
        .btn-save { background: var(--green); color: white; }
        .btn-secondary { background: var(--card); color: var(--blue); border-right: 1px solid var(--border); }
    </style>
</head>
<body>

<div class="header-system">
    <div class="pill-nav" id="navContainer"></div>
</div>

<main id="appContainer"></main>

<div class="footer">
    <button class="btn btn-secondary" onclick="engine.exportCSV()">Exportar CSV</button>
    <button class="btn btn-save" onclick="engine.saveSession()">Salvar Sessão e Sair</button>
</div>

<script>
/**
 * TITAN CORE v3.1 - RESILIENT ARCHITECTURE
 */
const engine = (() => {
    // Configurações de Persistência
    const DB_KEYS = { HISTORY: 'titan_v3_hist', DRAFT: 'titan_v3_draft' };

    let state = {
        activeIdx: 0,
        sections: JSON.parse(localStorage.getItem(DB_KEYS.DRAFT)) || []
    };

    // Utilitários de Cálculo com Sanitização (Previne NaN)
    const compute = {
        oneRM: (w, r) => {
            const weight = parseFloat(w) || 0;
            const reps = parseFloat(r) || 0;
            return reps === 0 ? 0 : weight * (1 + (reps / 30));
        },
        volume: (values) => values.reduce((acc, v) => acc + ((parseFloat(v.kg) || 0) * (parseFloat(v.reps) || 0)), 0)
    };

    const saveToLocalStorage = () => {
        localStorage.setItem(DB_KEYS.DRAFT, JSON.stringify(state.sections));
    };

    const render = () => {
        const nav = document.getElementById('navContainer');
        const app = document.getElementById('appContainer');
        nav.innerHTML = '';
        app.innerHTML = '';

        if (state.sections.length === 0) {
            app.innerHTML = '<div style="padding:40px; text-align:center; color:var(--orange);">Nenhum treino carregado. Importe um CSV.</div>';
            return;
        }

        state.sections.forEach((sec, sIdx) => {
            // Pill Navigation
            const pill = document.createElement('div');
            pill.className = `pill ${sIdx === state.activeIdx ? 'active' : ''}`;
            pill.innerText = sec.treinoKey;
            pill.onclick = () => { state.activeIdx = sIdx; render(); };
            nav.appendChild(pill);

            // Active Section Content
            if (sIdx === state.activeIdx) {
                sec.cards.forEach((ex, exIdx) => {
                    const vol = compute.volume(ex.values);
                    const firstRM = compute.oneRM(ex.values[0]?.kg, ex.values[0]?.reps);

                    const card = document.createElement('div');
                    card.className = 'exercise-card';
                    card.innerHTML = `
                        <div style="margin-bottom:12px;">
                            <h3 style="margin:0 0 4px 0; color:var(--blue); font-size:1.1rem;">${ex.name}</h3>
                            <span style="font-size:0.7rem; color:var(--orange); font-weight:bold;">META: ${ex.meta}</span>
                        </div>
                        
                        <div class="metrics-grid">
                            <div class="metric-box">
                                <span class="metric-label">Volume Total</span>
                                <span class="metric-value">${vol.toLocaleString()} kg</span>
                            </div>
                            <div class="metric-box">
                                <span class="metric-label">Est. 1RM (S1)</span>
                                <span class="metric-value">${firstRM.toFixed(1)} kg</span>
                            </div>
                        </div>

                        <div class="series-row" style="color:#4a5568; font-size:0.6rem; font-weight:bold; text-align:center;">
                            <span>#</span><span>KG</span><span>REPS</span><span>RPE</span>
                        </div>

                        ${ex.values.map((v, vIdx) => `
                            <div class="series-row">
                                <span style="font-size:0.7rem; color:#718096; text-align:center;">${vIdx + 1}</span>
                                <div class="input-box"><input type="number" inputmode="decimal" placeholder="0" value="${v.kg}" oninput="engine.updateData(${exIdx}, ${vIdx}, 'kg', this.value)"></div>
                                <div class="input-box"><input type="number" inputmode="numeric" placeholder="0" value="${v.reps}" oninput="engine.updateData(${exIdx}, ${vIdx}, 'reps', this.value)"></div>
                                <div class="input-box"><input type="number" inputmode="numeric" placeholder="0" value="${v.rpe}" oninput="engine.updateData(${exIdx}, ${vIdx}, 'rpe', this.value)"></div>
                            </div>
                        `).join('')}
                    `;
                    app.appendChild(card);
                });
            }
        });
    };

    return {
        updateData: (exIdx, vIdx, field, val) => {
            // Sanitização de input em tempo real
            state.sections[state.activeIdx].cards[exIdx].values[vIdx][field] = val;
            saveToLocalStorage();
            // Debounce implícito para performance: não renderizamos tudo no oninput, 
            // apenas no onblur ou se preferir feedback visual imediato, mantenha como está.
        },
        saveSession: () => {
            const history = JSON.parse(localStorage.getItem(DB_KEYS.HISTORY) || '[]');
            const entry = {
                date: new Date().toISOString(),
                payload: JSON.parse(JSON.stringify(state.sections)) // Deep copy
            };
            history.push(entry);
            localStorage.setItem(DB_KEYS.HISTORY, JSON.stringify(history));
            alert("Protocolo Titan Finalizado. Dados sincronizados.");
        },
        init: (data) => {
            if (data) state.sections = data;
            render();
        },
        exportCSV: () => {
            console.table(state.sections[state.activeIdx].cards);
            alert("Log técnico impresso no console (F12).");
        }
    };
})();

// Inicialização com Fallback
const defaultData = [
    {
        treinoKey: "A: Empurrar",
        cards: [
            { name: "Supino Reto", meta: "3x6-8", values: Array(3).fill().map(() => ({kg:'', reps:'', rpe:''})) },
            { name: "Desenvolvimento", meta: "3x10", values: Array(3).fill().map(() => ({kg:'', reps:'', rpe:''})) }
        ]
    }
];

engine.init(JSON.parse(localStorage.getItem('titan_v3_draft')) || defaultData);
</script>
</body>
</html>
