<!doctype html>
<html lang="pt-PT">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Smart Log</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>
    <link rel="icon" href="Logo.png" type="image/png" />
    <style>
        :root { --bg: #0b1220; --card: #161e2e; --blue: #3182ce; --text: #f7fafc; --orange: #f6ad55; --green: #38b2ac; --red: #e53e3e; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; user-select: none; -webkit-tap-highlight-color: transparent; }
        .top-header { padding: 15px; background: var(--card); border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .date-badge { font-size: 0.8rem; color: var(--orange); font-weight: bold; background: #0b1220; padding: 4px 10px; border-radius: 15px; }
        .setup-panel { background: var(--card); padding: 20px; border-bottom: 3px solid var(--blue); }
        .field { margin-bottom: 15px; }
        .field label { font-size: 0.7rem; color: #a0aec0; display: block; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .field select, .field input { width: 100%; padding: 12px; background: #0b1220; color: #fff; border: 1px solid var(--blue); border-radius: 8px; box-sizing: border-box; outline: none; }
        .nav-pills { display: flex; gap: 8px; padding: 10px; background: var(--bg); overflow-x: auto; border-bottom: 1px solid #2d3748; }
        .pill { flex: none; padding: 12px 20px; border-radius: 8px; background: #1a202c; font-weight: bold; font-size: 0.75rem; border: 1px solid #2d3748; cursor: pointer; color: #a0aec0; transition: background 0.2s; position: relative; }
        .pill.active { background: var(--blue); color: #fff; border-color: var(--blue); }
        .section { display: none; }
        .section.active { display: block; }
        .exercise-card { background: var(--card); border-radius: 12px; padding: 15px; margin: 10px; border: 1px solid #2d3748; animation: fadeIn 0.3s ease; }
        .ex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .series-grid { display: grid; grid-template-columns: 45px 1fr 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 8px; }
        .input-box { background: #0b1220; border: 1px solid #2d3748; border-radius: 6px; }
        .input-box input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.1rem; padding: 8px 0; outline: none; font-weight: bold; }
        .input-box input::placeholder { color: rgba(255,255,255,0.15); font-style: italic; font-size: 0.8rem; }
        .rm-mini-badge { font-size: 0.55rem; color: var(--green); text-align: center; font-family: monospace; line-height: 1.2; }
        .footer-actions { padding: 20px 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { padding: 15px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; flex: 1; text-align: center; font-size: 0.7rem; text-transform: uppercase; }
        .btn-save { background: var(--green); color: #fff; box-shadow: 0 4px 0 #2d8a84; }
        .btn-config { background: #2d3748; color: var(--blue); border: 1px solid var(--blue); }
        dialog { background: #161e2e; color: #fff; border: 1px solid var(--blue); border-radius: 12px; width: 95%; max-width: 500px; padding: 20px; box-sizing: border-box; border: 1px solid var(--blue); }
        dialog::backdrop { background: rgba(0,0,0,0.8); }
        #csvTextarea { width: 100%; height: 180px; background: #0b1220; color: white; border: 1px solid var(--blue); border-radius: 8px; padding: 10px; box-sizing: border-box; font-family: monospace; resize: none; }
        .tpl-item { padding: 12px; border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; align-items: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="top-header">
        <h1 style="margin:0; font-size:1.1rem; color:var(--blue)">TITAN <span style="color:#fff">PRO</span></h1>
        <div class="date-badge" id="displayDate">--/--/--</div>
    </div>
    <div class="setup-panel" id="setupPanel">
        <div class="field">
            <label>NVIDIA API KEY (Seguran√ßa Local)</label>
            <input type="password" id="apiKeyInput" onchange="saveApiKey()" placeholder="Sua chave fica no navegador">
        </div>
        <div class="field">
            <label>Divis√£o de Treino</label>
            <select id="freq" onchange="gerarProtocolo()"><option value="3">ABC</option><option value="4">ABCD</option><option value="5">ABCDE</option><option value="6">PPL x2</option></select>
        </div>
        <button class="btn btn-save" onclick="document.getElementById('setupPanel').style.display='none'" style="width:100%">FECHAR CONFIG</button>
    </div>
    <div class="nav-pills" id="nav"></div>
    <main id="container"></main>
    <div class="footer-actions">
        <button class="btn btn-config" onclick="document.getElementById('setupPanel').style.display='block'">‚öôÔ∏è CONFIG</button>
        <button class="btn btn-config" onclick="document.getElementById('modalCSV').showModal()">üìä ARQUIVOS</button>
        <button class="btn btn-save" onclick="salvarTreino()">SALVAR SESS√ÉO</button>
        <button class="btn btn-config" onclick="enviarParaIA()" style="background:var(--blue); color:white">ü§ñ IA</button>
        <button class="btn btn-config" onclick="verHistorico()" style="flex:0.4">üìú HIST</button>
    </div>

    <dialog id="modalCSV">
        <h3 style="color:var(--orange)">CSV & Modelos</h3>
        <textarea id="csvTextarea" placeholder="Cole seu CSV aqui..."></textarea>
        <div style="display:flex; gap:5px; margin-top:10px">
            <button class="btn btn-save" onclick="salvarModeloCSV()">üíæ SALVAR MOD</button>
            <button class="btn btn-config" onclick="mostrarModelosCSV()">üìö LISTAR MOD</button>
            <label class="btn btn-config" style="flex:1">üìÑ PDF <input type="file" id="pdfUpload" accept=".pdf" style="display:none" onchange="extrairTextoPDF(this)"></label>
        </div>
        <div id="tplArea" style="margin-top:10px; display:none"><div id="tplList"></div></div>
        <button class="btn" style="width:100%; margin-top:10px; background:var(--red); color:white" onclick="document.getElementById('modalCSV').close()">FECHAR</button>
    </dialog>

    <dialog id="modalLib">
        <h3 id="libHeader" style="color: var(--orange)">Biblioteca</h3>
        <div id="libContent" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="btn" onclick="document.getElementById('modalLib').close()" style="width:100%; margin-top:10px">FECHAR</button>
    </dialog>

    <dialog id="modalHIST">
        <h3 style="color: var(--orange)">Hist√≥rico</h3>
        <div id="histList" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="btn" onclick="document.getElementById('modalHIST').close()" style="width:100%; margin-top:10px">FECHAR</button>
    </dialog>
    <script>
        const STORAGE = { 
            hist: "titanpro_hist_v3", 
            draft: "titanpro_draft_v3", 
            key: "titanpro_key_v3", 
            tpl: "titanpro_tpl_v3" 
        };

        const biblioteca = {
            Peito: ["Supino Inclinado", "Supino Reto", "Crossover", "Voador"],
            Costas: ["Puxada Alta", "Remada Curvada", "Remada Baixa", "Terra"],
            Pernas: ["Agachamento", "Leg Press 45", "Extensora", "Flexora", "Stiff", "Panturrilha"],
            Ombros: ["Desenvolvimento", "Eleva√ß√£o Lateral", "Crucifixo Inverso"],
            Bra√ßos: ["Rosca Direta", "Tr√≠ceps Corda", "Rosca Martelo", "Tr√≠ceps Testa"]
        };

        function toNum(x) { const n = parseFloat(String(x || "").replace(",", ".")); return isNaN(n) ? 0 : n; }

        // C√ÅLCULO BRZYCKI COM RPE (S√âRIE A S√âRIE)
        function calcRM(kg, reps, rpe) {
            const K = toNum(kg), R = toNum(reps), E = toNum(rpe) || 10;
            if (!K || !R) return 0;
            const rir = 10 - E;
            return K / (1.0278 - (0.0278 * (R + rir)));
        }

        // BUSCA VALORES DA √öLTIMA SESS√ÉO (GHOST MODE)
        function getGhost(exNome, idx) {
            const h = JSON.parse(localStorage.getItem(STORAGE.hist) || "[]");
            if (!h.length) return null;
            // Busca o exerc√≠cio pelo nome em qualquer treino anterior
            const lastEx = h[0].state.sections.flatMap(s => s.cards).find(e => e.nome === exNome);
            return lastEx ? lastEx.series[idx] : null;
        }

        // FUN√á√ÉO CRIAR CARD (INJETANDO C√ÅLCULO E GHOST)
        function criarCard(nome, secId, values = null) {
            const id = "ex-" + Math.random().toString(36).slice(2, 9);
            const sec = document.getElementById(secId);
            const card = document.createElement("div");
            card.className = "exercise-card";
            card.dataset.nome = nome;

            card.innerHTML = `
                <div class="ex-header">
                    <strong class="ex-title" onclick="abrirLibParaTrocar('${id}')">${nome}</strong>
                    <span style="color:var(--red); font-weight:bold; cursor:pointer" onclick="confirmExDelete(this)">[X]</span>
                </div>`;

            for (let i = 0; i < 4; i++) {
                const g = getGhost(nome, i);
                const v = values ? values[i] : { kg: "", reps: "", rpe: "" };
                card.innerHTML += `
                <div class="series-grid">
                    <div class="rm-mini-badge">S${i+1}<br><span id="rm-${id}-${i}">${v.kg ? Math.round(calcRM(v.kg,v.reps,v.rpe))+'kg' : ''}</span></div>
                    <div class="input-box"><input type="number" value="${v.kg}" placeholder="${g ? g.kg : 'KG'}" oninput="updRM('${id}',${i},this)"></div>
                    <div class="input-box"><input type="number" value="${v.reps}" placeholder="${g ? g.reps : 'REPS'}" oninput="updRM('${id}',${i},this)"></div>
                    <div class="input-box"><input type="number" value="${v.rpe}" placeholder="${g ? g.rpe : 'RPE'}" oninput="updRM('${id}',${i},this)"></div>
                </div>`;
            }
            sec.appendChild(card);
        }

        function updRM(id, i, el) {
            const row = el.closest(".series-grid");
            const ins = row.querySelectorAll("input");
            const rm = calcRM(ins[0].value, ins[1].value, ins[2].value);
            const display = document.getElementById(`rm-${id}-${i}`);
            if (display) display.innerText = rm ? Math.round(rm) + "kg" : "";
            saveDraft();
        }

        // SERIALIZA√á√ÉO COMPLETA DO ESTADO
        function serialize() {
            return {
                sections: [...document.querySelectorAll(".section")].map(sec => ({
                    nome: sec.dataset.nome,
                    cards: [...sec.querySelectorAll(".exercise-card")].map(c => ({
                        nome: c.dataset.nome,
                        series: [...c.querySelectorAll(".series-grid")].map(r => {
                            const i = r.querySelectorAll("input");
                            return { kg: i[0].value, reps: i[1].value, rpe: i[2].value };
                        })
                    }))
                }))
            };
        }

        function saveDraft() { localStorage.setItem(STORAGE.draft, JSON.stringify(serialize())); }
        function saveApiKey() { localStorage.setItem(STORAGE.key, document.getElementById("apiKeyInput").value); }
        // L√ìGICA DE EXCLUS√ÉO DE ABA (LONG PRESS)
        function bindLongPress() {
            document.querySelectorAll(".pill").forEach((pill, idx) => {
                let timer;
                const start = () => { timer = setTimeout(() => deletePill(idx), 800); };
                const end = () => clearTimeout(timer);
                pill.onmousedown = pill.ontouchstart = start;
                pill.onmouseup = pill.onmouseleave = pill.ontouchend = end;
                pill.oncontextmenu = (e) => { e.preventDefault(); deletePill(idx); };
            });
        }

        function deletePill(idx) {
            if (confirm("Apagar esta aba de treino inteira?")) {
                const s = serialize();
                s.sections.splice(idx, 1);
                render(s);
                saveDraft();
            }
        }

        function confirmExDelete(el) { if (confirm("Apagar este exerc√≠cio?")) { el.closest(".exercise-card").remove(); saveDraft(); } }

        // SISTEMA DE MODELOS CSV (SALVAR MOD)
        function salvarModeloCSV() {
            const txt = document.getElementById("csvTextarea").value;
            if (!txt.trim()) return alert("√Årea de texto vazia!");
            const nome = prompt("Nome do Modelo (ex: Ficha ABC):");
            if (!nome) return;
            const tpls = JSON.parse(localStorage.getItem(STORAGE.tpl) || "{}");
            tpls[nome] = txt;
            localStorage.setItem(STORAGE.tpl, JSON.stringify(tpls));
            alert("Modelo '" + nome + "' salvo com sucesso!");
            mostrarModelosCSV();
        }

        function mostrarModelosCSV() {
            const list = document.getElementById("tplList");
            const tpls = JSON.parse(localStorage.getItem(STORAGE.tpl) || "{}");
            const keys = Object.keys(tpls);
            list.innerHTML = keys.length ? "" : "<div class='tpl-item'>Nenhum modelo salvo.</div>";
            keys.forEach(k => {
                const item = document.createElement("div");
                item.className = "tpl-item";
                item.innerHTML = `<span style="flex:1" onclick="useTpl('${k}')">üìÑ ${k}</span><span onclick="delTpl('${k}')" style="color:var(--red); padding-left:15px">üóëÔ∏è</span>`;
                list.appendChild(item);
            });
            document.getElementById("tplArea").style.display = "block";
        }

        function useTpl(k) {
            const tpls = JSON.parse(localStorage.getItem(STORAGE.tpl));
            document.getElementById("csvTextarea").value = tpls[k];
            alert("Modelo '" + k + "' carregado.");
        }

        function delTpl(k) {
            if (confirm("Deletar modelo '" + k + "'?")) {
                const tpls = JSON.parse(localStorage.getItem(STORAGE.tpl));
                delete tpls[k];
                localStorage.setItem(STORAGE.tpl, JSON.stringify(tpls));
                mostrarModelosCSV();
            }
        }

        // INTEGRA√á√ÉO NEMOTRON (IA)
        async function enviarParaIA() {
            const key = localStorage.getItem(STORAGE.key);
            if (!key) return alert("üîë Configure a NVIDIA API Key no painel CONFIG.");
            const data = serialize();
            try {
                const res = await fetch("https://integrate.api.nvidia.com/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        model: "nvidia/nemotron-70b-instruct", 
                        messages: [{ role: "user", content: `Analise meu e1RM e sugira progress√µes: ${JSON.stringify(data)}` }] 
                    })
                });
                const json = await res.json();
                alert("ü§ñ AN√ÅLISE IA:\n" + json.choices[0].message.content);
            } catch (e) { alert("‚ùå Erro na conex√£o com a NVIDIA."); }
        }

        // PDF E IMPORTA√á√ÉO
        async function extrairTextoPDF(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = async function() {
                const typed = new Uint8Array(this.result);
                const pdf = await pdfjsLib.getDocument(typed).promise;
                let txt = "";
                for(let i=1; i<=pdf.numPages; i++){ const p = await pdf.getPage(i); const c = await p.getTextContent(); txt += c.items.map(s=>s.str).join(" "); }
                document.getElementById("csvTextarea").value = txt;
                alert("‚úÖ PDF Lido! Ajuste e clique em IMPORTAR.");
            };
            reader.readAsArrayBuffer(file);
        }

        function importarCSV() {
            const raw = document.getElementById("csvTextarea").value;
            const linhas = raw.split("\n").filter(l => l.trim().length > 3);
            const currentTab = document.querySelector(".section.active");
            if(!currentTab) return alert("Crie uma aba de treino primeiro.");
            linhas.forEach(l => criarCard(l.trim(), currentTab.id));
            saveDraft();
            document.getElementById("modalCSV").close();
        }

        // INICIALIZA√á√ÉO E HIST√ìRICO
        function salvarTreino() {
            const data = serialize();
            const h = JSON.parse(localStorage.getItem(STORAGE.hist) || "[]");
            h.unshift({ date: new Date().toISOString(), state: data });
            localStorage.setItem(STORAGE.hist, JSON.stringify(h.slice(0, 50)));
            localStorage.removeItem(STORAGE.draft);
            alert("‚úÖ Sess√£o Salva! Ghost Mode ativo para o pr√≥ximo treino.");
            location.reload();
        }

        function verHistorico() {
            const list = document.getElementById("histList");
            const h = JSON.parse(localStorage.getItem(STORAGE.hist) || "[]");
            list.innerHTML = h.length ? "" : "Nenhum hist√≥rico.";
            h.forEach((s, idx) => {
                const d = document.createElement("div");
                d.className = "hist-item";
                d.innerHTML = `<strong>${new Date(s.date).toLocaleDateString()}</strong> - ${s.state.sections.length} abas. <button onclick="restaurarHist(${idx})" style="font-size:0.6rem">VER</button>`;
                list.appendChild(d);
            });
            document.getElementById("modalHIST").showModal();
        }

        function restaurarHist(idx) {
            const h = JSON.parse(localStorage.getItem(STORAGE.hist))[idx];
            render(h.state);
            document.getElementById("modalHIST").close();
        }

        function render(data) {
            const nav = document.getElementById("nav");
            const cont = document.getElementById("container");
            nav.innerHTML = ""; cont.innerHTML = "";
            data.sections.forEach((sec, i) => {
                nav.innerHTML += `<div class="pill ${i==0?'active':''}" onclick="tab(${i})">${sec.nome}</div>`;
                const d = document.createElement("div");
                d.id = "sec"+i; d.className = "section "+(i==0?'active':''); d.dataset.nome = sec.nome;
                cont.appendChild(d);
                sec.cards.forEach(c => criarCard(c.nome, d.id, c.series));
            });
            bindLongPress();
        }

        function tab(i) {
            document.querySelectorAll(".section, .pill").forEach(el => el.classList.remove("active"));
            document.getElementById("sec"+i).classList.add("active");
            document.querySelectorAll(".pill")[i].classList.add("active");
        }

        function gerarProtocolo() {
            const f = document.getElementById("freq").value;
            const sections = [];
            for (let i = 0; i < f; i++) {
                sections.push({ nome: "Treino " + String.fromCharCode(65+i), cards: [{ nome: "Exerc√≠cio Inicial", series: null }] });
            }
            render({ sections });
        }

        window.onload = () => {
            document.getElementById("displayDate").innerText = new Date().toLocaleDateString("pt-BR");
            const d = localStorage.getItem(STORAGE.draft);
            const k = localStorage.getItem(STORAGE.key);
            if(k) document.getElementById("apiKeyInput").value = k;
            if(d) render(JSON.parse(d)); else gerarProtocolo();
        };

        function abrirLibParaNovo() { 
            const activeSec = document.querySelector(".section.active");
            if(activeSec) criarCard("Novo Exerc√≠cio", activeSec.id);
        }
    </script>
</body>
</html>
