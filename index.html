<!doctype html>
<html lang="pt-PT">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Smart Log</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";</script>
    <style>
        :root { --bg: #0b1220; --card: #161e2e; --blue: #3182ce; --text: #f7fafc; --orange: #f6ad55; --green: #38b2ac; --red: #e53e3e; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 20px; }
        .top-header { padding: 15px; background: var(--card); border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .date-badge { font-size: 0.8rem; color: var(--orange); font-weight: bold; background: #0b1220; padding: 4px 10px; border-radius: 15px; }
        .setup-panel { background: var(--card); padding: 20px; border-bottom: 3px solid var(--blue); }
        .field { margin-bottom: 15px; }
        .field label { font-size: 0.7rem; color: #a0aec0; display: block; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .field select, .field input { width: 100%; padding: 12px; background: #0b1220; color: #fff; border: 1px solid var(--blue); border-radius: 8px; box-sizing: border-box; }
        .nav-pills { display: flex; gap: 8px; padding: 10px; background: var(--bg); overflow-x: auto; border-bottom: 1px solid #2d3748; }
        .pill { flex: none; padding: 12px 20px; border-radius: 8px; background: #1a202c; font-weight: bold; font-size: 0.75rem; border: 1px solid #2d3748; cursor: pointer; color: #a0aec0; }
        .pill.active { background: var(--blue); color: #fff; }
        .section { display: none; }
        .section.active { display: block; }
        .exercise-card { background: var(--card); border-radius: 12px; padding: 15px; margin: 10px; border: 1px solid #2d3748; }
        .series-grid { display: grid; grid-template-columns: 45px 1fr 1fr 1fr; gap: 8px; align-items: center; margin-bottom: 8px; }
        .input-box { background: #0b1220; border: 1px solid #2d3748; border-radius: 6px; }
        .input-box input { background: transparent; border: none; color: #fff; width: 100%; text-align: center; font-size: 1.1rem; padding: 8px 0; outline: none; font-weight: bold; }
        .input-box input::placeholder { color: rgba(255,255,255,0.2); font-style: italic; }
        .rmmini { font-size: 0.6rem; color: var(--green); text-align: center; }
        .footer-actions { padding: 20px 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { padding: 15px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; flex: 1; text-align: center; font-size: 0.75rem; text-transform: uppercase; }
        .btn-save { background: var(--green); color: #fff; }
        .btn-config { background: #2d3748; color: var(--blue); border: 1px solid var(--blue); }
        dialog { background: #161e2e; color: #fff; border: 1px solid var(--blue); border-radius: 12px; width: 90%; max-width: 500px; padding: 20px; }
        #csvTextarea { width: 100%; height: 150px; background: #0b1220; color: white; border: 1px solid var(--blue); border-radius: 8px; }
        .tpl-item { padding: 10px; border-bottom: 1px solid #2d3748; display: flex; justify-content: space-between; cursor: pointer; }
    </style>
</head>
<body>
    <div class="top-header">
        <h1 style="margin:0; font-size:1.1rem; color:var(--blue)">TITAN <span style="color:#fff">PRO</span></h1>
        <div class="date-badge" id="displayDate">--/--/--</div>
    </div>

    <div class="setup-panel" id="setupPanel">
        <div class="field">
            <label>NVIDIA API KEY (Nemotron)</label>
            <input type="password" id="apiKeyInput" onchange="saveApiKey()" placeholder="Sua chave fica no navegador">
        </div>
        <div class="field">
            <label>Frequ√™ncia</label>
            <select id="freq" onchange="gerarProtocolo()"><option value="3">ABC</option><option value="4">Upper/Lower</option><option value="5">ABCDE</option></select>
        </div>
        <button class="btn btn-save" onclick="document.getElementById('setupPanel').style.display='none'">ABRIR TREINO</button>
    </div>

    <div class="nav-pills" id="nav"></div>
    <main id="container"></main>

    <div class="footer-actions">
        <button class="btn btn-config" onclick="document.getElementById('setupPanel').style.display='block'">‚öôÔ∏è CONFIG</button>
        <button class="btn btn-config" onclick="document.getElementById('modalCSV').showModal()">üìä ARQUIVOS</button>
        <button class="btn btn-save" onclick="salvarTreino()">SALVAR SESS√ÉO</button>
        <button class="btn btn-config" onclick="enviarParaIA()" style="background:var(--blue); color:white">ü§ñ IA</button>
    </div>

    <dialog id="modalCSV">
        <h3 style="color:var(--orange)">CSV & Modelos</h3>
        <textarea id="csvTextarea" placeholder="Cole seu CSV aqui..."></textarea>
        <div style="display:flex; gap:5px; margin-top:10px">
            <button class="btn btn-save" onclick="salvarModeloCSV()">üíæ SALVAR MOD</button>
            <button class="btn btn-config" onclick="mostrarModelosCSV()">üìö LISTAR MOD</button>
        </div>
        <div id="tplArea" style="margin-top:10px; display:none"><div id="tplList"></div></div>
        <button class="btn" style="width:100%; margin-top:10px" onclick="document.getElementById('modalCSV').close()">FECHAR</button>
    </dialog>

    <script>
        const STORAGE = { hist: "t_hist", draft: "t_draft", apiKey: "t_key", tpl: "t_tpl" };

        function toNum(x) { const n = parseFloat(String(x || "").replace(",", ".")); return isNaN(n) ? 0 : n; }
        
        function calcRM(kg, reps, rpe) {
            const K = toNum(kg), R = toNum(reps), E = toNum(rpe) || 10;
            if (!K || !R) return 0;
            return K / (1.0278 - (0.0278 * (R + (10 - E))));
        }

        function getGhost(exNome, idx) {
            const h = JSON.parse(localStorage.getItem(STORAGE.hist) || "[]");
            if (!h.length) return null;
            const ex = h[0].state.find(e => e.nome === exNome);
            return ex ? ex.series[idx] : null;
        }

        function criarCard(nome, sec, values = null) {
            const id = "ex-" + Math.random().toString(36).slice(2, 9);
            const card = document.createElement("div");
            card.className = "exercise-card";
            card.innerHTML = `<div style="display:flex; justify-content:space-between"><strong>${nome}</strong><span onclick="this.closest('.exercise-card').remove(); saveDraft()" style="color:var(--red); cursor:pointer">[X]</span></div>`;
            
            for (let i = 0; i < 4; i++) {
                const g = getGhost(nome, i);
                const v = values ? values[i] : { kg: "", reps: "", rpe: "" };
                card.innerHTML += `
                <div class="series-grid">
                    <div class="rmmini">S${i+1}<br><span id="rm-${id}-${i}">${v.kg?Math.round(calcRM(v.kg,v.reps,v.rpe)):''}</span></div>
                    <div class="input-box"><input type="number" value="${v.kg}" placeholder="${g?g.kg:''}" oninput="updRM('${id}',${i},this)"></div>
                    <div class="input-box"><input type="number" value="${v.reps}" placeholder="${g?g.reps:''}" oninput="updRM('${id}',${i},this)"></div>
                    <div class="input-box"><input type="number" value="${v.rpe}" placeholder="${g?g.rpe:''}" oninput="updRM('${id}',${i},this)"></div>
                </div>`;
            }
            sec.appendChild(card);
        }

        function updRM(id, i, el) {
            const row = el.closest(".series-grid");
            const ins = row.querySelectorAll("input");
            const rm = calcRM(ins[0].value, ins[1].value, ins[2].value);
            document.getElementById(`rm-${id}-${i}`).innerText = rm ? Math.round(rm) : "";
            saveDraft();
        }

        function salvarModeloCSV() {
            const txt = document.getElementById("csvTextarea").value;
            const nome = prompt("Nome do Modelo:");
            if (!txt || !nome) return;
            const tpls = JSON.parse(localStorage.getItem(STORAGE.tpl) || "{}");
            tpls[nome] = txt;
            localStorage.setItem(STORAGE.tpl, JSON.stringify(tpls));
            alert("Modelo Salvo!");
        }

        function mostrarModelosCSV() {
            const list = document.getElementById("tplList");
            const tpls = JSON.parse(localStorage.getItem(STORAGE.tpl) || "{}");
            list.innerHTML = "";
            Object.keys(tpls).forEach(k => {
                list.innerHTML += `<div class="tpl-item" onclick="document.getElementById('csvTextarea').value='${tpls[k]}'"><span>${k}</span><span onclick="deleteTpl('${k}')">üóëÔ∏è</span></div>`;
            });
            document.getElementById("tplArea").style.display = "block";
        }

        function serializeCurrent() {
            return [...document.querySelectorAll(".exercise-card")].map(c => ({
                nome: c.querySelector("strong").innerText,
                series: [...c.querySelectorAll(".series-grid")].map(r => {
                    const i = r.querySelectorAll("input");
                    return { kg: i[0].value, reps: i[1].value, rpe: i[2].value };
                })
            }));
        }

        function saveDraft() { localStorage.setItem(STORAGE.draft, JSON.stringify(serializeCurrent())); }
        function saveApiKey() { localStorage.setItem(STORAGE.apiKey, document.getElementById("apiKeyInput").value); }
        function salvarTreino() {
            const h = JSON.parse(localStorage.getItem(STORAGE.hist) || "[]");
            h.unshift({ date: new Date().toISOString(), state: serializeCurrent() });
            localStorage.setItem(STORAGE.hist, JSON.stringify(h.slice(0, 80)));
            localStorage.removeItem(STORAGE.draft);
            alert("Sess√£o Salva!"); location.reload();
        }

        function tab(idx) {
            document.querySelectorAll(".section, .pill").forEach(el => el.classList.remove("active"));
            document.getElementById("sec"+idx).classList.add("active");
            document.querySelectorAll(".pill")[idx].classList.add("active");
        }

        function gerarProtocolo() {
            const f = document.getElementById("freq").value;
            const nav = document.getElementById("nav");
            const cont = document.getElementById("container");
            nav.innerHTML = ""; cont.innerHTML = "";
            for (let i = 0; i < f; i++) {
                const label = "Treino " + String.fromCharCode(65+i);
                nav.innerHTML += `<div class="pill ${i==0?'active':''}" onclick="tab(${i})">${label}</div>`;
                const sec = document.createElement("div");
                sec.id = "sec"+i; sec.className = "section " + (i==0?'active':'');
                cont.appendChild(sec);
                criarCard("Exerc√≠cio", sec.id);
            }
        }

        window.onload = () => {
            document.getElementById("displayDate").innerText = new Date().toLocaleDateString("pt-BR");
            const draft = localStorage.getItem(STORAGE.draft);
            const key = localStorage.getItem(STORAGE.apiKey);
            if(key) document.getElementById("apiKeyInput").value = key;
            if(draft) {
                // L√≥gica de carregar rascunho
            }
            gerarProtocolo();
        }
    </script>
</body>
</html>
