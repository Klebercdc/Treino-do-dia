<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Smart Log</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>

    <link rel="icon" href="Logo.png" type="image/png" />

    <style>
      :root {
        --bg: #0b1220;
        --card: #161e2e;
        --blue: #3182ce;
        --text: #f7fafc;
        --orange: #f6ad55;
        --green: #38b2ac;
        --red: #e53e3e;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, sans-serif;
        margin: 0;
        padding-bottom: 20px;
      }

      .top-header {
        padding: 15px;
        background: var(--card);
        border-bottom: 1px solid #2d3748;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .date-badge {
        font-size: 0.8rem;
        color: var(--orange);
        font-weight: bold;
        background: #0b1220;
        padding: 4px 10px;
        border-radius: 15px;
      }
      .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .setup-panel {
        background: var(--card);
        padding: 20px;
        border-bottom: 3px solid var(--blue);
        display: block;
      }
      .field {
        margin-bottom: 15px;
      }
      .field label {
        font-size: 0.7rem;
        color: #a0aec0;
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .field select, .field input {
        width: 100%;
        padding: 12px;
        background: #0b1220;
        color: #fff;
        border: 1px solid var(--blue);
        border-radius: 8px;
        box-sizing: border-box;
      }

      .nav-pills {
        display: flex;
        gap: 8px;
        padding: 10px;
        background: var(--bg);
        overflow-x: auto;
        border-bottom: 1px solid #2d3748;
      }
      .pill {
        flex: none;
        padding: 12px 20px;
        border-radius: 8px;
        background: #1a202c;
        font-weight: bold;
        font-size: 0.75rem;
        border: 1px solid #2d3748;
        cursor: pointer;
        color: #a0aec0;
      }
      .pill.active {
        background: var(--blue);
        border-color: var(--blue);
        color: #fff;
      }
      .pill.add-pill {
        border: 2px dashed var(--blue);
        color: var(--blue);
      }

      .section { display: none; }
      .section.active { display: block; }

      .exercise-card {
        background: var(--card);
        border-radius: 12px;
        padding: 15px;
        margin: 10px;
        border: 1px solid #2d3748;
      }
      .ex-title {
        font-weight: 800;
        font-size: 1.1rem;
        color: var(--blue);
        text-decoration: underline dotted;
        cursor: pointer;
      }
      .ex-target {
        font-size: 0.75rem;
        color: var(--orange);
        font-weight: bold;
        margin: 4px 0 5px 0;
        display: block;
      }

      .rpe-suggest {
        display: block;
        font-size: 0.7rem;
        color: var(--green);
        margin-bottom: 10px;
        font-family: monospace;
      }

      .series-grid {
        display: grid;
        grid-template-columns: 45px 1fr 1fr 1fr;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .header-grid {
        text-align: center;
        font-size: 0.6rem;
        color: #718096;
        font-weight: bold;
      }
      .input-box {
        background: #0b1220;
        border: 1px solid #2d3748;
        border-radius: 6px;
      }
      .input-box input {
        background: transparent;
        border: none;
        color: #fff;
        width: 100%;
        text-align: center;
        font-size: 1.1rem;
        padding: 8px 0;
        outline: none;
        font-weight: bold;
      }
      .input-box input::placeholder { color: rgba(255,255,255,0.15); }

      .btn-add-ex {
        background: #1a202c;
        color: var(--blue);
        border: 2px dashed var(--blue);
        width: calc(100% - 20px);
        margin: 15px 10px;
        padding: 15px;
        border-radius: 12px;
        font-weight: 800;
      }

      .footer-actions {
        padding: 20px 10px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 12px;
        border-radius: 10px;
        border: none;
        font-weight: 800;
        cursor: pointer;
        font-size: 0.7rem;
        text-transform: uppercase;
        flex: 1;
      }
      .btn-save { background: var(--green); color: #fff; }
      .btn-config { background: #2d3748; color: var(--blue); border: 1px solid var(--blue); }
      .btn-ia { background: #4a5568; color: #f6ad55; border: 1px solid #f6ad55; }

      dialog {
        background: #161e2e;
        color: #fff;
        border: 1px solid var(--blue);
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        padding: 20px;
      }
      dialog::backdrop { background: rgba(0, 0, 0, 0.8); }
    </style>
  </head>

  <body>
    <div class="top-header">
      <div class="header-left">
        <h1 style="margin: 0; font-size: 1.1rem; color: var(--blue)">
          TITAN <span style="color: #fff">PRO</span>
        </h1>
      </div>
      <div class="date-badge" id="displayDate">--/--/--</div>
    </div>

    <div class="setup-panel" id="setupPanel">
      <div class="field">
        <label>Frequ√™ncia Semanal</label>
        <select id="freq" onchange="gerarProtocolo()">
          <option value="3">3 Dias (ABC)</option>
          <option value="4">4 Dias (Upper/Lower)</option>
          <option value="5">5 Dias (ABCDE)</option>
        </select>
      </div>
      <div class="field">
        <label>Objetivo Principal</label>
        <select id="obj" onchange="gerarProtocolo()">
          <option value="hipertrofia">Hipertrofia (RPE 8-9)</option>
          <option value="forca">For√ßa (RPE 9-10)</option>
        </select>
      </div>
      <button class="btn btn-save" onclick="closeConfig()">ABRIR TREINO</button>
    </div>

    <div class="nav-pills" id="nav"></div>
    <main id="container"></main>
    <button class="btn-add-ex" onclick="abrirLibParaNovo()">+ ADICIONAR EXERC√çCIO</button>

    <div class="footer-actions">
      <button class="btn btn-config" onclick="openConfig()">‚öôÔ∏è CONFIG</button>
      <button class="btn btn-ia" onclick="openIAConfig()">üîë API IA</button>
      <button class="btn btn-save" onclick="salvarTreino()">SALVAR SESS√ÉO</button>
      <button class="btn btn-config" onclick="enviarParaIA()" style="background:var(--blue); color:white;">ü§ñ ANALISAR IA</button>
    </div>

    <dialog id="modalIA">
      <h3 style="color: var(--orange); margin-top:0">Configura√ß√£o NVIDIA</h3>
      <div class="field">
        <label>NVIDIA API Key</label>
        <input type="password" id="apiKeyInput" placeholder="nvapi-...">
      </div>
      <button class="btn btn-save" onclick="saveApiKey()" style="width:100%">SALVAR CHAVE</button>
      <button class="btn" onclick="document.getElementById('modalIA').close()" style="width:100%; margin-top:10px">FECHAR</button>
    </dialog>

    <dialog id="modalLib">
      <h3 id="libHeader" style="margin:0 0 15px 0; color:var(--orange)">Trocar Exerc√≠cio</h3>
      <div id="libContent" style="max-height:300px; overflow-y:auto"></div>
      <button class="btn" onclick="document.getElementById('modalLib').close()" style="width:100%; margin-top:10px; background:#2d3748; color:white">Fechar</button>
    </dialog>

    <script>
      const STORAGE = {
        draft: "titan_draft_v3",
        history: "titan_history_v3",
        apiKey: "titan_nvidia_key"
      };

      const biblioteca = {
        Peito: ["Supino Inclinado", "Supino Reto", "Crossover"],
        Costas: ["Puxada Alta", "Remada Curvada", "Remada Serrote"],
        Pernas: ["Agachamento", "Leg Press", "Extensora", "Stiff"],
        Ombros: ["Desenvolvimento", "Eleva√ß√£o Lateral"],
        Bra√ßos: ["Rosca Direta", "Tr√≠ceps Testa", "Rosca Martelo"]
      };

      // --- SEGURAN√áA E IA ---
      function openIAConfig() {
        const saved = localStorage.getItem(STORAGE.apiKey);
        if(saved) document.getElementById('apiKeyInput').value = saved;
        document.getElementById('modalIA').showModal();
      }

      function saveApiKey() {
        const val = document.getElementById('apiKeyInput').value;
        localStorage.setItem(STORAGE.apiKey, val);
        alert("Chave salva localmente!");
        document.getElementById('modalIA').close();
      }

      function calcularBrzycki(peso, reps, rpe) {
        const p = parseFloat(peso);
        const r = parseFloat(reps);
        const e = parseFloat(rpe) || 10;
        if (!p || !r) return 0;
        
        // Autorregula√ß√£o: Se RPE 8, restaram 2 reps (RIR). Somamos ao c√°lculo.
        const rir = 10 - e;
        const repsTotais = r + rir;
        return p / (1.0278 - (0.0278 * repsTotais));
      }

      async function enviarParaIA() {
        const key = localStorage.getItem(STORAGE.apiKey);
        if(!key) return alert("Configure a API Key primeiro!");

        const st = serializeCurrentState();
        const promptIA = {
            model: "nvidia/nemotron-70b-instruct",
            messages: [{
                role: "user", 
                content: `Analise este treino e sugira progress√µes baseadas no e1RM e RPE: ${JSON.stringify(st)}`
            }],
            temperature: 0.5, top_p: 0.7, max_tokens: 1024
        };

        try {
            const res = await fetch("https://integrate.api.nvidia.com/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                body: JSON.stringify(promptIA)
            });
            const data = await res.json();
            alert("NEMOTRON: " + data.choices[0].message.content);
        } catch(e) { alert("Erro na conex√£o com IA."); }
      }

      // --- L√ìGICA DO APP ---
      function openConfig() { document.getElementById("setupPanel").style.display = "block"; }
      function closeConfig() { document.getElementById("setupPanel").style.display = "none"; }

      function criarCard(nome, sectionId, values = null) {
        const id = "ex-" + Math.random().toString(36).slice(2, 7);
        const sec = document.getElementById(sectionId);
        const card = document.createElement("div");
        card.className = "exercise-card";
        card.setAttribute("data-ex-id", id);
        card.setAttribute("data-ex-name", nome);

        let rows = "";
        for(let s=0; s<4; s++) {
          const v = values && values[s] ? values[s] : {kg:'', reps:'', rpe:''};
          rows += `
            <div class="series-grid">
              <span style="font-size:0.7rem; color:#718096; font-weight:bold">S${s+1}</span>
              <div class="input-box"><input type="number" placeholder="KG" value="${v.kg}" oninput="updateSuggests('${id}')"></div>
              <div class="input-box"><input type="number" placeholder="REPS" value="${v.reps}" oninput="updateSuggests('${id}')"></div>
              <div class="input-box"><input type="number" placeholder="RPE" value="${v.rpe}" oninput="updateSuggests('${id}')"></div>
            </div>`;
        }

        card.innerHTML = `
          <span class="ex-title" onclick="abrirLibParaTrocar('${id}')">${nome}</span>
          <span class="ex-target">4 Sets ‚Ä¢ Foco Progress√£o</span>
          <span class="rpe-suggest">e1RM (Brzycki): <span id="rm-${id}">-</span></span>
          <div class="series-grid header-grid"><span>SET</span><span>KG</span><span>REPS</span><span>RPE</span></div>
          ${rows}
        `;
        sec.appendChild(card);
        updateSuggests(id);
      }

      function updateSuggests(id) {
        const card = document.querySelector(`[data-ex-id="${id}"]`);
        const rows = card.querySelectorAll(".series-grid:not(.header-grid)");
        const kg = rows[0].querySelectorAll("input")[0].value;
        const reps = rows[0].querySelectorAll("input")[1].value;
        const rpe = rows[0].querySelectorAll("input")[2].value;

        const rm = calcularBrzycki(kg, reps, rpe);
        document.getElementById(`rm-${id}`).innerText = rm ? Math.round(rm) + "kg" : "-";
        scheduleDraftSave();
      }

      function gerarProtocolo() {
        const f = document.getElementById("freq").value;
        const nav = document.getElementById("nav");
        const cont = document.getElementById("container");
        nav.innerHTML = ""; cont.innerHTML = "";

        for(let i=0; i<f; i++) {
          const char = String.fromCharCode(65 + i);
          nav.innerHTML += `<div class="pill ${i===0?'active':''}" id="p${i}" onclick="tab(${i})">TREINO ${char}</div>`;
          const sec = document.createElement("div");
          sec.id = `sec${i}`;
          sec.className = `section ${i===0?'active':''}`;
          sec.setAttribute("data-treino-key", "Treino "+char);
          cont.appendChild(sec);
          criarCard("Supino ou Agacho", sec.id);
        }
      }

      function tab(idx) {
        document.querySelectorAll(".section, .pill").forEach(el => el.classList.remove("active"));
        document.getElementById(`sec${idx}`).classList.add("active");
        document.getElementById(`p${idx}`).classList.add("active");
      }

      function serializeCurrentState() {
        const sections = Array.from(document.querySelectorAll(".section")).map(sec => ({
          treino: sec.getAttribute("data-treino-key"),
          cards: Array.from(sec.querySelectorAll(".exercise-card")).map(card => ({
            name: card.getAttribute("data-ex-name"),
            values: Array.from(card.querySelectorAll(".series-grid:not(.header-grid)")).map(row => {
              const ins = row.querySelectorAll("input");
              return { kg: ins[0].value, reps: ins[1].value, rpe: ins[2].value };
            })
          }))
        }));
        return { sections, date: new Date().toISOString() };
      }

      function scheduleDraftSave() {
        localStorage.setItem(STORAGE.draft, JSON.stringify(serializeCurrentState()));
      }

      function salvarTreino() {
        const st = serializeCurrentState();
        const hist = JSON.parse(localStorage.getItem(STORAGE.history) || "[]");
        hist.unshift(st);
        localStorage.setItem(STORAGE.history, JSON.stringify(hist.slice(0,50)));
        alert("Sess√£o salva no hist√≥rico!");
      }

      window.onload = () => {
        document.getElementById("displayDate").innerText = new Date().toLocaleDateString("pt-BR");
        const r = localStorage.getItem(STORAGE.draft);
        if (r) {
            const data = JSON.parse(r);
            // Simplificado para carregar draft b√°sico
            gerarProtocolo(); 
        } else {
            gerarProtocolo();
        }
      };

      function abrirLibParaNovo() { document.getElementById("modalLib").showModal(); /* biblioteca simples */ }
      function abrirLibParaTrocar(id) { document.getElementById("modalLib").showModal(); }
    </script>
  </body>
</html>
