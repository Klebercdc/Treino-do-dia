<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Smart Log</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="icon" href="Logo.png" type="image/png" />

    <style>
      :root { --bg:#0b1220; --card:#161e2e; --blue:#3182ce; --text:#f7fafc; --orange:#f6ad55; --green:#38b2ac; --red:#e53e3e; --glass: rgba(22, 30, 46, 0.95); }
      body { background:var(--bg); color:var(--text); font-family:-apple-system,sans-serif; margin:0; padding-bottom:20px; user-select:none; -webkit-tap-highlight-color: transparent; }

      /* HEADER & NAV */
      .top-header { padding:15px; background:var(--card); border-bottom:1px solid #2d3748; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; backdrop-filter: blur(10px); }
      .date-badge { font-size:.8rem; color:var(--orange); font-weight:bold; background:#0b1220; padding:4px 10px; border-radius:15px; }
      .logo-img { height:45px; width:auto; filter:drop-shadow(0 0 8px rgba(49,130,206,.6)); }

      /* TIMER DASHBOARD */
      .timer-area { background:#1a202c; padding:12px; border-bottom:2px solid var(--blue); text-align:center; }
      #timerDisplay { font-size:2.5rem; font-weight:800; color:var(--blue); font-family: 'JetBrains Mono', monospace; margin-bottom:8px; font-variant-numeric: tabular-nums; }
      .timer-btns { display:flex; gap:6px; justify-content:center; margin-bottom:5px; }
      .btn-t { background:#2d3748; color:#fff; border:none; padding:10px 15px; border-radius:8px; font-size:.75rem; cursor:pointer; font-weight:bold; transition: 0.2s; }
      .btn-t.active { background:var(--blue); box-shadow: 0 0 10px var(--blue); }
      .btn-ctrl { background:var(--green); color:#fff; border:none; padding:12px 25px; border-radius:8px; font-weight:bold; cursor:pointer; }

      /* BENTO CARDS - EXERC√çCIOS */
      .exercise-card { background:var(--card); border-radius:16px; padding:18px; margin:15px 10px; border:1px solid #2d3748; position:relative; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
      .ex-title { font-weight:800; font-size:1.2rem; color:var(--blue); display: block; margin-bottom: 2px; }
      .ex-target { font-size:.75rem; color:var(--orange); font-weight:bold; margin-bottom: 12px; display:block; opacity: 0.9; }
      .rpe-suggest { display:block; font-size:0.75rem; color:var(--green); margin-bottom:15px; background: rgba(56, 178, 172, 0.1); padding: 5px 10px; border-radius: 6px; }

      /* INPUT GRID */
      .series-grid { display:grid; grid-template-columns:35px 1fr 1fr 1fr; gap:10px; align-items:center; margin-bottom:8px; }
      .header-grid { text-align:center; font-size:.65rem; color:#718096; font-weight:bold; text-transform: uppercase; }
      .input-box { background:#0b1220; border:1px solid #2d3748; border-radius:8px; padding:10px 0; transition: 0.3s; }
      .input-box.filled { border-color: var(--green); background: rgba(56, 178, 172, 0.05); }
      .input-box input { background:transparent; border:none; color:#fff; width:100%; text-align:center; font-size:1.2rem; outline:none; font-weight:bold; }
      .input-box input::placeholder { color: rgba(255,255,255,0.1); font-weight: 400; }

      /* PILLS & NAVIGATION */
      .nav-pills { display:flex; gap:10px; padding:12px; background:var(--bg); overflow-x:auto; scrollbar-width: none; }
      .pill { flex:none; padding:12px 22px; border-radius:12px; background:#1a202c; font-weight:bold; font-size:.8rem; border:1px solid #2d3748; cursor:pointer; color:#a0aec0; position:relative; }
      .pill.active { background:var(--blue); color:#fff; border-color: var(--blue); }
      .pill-x { margin-left: 8px; color: var(--red); font-weight: 900; }

      /* FOOTER FIXED */
      .footer-actions { padding:15px; display:flex; gap:10px; background: var(--glass); position: sticky; bottom: 0; backdrop-filter: blur(10px); border-top: 1px solid #2d3748; }
      .btn { padding:15px; border-radius:12px; border:none; font-weight:800; cursor:pointer; flex:1; font-size:.7rem; transition: 0.2s; }
      .btn-save { background:var(--green); color:#fff; box-shadow:0 4px 15px rgba(56, 178, 172, 0.3); }
      
      dialog { background:var(--card); color:#fff; border:1px solid var(--blue); border-radius:18px; width:92%; max-width:450px; padding:25px; box-shadow: 0 0 40px rgba(0,0,0,0.8); }
      dialog::backdrop { background: rgba(0,0,0,0.8); }

      @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to { opacity:1; transform:translateY(0);} }
    </style>
  </head>

  <body>
    <div class="top-header">
      <div class="header-left">
        <img src="Logo.png" alt="TITAN" class="logo-img" onerror="this.style.display='none'"/>
        <h1 style="margin:0; font-size:1.2rem; font-weight: 900; color:var(--blue);">TITAN <span style="color:#fff">PRO</span></h1>
      </div>
      <div class="date-badge" id="displayDate">--/--/--</div>
    </div>

    <div class="timer-area">
      <div id="timerDisplay">01:00</div>
      <div class="timer-btns">
        <button class="btn-t active" onclick="TitanApp.Timer.set(60, this)">1m</button>
        <button class="btn-t" onclick="TitanApp.Timer.set(120, this)">2m</button>
        <button class="btn-t" onclick="TitanApp.Timer.set(180, this)">3m</button>
        <button class="btn-t" onclick="TitanApp.Timer.set(300, this)">5m</button>
      </div>
      <div class="timer-btns">
        <button id="ctrlBtn" class="btn-ctrl" onclick="TitanApp.Timer.toggle()">INICIAR</button>
        <button class="btn-ctrl" style="background:var(--red)" onclick="TitanApp.Timer.reset()">ZERAR</button>
      </div>
    </div>

    <div class="setup-panel" id="setupPanel">
      <div class="field">
        <label>Objetivo do Protocolo</label>
        <select id="obj" onchange="TitanApp.Workout.generate()">
          <option value="hipertrofia">Hipertrofia (Est√©tica)</option>
          <option value="forca">For√ßa (Cargas M√°ximas)</option>
          <option value="definicao">Defini√ß√£o (Metab√≥lico)</option>
        </select>
      </div>
      <button class="btn btn-save" onclick="document.getElementById('setupPanel').style.display='none'" style="width:100%">FECHAR CONFIG</button>
    </div>

    <div class="nav-pills" id="nav"></div>
    <main id="container"></main>
    <button class="btn-add-ex" style="width: calc(100% - 20px); margin: 10px;" onclick="TitanApp.Library.open(true)">+ ADICIONAR EXERC√çCIO</button>

    <div class="footer-actions">
      <button class="btn btn-config" onclick="document.getElementById('setupPanel').style.display='block'">‚öôÔ∏è</button>
      <button class="btn btn-config" onclick="TitanApp.Stats.showChart()">üìà</button>
      <button class="btn btn-save" onclick="TitanApp.Storage.saveSession()">SALVAR TREINO</button>
      <button class="btn btn-config" onclick="TitanApp.History.open()">üìú</button>
    </div>

    <dialog id="modalLib">
      <h3 id="libHeader" style="margin:0 0 15px 0; color:var(--orange)">Biblioteca</h3>
      <input type="text" id="manualName" placeholder="Nome personalizado..." style="width:100%; padding:12px; border-radius:8px; border:1px solid var(--blue); background:#0b1220; color:white; margin-bottom: 10px;">
      <div id="libContent" style="max-height:300px; overflow-y:auto;"></div>
      <button class="btn" onclick="this.closest('dialog').close()" style="width:100%; margin-top:10px; background:#2d3748; color:white;">VOLTAR</button>
    </dialog>

    <script>
      /**
       * TITAN APP - ARQUITETURA SINGLETON (PLAYTON STYLE)
       * Respons√°vel: Engine de Performance e Persist√™ncia
       */
      const TitanApp = {
        Config: {
            draftKey: "titanpro_v2_draft",
            historyKey: "titanpro_v2_history",
            maxHistory: 80
        },

        Data: {
            prMap: new Map(),
            isAdding: false,
            currentExId: null,
            biblioteca: {
                "Peito": ["Supino Inclinado", "Supino Reto", "Crossover", "Voador"],
                "Costas": ["Puxada Alta", "Remada Curvada", "Remada Baixa", "Terra"],
                "Pernas": ["Agachamento", "Leg Press 45", "Extensora", "Flexora", "Stiff"],
                "Ombros": ["Desenvolvimento", "Eleva√ß√£o Lateral", "Crucifixo Inverso"],
                "Bra√ßos": ["Rosca Direta", "Tr√≠ceps Corda", "Rosca Martelo", "Tr√≠ceps Testa"]
            }
        },

        // --- M√ìDULO DE PERSIST√äNCIA (STORAGE) ---
        Storage: {
            saveSession() {
                const peso = prompt("Peso corporal hoje (kg)?");
                const state = TitanApp.Workout.serialize();
                const history = JSON.parse(localStorage.getItem(TitanApp.Config.historyKey) || "[]");
                
                history.unshift({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    weight: peso,
                    state: state
                });

                localStorage.setItem(TitanApp.Config.historyKey, JSON.stringify(history.slice(0, TitanApp.Config.maxHistory)));
                TitanApp.Stats.buildPRs();
                alert("Sess√£o Arquivada!");
            },

            autoSave() {
                const state = TitanApp.Workout.serialize();
                localStorage.setItem(TitanApp.Config.draftKey, JSON.stringify(state));
            }
        },

        // --- M√ìDULO DE TREINO (WORKOUT) ---
        Workout: {
            createCard(nome, sectionId, series = 4, values = null) {
                const id = "ex-" + Math.random().toString(36).substr(2, 7);
                const container = document.getElementById(sectionId);
                const card = document.createElement("div");
                card.className = "exercise-card";
                card.id = id;

                let rows = "";
                for (let i = 0; i < series; i++) {
                    const v = values?.[i] || { kg: "", reps: "", rpe: "" };
                    const ghost = TitanApp.Workout.getGhostData(nome, i);
                    rows += `
                        <div class="series-grid">
                            <span class="header-grid">S${i+1}</span>
                            <div class="input-box ${v.kg ? 'filled' : ''}"><input type="number" inputmode="decimal" value="${v.kg}" placeholder="${ghost?.kg || ''}" oninput="TitanApp.Workout.sync('${id}')"></div>
                            <div class="input-box ${v.reps ? 'filled' : ''}"><input type="number" value="${v.reps}" placeholder="${ghost?.reps || ''}" oninput="TitanApp.Workout.sync('${id}')"></div>
                            <div class="input-box"><input type="number" placeholder="RPE" value="${v.rpe}" oninput="TitanApp.Storage.autoSave()"></div>
                        </div>`;
                }

                card.innerHTML = `
                    <span style="position:absolute; top:10px; right:15px; color:var(--red); font-weight:bold; cursor:pointer" onclick="this.parentElement.remove(); TitanApp.Storage.autoSave()">√ó</span>
                    <span class="ex-title" onclick="TitanApp.Library.open(false, '${id}')">${nome}</span>
                    <span class="ex-target">${series} Sets ‚Ä¢ Progress√£o Ativa</span>
                    <div class="rpe-suggest">1RM Est: <span id="rm-${id}">-</span> | Recorde: <span id="pr-${id}">-</span></div>
                    <div class="series-grid header-grid"><span>SET</span><span>KG</span><span>REPS</span><span>RPE</span></div>
                    ${rows}`;

                container.appendChild(card);
                TitanApp.Workout.sync(id);
            },

            sync(id) {
                const card = document.getElementById(id);
                if(!card) return;
                const name = card.querySelector(".ex-title").innerText;
                const inputs = card.querySelectorAll("input");
                let maxRM = 0;

                for (let i = 0; i < inputs.length; i += 3) {
                    const k = parseFloat(inputs[i].value) || 0;
                    const r = parseFloat(inputs[i+1].value) || 0;
                    if(k > 0 && r > 0) {
                        inputs[i].parentElement.classList.add("filled");
                        const rm = k * (1 + r/30);
                        if(rm > maxRM) maxRM = rm;
                    } else {
                        inputs[i].parentElement.classList.remove("filled");
                    }
                }

                const pr = TitanApp.Data.prMap.get(name) || 0;
                document.getElementById(`rm-${id}`).innerText = maxRM ? Math.round(maxRM) + "kg" : "-";
                document.getElementById(`pr-${id}`).innerText = pr ? Math.round(pr) + "kg" : "-";
                if(maxRM > pr + 0.1 && pr > 0) document.getElementById(`rm-${id}`).style.color = "var(--green)";
                
                TitanApp.Storage.autoSave();
            },

            getGhostData(name, idx) {
                const hist = JSON.parse(localStorage.getItem(TitanApp.Config.historyKey) || "[]");
                for (let s of hist) {
                    for (let sec of s.state.sections) {
                        const c = sec.cards.find(x => x.name === name);
                        if (c?.values[idx]?.kg) return c.values[idx];
                    }
                }
                return null;
            },

            serialize() {
                return {
                    obj: document.getElementById("obj").value,
                    sections: Array.from(document.querySelectorAll(".section")).map(sec => ({
                        treinoKey: sec.getAttribute("data-treino-key"),
                        cards: Array.from(sec.querySelectorAll(".exercise-card")).map(c => ({
                            name: c.querySelector(".ex-title").innerText,
                            values: Array.from(c.querySelectorAll(".series-grid:not(.header-grid)")).map(r => {
                                const i = r.querySelectorAll("input");
                                return { kg: i[0].value, reps: i[1].value, rpe: i[2].value };
                            })
                        }))
                    }))
                };
            }
        },

        // --- M√ìDULO DE TEMPO (TIMER) ---
        Timer: {
            timeLeft: 60, base: 60, interval: null, running: false,
            audio: new (window.AudioContext || window.webkitAudioContext)(),

            set(s, btn) {
                if(this.running) return;
                this.timeLeft = this.base = s;
                this.updateUI();
                document.querySelectorAll(".btn-t").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
            },

            updateUI() {
                const m = Math.floor(this.timeLeft / 60);
                const s = this.timeLeft % 60;
                document.getElementById("timerDisplay").innerText = `${m}:${s < 10 ? "0" : ""}${s}`;
            },

            toggle() {
                if(this.audio.state === 'suspended') this.audio.resume();
                const btn = document.getElementById("ctrlBtn");
                if(this.running) {
                    clearInterval(this.interval); this.running = false;
                    btn.innerText = "CONTINUAR";
                } else {
                    this.running = true; btn.innerText = "PAUSAR";
                    this.interval = setInterval(() => {
                        if(this.timeLeft > 0) { this.timeLeft--; this.updateUI(); }
                        else { 
                            clearInterval(this.interval); this.running = false;
                            this.beep(); btn.innerText = "INICIAR"; 
                            this.timeLeft = this.base; this.updateUI(); 
                        }
                    }, 1000);
                }
            },

            reset() { clearInterval(this.interval); this.running = false; this.timeLeft = this.base; this.updateUI(); document.getElementById("ctrlBtn").innerText = "INICIAR"; },

            beep() {
                const o = this.audio.createOscillator();
                const g = this.audio.createGain();
                o.connect(g); g.connect(this.audio.destination);
                o.frequency.value = 880; g.gain.value = 0.1;
                o.start(); o.stop(this.audio.currentTime + 0.5);
            }
        },

        // --- M√ìDULO DE BIBLIOTECA ---
        Library: {
            open(isNew, id = null) {
                TitanApp.Data.isAdding = isNew;
                TitanApp.Data.currentExId = id;
                const cont = document.getElementById("libContent");
                cont.innerHTML = "";
                for (let cat in TitanApp.Data.biblioteca) {
                    cont.innerHTML += `<div style="color:var(--blue); font-weight:bold; margin-top:15px; border-bottom:1px solid #333">${cat}</div>`;
                    TitanApp.Data.biblioteca[cat].forEach(ex => {
                        const d = document.createElement("div");
                        d.className = "lib-item";
                        d.innerText = ex;
                        d.onclick = () => {
                            if(TitanApp.Data.isAdding) TitanApp.Workout.createCard(ex, document.querySelector(".section.active").id);
                            else { 
                                const el = document.getElementById(TitanApp.Data.currentExId);
                                el.querySelector(".ex-title").innerText = ex;
                            }
                            document.getElementById("modalLib").close();
                            TitanApp.Storage.autoSave();
                        };
                        cont.appendChild(d);
                    });
                }
                document.getElementById("modalLib").showModal();
            }
        },

        // --- M√ìDULO DE ESTAT√çSTICAS ---
        Stats: {
            buildPRs() {
                TitanApp.Data.prMap.clear();
                const hist = JSON.parse(localStorage.getItem(TitanApp.Config.historyKey) || "[]");
                hist.forEach(s => {
                    s.state.sections.forEach(sec => {
                        sec.cards.forEach(c => {
                            c.values.forEach(v => {
                                const rm = parseFloat(v.kg) * (1 + parseFloat(v.reps)/30);
                                if(rm > (TitanApp.Data.prMap.get(c.name) || 0)) TitanApp.Data.prMap.set(c.name, rm);
                            });
                        });
                    });
                });
            },

            showChart() {
                const hist = JSON.parse(localStorage.getItem(TitanApp.Config.historyKey) || "[]").reverse();
                if(!hist.length) return alert("Sem dados!");
                
                const diag = document.createElement("dialog");
                diag.style.width = "95%"; diag.style.background = "#0b1220";
                const canvas = document.createElement("canvas");
                diag.appendChild(canvas);
                const btn = document.createElement("button");
                btn.innerText = "FECHAR"; btn.className = "btn"; btn.onclick = () => diag.close();
                diag.appendChild(btn);
                document.body.appendChild(diag);
                diag.showModal();

                new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: hist.map(h => new Date(h.date).toLocaleDateString()),
                        datasets: [{
                            label: 'Volume de Treino (kg)',
                            data: hist.map(h => h.state.sections.reduce((acc, s) => acc + s.cards.reduce((ac, c) => ac + c.values.reduce((a, v) => a + (v.kg*v.reps), 0), 0), 0)),
                            borderColor: '#3182ce', tension: 0.3
                        }]
                    },
                    options: { scales: { y: { beginAtZero: false } } }
                });
            }
        }
      };

      // --- BOOTSTRAP ---
      window.tab = (i) => {
        document.querySelectorAll(".section, .pill").forEach(el => el.classList.remove("active"));
        document.getElementById(`sec${i}`).classList.add("active");
        document.getElementById(`p${i}`).classList.add("active");
      };

      window.onload = () => {
        document.getElementById("displayDate").innerText = new Date().toLocaleDateString();
        TitanApp.Stats.buildPRs();
        
        const draft = localStorage.getItem(TitanApp.Config.draftKey);
        if(draft) {
            const st = JSON.parse(draft);
            document.getElementById("obj").value = st.obj;
            st.sections.forEach((s, i) => {
                const nav = document.getElementById("nav");
                nav.innerHTML += `<div class="pill ${i===0?'active':''}" id="p${i}" onclick="tab(${i})">${s.treinoKey}</div>`;
                const sec = document.createElement("div");
                sec.id = `sec${i}`; sec.className = `section ${i===0?'active':''}`;
                sec.setAttribute("data-treino-key", s.treinoKey);
                document.getElementById("container").appendChild(sec);
                s.cards.forEach(c => TitanApp.Workout.createCard(c.name, sec.id, c.values.length, c.values));
            });
        }
      };
    </script>
  </body>
</html>
