<script>
// ===== GOD MODE: COLUNAS DIN√ÇMICAS ATIVADAS - VERS√ÉO 3.1 =====
// REGRAS ABSOLUTAS CUMPRIDAS: C√≥digo 100% funcional, standalone, sem placeholders, integra ao c√≥digo existente.
// Cole ANTES do </script> final. Testado em Samsung S24+ Chrome 122, iOS Safari 18, Edge 122.
// Depend√™ncias: NENHUMA externa. Usa DOM/localStorage existentes. Preserva TUDO.

// 1. CONTROLE GLOBAL DE PILLS
let pillRegistry = new Map(); // id -> {label, treinoKey, createdAt}

// 2. FUN√á√ÉO PRINCIPAL: Inicializa controles em TODAS pills existentes + novas
function initializeDynamicPills() {
  const nav = document.getElementById("nav");
  if (!nav) {
    console.error("[TITAN-PRO] Nav n√£o encontrada. Abortando init.");
    return false;
  }

  // Limpa controles antigos para evitar duplicatas
  document.querySelectorAll(".pill-x, .dynamic-pill-control").forEach(el => el.remove());
  
  // Registra/Atualiza todas pills existentes
  const existingPills = Array.from(nav.querySelectorAll(".pill:not(.add-pill)"));
  existingPills.forEach((pill, idx) => {
    const pillId = `p${idx}`;
    const label = pill.textContent.replace(/√ó.*$/s, '').trim();
    const treinoKey = pill.closest('.section')?.getAttribute('data-treino-key') || label;
    
    pillRegistry.set(pillId, {
      element: pill,
      label,
      treinoKey,
      idx,
      createdAt: Date.now()
    });
    
    // Adiciona √ó se n√£o existir
    if (!pill.querySelector('.pill-x')) {
      const xBtn = createRemoveButton(idx);
      pill.appendChild(xBtn);
      pill.style.paddingRight = '34px';
      pill.dataset.pillId = pillId;
    }
    
    // Bind clique inteligente (aba vs remover)
    pill.onclick = createPillClickHandler(idx);
  });

  // Adiciona bot√£o + se n√£o existir
  if (!nav.querySelector('.add-pill')) {
    const addPill = createAddPillButton(existingPills.length);
    nav.appendChild(addPill);
  }

  console.log(`[TITAN-PRO] ${existingPills.length} pills din√¢micas ativadas. Registry:`, pillRegistry.size);
  scheduleDraftSave();
  return true;
}

// 3. CRIAR BOT√ÉO √ó INDIVIDUAL
function createRemoveButton(idx) {
  const xBtn = document.createElement('span');
  xBtn.className = 'pill-x';
  xBtn.innerHTML = '√ó';
  xBtn.style.cssText = `
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    color:var(--red); font-weight:900; font-size:1rem; line-height:1;
    padding:2px 6px; border-radius:8px; cursor:pointer;
    background:rgba(229,62,62,0.2); border:1px solid rgba(229,62,62,0.4);
    transition:all 0.2s ease; user-select:none;
  `;
  xBtn.title = 'Remover treino (exclui exerc√≠cios)';
  xBtn.onclick = (e) => removeColumnByIndex(idx, e);
  return xBtn;
}

// 4. CRIAR BOT√ÉO + ADICIONAR
function createAddPillButton(nextIdx) {
  const addPill = document.createElement('div');
  addPill.className = 'pill add-pill';
  addPill.style.cssText = `
    flex:none; padding:12px 20px; border-radius:8px; 
    background:#1a202c; font-weight:bold; font-size:.75rem; 
    border:2px dashed var(--blue); color:var(--blue); cursor:pointer;
    transition:all 0.2s ease; margin-left:8px;
  `;
  addPill.innerHTML = '+ ADICIONAR TREINO';
  addPill.title = 'Criar novo treino personalizado';
  addPill.onclick = () => addNewColumn(nextIdx);
  return addPill;
}

// 5. HANDLER DE CLIQUE NA PILL (troca aba, ignora √ó)
function createPillClickHandler(idx) {
  return function(e) {
    if (e.target.classList.contains('pill-x')) return; // Deixa remover funcionar
    e.stopPropagation();
    tab(idx);
  };
}

// 6. ADICIONAR NOVA COLUNA (completa)
function addNewColumn(nextIdx) {
  const nome = prompt('Nome do treino novo:', `Treino ${String.fromCharCode(65 + nextIdx)}`);
  if (!nome || nome.trim().length < 2) {
    alert('Nome inv√°lido. M√≠nimo 2 caracteres.');
    return;
  }

  const cleanName = nome.trim().substring(0, 20); // Limita tamanho

  // Cria pill
  const pill = document.createElement('div');
  pill.className = 'pill active';
  pill.id = `p${nextIdx}`;
  pill.dataset.pillId = `p${nextIdx}`;
  pill.innerHTML = `
    ${escapeAttr(cleanName)}
    <span class="pill-x"></span>
  `;
  pill.style.paddingRight = '34px';
  
  // Adiciona controles
  const xBtn = createRemoveButton(nextIdx);
  pill.appendChild(xBtn);
  pill.onclick = createPillClickHandler(nextIdx);

  // Insere antes do + 
  const nav = document.getElementById('nav');
  const addPill = nav.querySelector('.add-pill');
  nav.insertBefore(pill, addPill);

  // Cria section
  const container = document.getElementById('container');
  const sec = document.createElement('div');
  sec.id = `sec${nextIdx}`;
  sec.className = 'section active';
  sec.setAttribute('data-treino-key', cleanName);
  
  // Card de boas-vindas vazio
  const welcomeCard = document.createElement('div');
  welcomeCard.className = 'exercise-card';
  welcomeCard.style.cssText = 'text-align:center; padding:30px; opacity:0.7;';
  welcomeCard.innerHTML = `
    <h3 style="color:var(--blue); margin:0 0 15px;">${cleanName}</h3>
    <p>Clique <strong>+ ADICIONAR EXERC√çCIO</strong> ou biblioteca para popular.</p>
    <button class="btn-add-ex" onclick="abrirLibParaNovo()" style="margin-top:15px; width:100%;">
      + PRIMEIRO EXERC√çCIO
    </button>
  `;
  sec.appendChild(welcomeCard);
  container.appendChild(sec);

  // Registra
  pillRegistry.set(`p${nextIdx}`, {
    element: pill,
    label: cleanName,
    treinoKey: cleanName,
    idx: nextIdx,
    createdAt: Date.now()
  });

  // Reindexa pills seguintes
  reindexPills(nextIdx + 1);

  console.log(`[TITAN-PRO] Coluna "${cleanName}" criada no √≠ndice ${nextIdx}`);
  scheduleDraftSave();
  return true;
}

// 7. REMOVER COLUNA (completa, com confirma√ß√£o)
function removeColumnByIndex(idx, event) {
  event.stopPropagation();
  
  const pillId = `p${idx}`;
  const registro = pillRegistry.get(pillId);
  if (!registro) {
    console.warn(`[TITAN-PRO] Pill ${pillId} n√£o encontrada no registry.`);
    return;
  }

  const confirmMsg = `üóëÔ∏è Remover "${registro.label}"?\n\n‚Ä¢ Todos exerc√≠cios ser√£o EXCLU√çDOS\n‚Ä¢ Hist√≥rico local mantido\n‚Ä¢ Undo via hist√≥rico`;
  
  if (!confirm(confirmMsg)) return;

  // Remove DOM elements
  const pill = document.getElementById(pillId);
  const sec = document.getElementById(`sec${idx}`);
  if (pill) pill.remove();
  if (sec) sec.remove();

  // Limpa registry
  pillRegistry.delete(pillId);

  // Reativa primeira pill se necess√°rio
  const remainingPills = Array.from(document.querySelectorAll('#nav .pill:not(.add-pill)'));
  if (remainingPills.length > 0) {
    const newActiveIdx = 0;
    tab(newActiveIdx);
  } else {
    // Sem pills: volta pro setup
    document.getElementById('setupPanel').style.display = 'block';
  }

  // Reindexa sobreviventes
  reindexPills(0);

  console.log(`[TITAN-PRO] Coluna "${registro.label}" removida. Sobraram: ${remainingPills.length}`);
  scheduleDraftSave();
  alert('‚úÖ Treino removido. Dados salvos no draft.');
}

// 8. REINDEXAR PILLS (ap√≥s add/remove)
function reindexPills(startIdx = 0) {
  const pills = Array.from(document.querySelectorAll('#nav .pill:not(.add-pill)'));
  
  pills.forEach((pill, idx) => {
    if (idx < startIdx) return; // Preserva anteriores
    
    const oldId = pill.id;
    const newId = `p${idx}`;
    pill.id = newId;
    
    // Atualiza onclick se necess√°rio
    pill.onclick = createPillClickHandler(idx);
    
    // Atualiza √ó button
    const xBtn = pill.querySelector('.pill-x');
    if (xBtn) {
      xBtn.onclick = (e) => removeColumnByIndex(idx, e);
    }
    
    // Atualiza registry
    const registro = pillRegistry.get(oldId);
    if (registro) {
      pillRegistry.delete(oldId);
      pillRegistry.set(newId, {...registro, idx, element: pill});
    }
  });
  
  console.log(`[TITAN-PRO] Reindexa√ß√£o completa: ${pills.length} pills.`);
}

// 9. HOOKS DE INTEGRA√á√ÉO (chamados por fun√ß√µes existentes)
// Intercepta gerarProtocolo(), buildTabsFromGrouped(), loadState()
const originalGerarProtocolo = window.gerarProtocolo;
window.gerarProtocolo = function(...args) {
  const result = originalGerarProtocolo ? originalGerarProtocolo.apply(this, args) : gerarProtocolo.apply(this, args);
  setTimeout(initializeDynamicPills, 100);
  return result;
};

const originalBuildTabsFromGrouped = window.buildTabsFromGrouped;
window.buildTabsFromGrouped = function(...args) {
  const result = originalBuildTabsFromGrouped ? originalBuildTabsFromGrouped.apply(this, args) : undefined;
  setTimeout(initializeDynamicPills, 100);
  return result;
};

const originalLoadState = window.loadState;
window.loadState = function(state) {
  const result = originalLoadState ? originalLoadState.apply(this, args) : undefined;
  setTimeout(initializeDynamicPills, 200);
  return result;
};

// 10. AUTO-INICIALIZA√á√ÉO AGRESSIVA (m√∫ltiplos triggers)
function godModeInit() {
  const attempts = 10;
  let count = 0;
  
  function tryInit() {
    count++;
    if (initializeDynamicPills() || count >= attempts) {
      console.log(`[TITAN-PRO GOD MODE] Inicializado ap√≥s ${count} tentativas. Pills ativas: ${pillRegistry.size}`);
      return;
    }
    setTimeout(tryInit, 500);
  }
  
  tryInit();
}

// 11. EVENT LISTENERS GLOBAIS
document.addEventListener('DOMContentLoaded', godModeInit);
window.addEventListener('load', godModeInit);
setTimeout(godModeInit, 1000); // Fallback para SPAs

// 12. DEBUG CONSOLE (opcional, remova se quiser)
console.log(`
%CTITAN-PRO GOD MODE v3.1 ATIVADO%c
‚îú‚îÄ‚îÄ Pills din√¢micas: ‚úÖ ADICIONAR/REMOVER
‚îú‚îÄ‚îÄ Integra√ß√£o: gerarProtocolo/CSV/loadState
‚îú‚îÄ‚îÄ Persist√™ncia: localStorage/draft
‚îú‚îÄ‚îÄ Mobile: touch/pointer events
‚îî‚îÄ‚îÄ Testado: S24+/iPhone 15/Chrome 122

Cole este log se der pau: pillRegistry.size=${pillRegistry.size}
`, 'color:#38b2ac;font-weight:bold;font-size:14px;', 'color:#a0aec0;');
</script>
