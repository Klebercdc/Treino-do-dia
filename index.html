<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Clean Layout</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <link rel="icon" href="Logo.png" type="image/png" />

    <style>
      :root { --bg:#0b1220; --card:#161e2e; --blue:#3182ce; --text:#f7fafc; --orange:#f6ad55; --green:#38b2ac; --red:#e53e3e; }
      body { background:var(--bg); color:var(--text); font-family:-apple-system,sans-serif; margin:0; padding-bottom:20px; user-select:none; -webkit-user-select:none; -webkit-tap-highlight-color: transparent; }

      /* HEADER */
      .top-header { padding:15px; background:var(--card); border-bottom:1px solid #2d3748; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; }
      .date-badge { font-size:.8rem; color:var(--orange); font-weight:bold; background:#0b1220; padding:4px 10px; border-radius:15px; }
      .header-left { display:flex; align-items:center; gap:12px; }
      .logo-img { height:45px; width:auto; object-fit:contain; filter:drop-shadow(0 0 8px rgba(49,130,206,.6)); }

      /* TIMER */
      .timer-area { background:#1a202c; padding:12px; border-bottom:2px solid var(--blue); text-align:center; }
      #timerDisplay { font-size:2.2rem; font-weight:800; color:var(--blue); font-family:monospace; margin-bottom:8px; font-variant-numeric: tabular-nums; }
      .timer-btns { display:flex; gap:6px; justify-content:center; margin-bottom:5px; }
      .btn-t { background:#2d3748; color:#fff; border:none; padding:8px 12px; border-radius:8px; font-size:.75rem; cursor:pointer; font-weight:bold; }
      .btn-t.active { background:var(--blue); }
      .btn-ctrl { background:var(--green); color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; font-size:.8rem; }

      /* SETUP PANEL */
      .setup-panel { background:var(--card); padding:20px; border-bottom:3px solid var(--blue); display:block; }
      .field { margin-bottom:15px; }
      .field label { font-size:.7rem; color:#a0aec0; display:block; margin-bottom:5px; font-weight:bold; text-transform:uppercase; }
      .field select { width:100%; padding:12px; background:#0b1220; color:#fff; border:1px solid var(--blue); border-radius:8px; font-weight:bold; }

      /* TABS / PILLS */
      .nav-pills { display:flex; gap:8px; padding:10px; background:var(--bg); overflow-x:auto; border-bottom:1px solid #2d3748; }
      .pill { flex:none; padding:12px 20px; border-radius:8px; background:#1a202c; font-weight:bold; font-size:.75rem; border:1px solid #2d3748; cursor:pointer; color:#a0aec0; position:relative; transition: transform 0.1s; }
      .pill:active { transform: scale(0.95); }
      .pill.active { background:var(--blue); border-color:var(--blue); color:#fff; }
      .pill.add-pill { border:2px dashed var(--blue); color:var(--blue); background:#1a202c; }

      /* EXERCISES */
      .section { display:none; }
      .section.active { display:block; }
      .exercise-card { background:var(--card); border-radius:12px; padding:15px; margin:10px; border:1px solid #2d3748; animation:fadeIn .3s ease; position:relative; transition: background 0.2s; }
      
      .ex-title { font-weight:800; font-size:1.1rem; color:var(--blue); text-decoration:underline dotted; cursor:pointer; }
      .ex-target { font-size:.75rem; color:var(--orange); font-weight:bold; margin:4px 0 5px 0; display:block; }
      .rpe-suggest { display:block; font-size:0.7rem; color:var(--green); margin-bottom:10px; font-family:monospace; }

      .series-grid { display:grid; grid-template-columns:40px 1fr 1fr 1fr; gap:8px; align-items:center; margin-bottom:8px; }
      .header-grid { text-align:center; font-size:.6rem; color:#718096; font-weight:bold; }
      .input-box { background:#0b1220; border:1px solid #2d3748; border-radius:6px; padding:8px 0; transition: border-color 0.3s ease; }
      .input-box.filled { border-color: var(--green); box-shadow: 0 0 5px rgba(56, 178, 172, 0.3); }
      .input-box input { background:transparent; border:none; color:#fff; width:100%; text-align:center; font-size:1.1rem; outline:none; font-weight:bold; }
      
      .btn-add-ex { background:#1a202c; color:var(--blue); border:2px dashed var(--blue); width:calc(100% - 20px); margin:15px 10px; padding:15px; border-radius:12px; font-weight:800; cursor:pointer; }

      /* FOOTER */
      .footer-actions { padding:20px 10px 40px 10px; display:flex; gap:12px; background:transparent; flex-wrap:wrap;}
      .btn { padding:15px; border-radius:10px; border:none; font-weight:800; cursor:pointer; flex:1; text-align:center; font-size:.75rem; text-transform:uppercase; min-width: 80px; }
      .btn-save { background:var(--green); color:#fff; box-shadow:0 4px 0 #2d8a84; flex:2; }
      .btn-config { background:#2d3748; color:var(--blue); border:1px solid var(--blue); }

      /* MODALS */
      dialog { background:#161e2e; color:#fff; border:1px solid var(--blue); border-radius:12px; width:90%; max-width:500px; padding:20px; }
      dialog::backdrop { background: rgba(0,0,0,0.8); }
      .lib-item { padding:12px; border-bottom:1px solid #2d3748; cursor:pointer; }
      
      #csvTextarea { width:100%; height:220px; padding:12px; background:#0b1220; border:1px solid var(--blue); border-radius:8px; color:#fff; font-family:monospace; font-size:.8rem; resize:none; margin-bottom:12px; outline:none; }
      .csv-buttons { display:flex; gap:8px; flex-wrap:wrap; }
      .csv-buttons button, .csv-buttons label { flex:1; padding:12px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; min-width:130px; text-align:center; font-size: 0.8rem; display:flex; align-items:center; justify-content:center;}
      .btn-import { background:var(--green); color:#fff; }
      .btn-cancel { background:#2d3748; color:var(--blue); }

      #histList { max-height:360px; overflow-y:auto; border:1px solid #2d3748; border-radius:10px; }
      .hist-item { padding:12px; border-bottom:1px solid #2d3748; cursor:pointer; }
      .hist-item strong { color:var(--orange); }
      .hist-actions { display:flex; gap:8px; margin-top:12px; }
      .hist-actions button { flex:1; padding:12px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; }

      #tplList { max-height:220px; overflow-y:auto; border:1px solid #2d3748; border-radius:10px; margin-top:10px; }
      .tpl-item { padding:10px 12px; border-bottom:1px solid #2d3748; cursor:pointer; }
      .tpl-item small { color:#a0aec0; display:block; margin-top:4px; font-size:.7rem; }
      .tpl-actions { display:flex; gap:8px; margin-top:10px; }
      
      @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to { opacity:1; transform:translateY(0);} }
    </style>
  </head>

  <body>
    <div class="top-header">
      <div class="header-left">
        <img src="Logo.png" alt="Logo" class="logo-img" onerror="this.style.display='none'" />
        <h1 style="margin:0; font-size:1.1rem; color:var(--blue);">TITAN <span style="color:#fff">PRO</span></h1>
      </div>
      <div class="date-badge" id="displayDate">--/--/--</div>
    </div>

    <div class="timer-area">
      <div id="timerDisplay">01:00</div>
      <div class="timer-btns">
        <button class="btn-t active" onclick="setT(60, this)">1m</button>
        <button class="btn-t" onclick="setT(120, this)">2m</button>
        <button class="btn-t" onclick="setT(180, this)">3m</button>
        <button class="btn-t" onclick="setT(300, this)">5m</button>
      </div>
      <div class="timer-btns">
        <button id="ctrlBtn" class="btn-ctrl" onclick="toggleT()">INICIAR</button>
        <button class="btn-ctrl" style="background:var(--red)" onclick="resetT()">ZERAR</button>
      </div>
    </div>

    <div class="setup-panel" id="setupPanel">
      <div class="field">
        <label>Frequ√™ncia Semanal</label>
        <select id="freq" onchange="gerarProtocolo()">
          <option value="2">2 Dias (Full Body)</option>
          <option value="3" selected>3 Dias (ABC)</option>
          <option value="4">4 Dias (Upper/Lower)</option>
          <option value="5">5 Dias (ABCDE)</option>
          <option value="6">6 Dias (PPL x2)</option>
        </select>
      </div>

      <div class="field">
        <label>Objetivo do Mesociclo</label>
        <select id="obj" onchange="gerarProtocolo()">
          <option value="hipertrofia">Hipertrofia (Foco Geral)</option>
          <option value="forca">For√ßa (Baixas Reps / Alta Carga)</option>
          <option value="resistencia">Resist√™ncia/RML (15+ Reps)</option>
        </select>
      </div>
      
      <button class="btn btn-config" onclick="limparApenasValores()" style="width:100%; border:1px solid var(--red); color:var(--red); margin-top:10px;">‚ôªÔ∏è NOVA SEMANA (LIMPAR CARGAS)</button>
      
      <button class="btn btn-save" onclick="closeConfig()" style="margin-top:12px;">ABRIR TREINO</button>
    </div>

    <div class="nav-pills" id="nav"></div>
    <div style="font-size:0.6rem; color:#718096; text-align:center; padding:5px;">Segure um treino ou exerc√≠cio para excluir</div>
    
    <main id="container"></main>
    <button class="btn-add-ex" onclick="abrirLibParaNovo()">+ ADICIONAR EXERC√çCIO</button>

    <div class="footer-actions">
      <button class="btn btn-config" onclick="openConfig()">‚öôÔ∏è CONFIG</button>
      <button class="btn btn-config" onclick="showEvoChart()">üìà EVOLU√á√ÉO</button>
      <button class="btn btn-save" onclick="salvarTreino()">SALVAR SESS√ÉO</button>
      <button class="btn btn-config" onclick="abrirCSVModal()" style="flex:0.5; background:var(--orange); color:white;">üìä ARQUIVOS</button>
      <button class="btn btn-config" onclick="verHistorico()" style="flex:0.4">üìú HIST</button>
    </div>

    <dialog id="modalLib">
      <h3 id="libHeader" style="margin:0 0 15px 0; color:var(--orange)">Trocar Exerc√≠cio</h3>
      <div style="margin-bottom:15px; display:flex; gap:5px;">
        <input type="text" id="manualName" placeholder="Nome personalizado..." style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--blue); background:#0b1220; color:white; outline:none;">
        <button onclick="adicionarManual()" style="background:var(--blue); color:white; border:none; border-radius:8px; padding:0 15px; font-weight:bold;">+</button>
      </div>
      <div id="libContent" style="max-height:300px; overflow-y:auto;"></div>
      <button class="btn" onclick="document.getElementById('modalLib').close()" style="width:100%; margin-top:10px; background:#2d3748; color:white;">Fechar</button>
    </dialog>

    <dialog id="modalCSV">
      <h3 style="margin:0 0 15px 0; color:var(--orange)">Importar & Backup</h3>
      <textarea id="csvTextarea" placeholder="Cole o CSV ou use o bot√£o PDF..."></textarea>
      <div class="csv-buttons">
        <label class="btn-cancel" style="background:var(--blue); color:white;">üìÑ LER PDF<input type="file" id="pdfUpload" accept=".pdf" style="display:none" onchange="extrairTextoPDF(this)"></label>
        <button class="btn-import" onclick="importarCSV()">‚úì IMPORTAR</button>
        <button class="btn-config" onclick="fazerBackup()" style="background:#4a5568; color:white;">‚òÅÔ∏è BACKUP</button>
        <button class="btn-cancel" onclick="salvarModeloCSV()">üíæ SALVAR MOD</button>
        <button class="btn-cancel" onclick="mostrarModelosCSV()">üìö MODELOS</button>
        <button class="btn-cancel" onclick="document.getElementById('modalCSV').close()">‚úï FECHAR</button>
      </div>
      <div id="tplArea" style="display:none; margin-top:12px;">
        <div style="color:var(--orange); font-weight:bold; margin-bottom:8px;">Modelos salvos</div>
        <div id="tplList"></div>
        <div class="tpl-actions">
          <button class="btn-cancel" onclick="limparModelosCSV()">üóëÔ∏è LIMPAR MODELOS</button>
          <button class="btn-import" onclick="hideModelosCSV()">OK</button>
        </div>
      </div>
    </dialog>

    <dialog id="modalHIST">
      <h3 style="margin:0 0 15px 0; color:var(--orange)">Hist√≥rico de Sess√µes</h3>
      <div id="histList"></div>
      <div class="hist-actions">
        <button class="btn-cancel" onclick="limparHistorico()">üóëÔ∏è LIMPAR</button>
        <button class="btn-import" onclick="document.getElementById('modalHIST').close()">FECHAR</button>
      </div>
    </dialog>

    <script>
      /* =========================================
         1. CONSTANTES E CACHE (OTIMIZA√á√ÉO 10/10)
         ========================================= */
      const TREINOS_PRONTOS = {
        "3": {
            "hipertrofia": [
                { nome: "Treino A", exs: ["Supino Inclinado Halter", "Supino Reto Barra", "Desenvolvimento M√°quina", "Eleva√ß√£o Lateral", "Tr√≠ceps Corda", "Tr√≠ceps Testa"] },
                { nome: "Treino B", exs: ["Puxada Alta Aberta", "Remada Curvada", "Remada Baixa Tri√¢ngulo", "Face Pull", "Rosca Direta", "Rosca Scott"] },
                { nome: "Treino C", exs: ["Agachamento Livre", "Leg Press 45", "Cadeira Extensora", "Mesa Flexora", "Stiff Halter", "Panturrilha Sentado"] }
            ],
            "forca": [
                { nome: "Treino A", exs: ["Supino Reto (Foco Carga)", "Desenvolvimento Militar", "Supino Fechado", "Paralelas"] },
                { nome: "Treino B", exs: ["Levantamento Terra", "Remada Pendlay", "Barra Fixa (com peso)", "Rosca Martelo"] },
                { nome: "Treino C", exs: ["Agachamento Livre (Low Bar)", "Agachamento Frontal", "Stiff Barra", "Panturrilha em P√©"] }
            ],
            "resistencia": [
                { nome: "Treino A", exs: ["Agachamento Ta√ßa", "Flex√£o de Bra√ßo", "Remada Invertida", "Abdominal Supra", "Polichinelo"] },
                { nome: "Treino B", exs: ["Afundo", "Desenvolvimento Halter", "Puxada Alta", "Prancha", "Burpees"] },
                { nome: "Treino C", exs: ["Leg Press", "Supino M√°quina", "Rosca Direta", "Tr√≠ceps Banco", "Corrida Estacion√°ria"] }
            ]
        },
        "4": {
            "hipertrofia": [
                { nome: "Treino A", exs: ["Supino Inclinado", "Remada Curvada", "Voador", "Puxada Alta", "Eleva√ß√£o Lateral", "Rosca Direta"] },
                { nome: "Treino B", exs: ["Agachamento Livre", "Leg Press", "Extensora", "Passada", "Panturrilha em P√©"] },
                { nome: "Treino C", exs: ["Desenvolvimento", "Barra Fixa", "Eleva√ß√£o Lateral Polia", "Tr√≠ceps Corda", "Rosca Scott", "Face Pull"] },
                { nome: "Treino D", exs: ["Levantamento Terra", "Mesa Flexora", "Stiff", "Cadeira Abdutora", "Panturrilha Sentado"] }
            ],
            "forca": [
                { nome: "Treino A", exs: ["Supino Reto (Pausa)", "Supino Inclinado", "Desenvolvimento Militar", "Tr√≠ceps Testa"] },
                { nome: "Treino B", exs: ["Agachamento Livre", "Agachamento Pausado", "Extensora Unilateral", "Abdominal Roda"] },
                { nome: "Treino C", exs: ["Remada Curvada", "Barra Fixa (Carga)", "Remada Unilateral", "Rosca Martelo Pesada"] },
                { nome: "Treino D", exs: ["Levantamento Terra", "Stiff", "Leg Press Pesado", "Prancha com Peso"] }
            ]
        }
      };

      const STORAGE = Object.freeze({
        draftKey: "titanpro_draft_v6", 
        historyKey: "titanpro_history_v4",
        csvTplKey: "titanpro_csv_templates_v1",
        maxHistory: 80
      });

      const biblioteca = {
        "Peito": ["Supino Inclinado", "Supino Reto", "Crossover", "Voador", "Flex√£o", "Supino Halter"],
        "Costas": ["Puxada Alta", "Remada Curvada", "Remada Baixa", "Levantamento Terra", "Pulldown", "Barra Fixa"],
        "Pernas": ["Agachamento Livre", "Leg Press 45", "Extensora", "Mesa Flexora", "Stiff", "Passada", "Panturrilha"],
        "Ombros": ["Desenvolvimento", "Eleva√ß√£o Lateral", "Crucifixo Inverso", "Encolhimento", "Face Pull"],
        "Bra√ßos": ["Rosca Direta", "Tr√≠ceps Corda", "Rosca Martelo", "Tr√≠ceps Testa", "Rosca Scott", "Tr√≠ceps Franc√™s"]
      };

      // Cache para busca instant√¢nea de Recordes (PRs)
      let prMapCache = new Map();

      /* =========================================
         2. CORE: TIMER & UI
         ========================================= */
      function openConfig() { document.getElementById("setupPanel").style.display = "block"; }
      function closeConfig() { document.getElementById("setupPanel").style.display = "none"; }

      let timeLeft = 60, baseTime = 60, timerInt = null, isRunning = false;
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playBeep() { try { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.frequency.value = 880; gain.gain.value = 0.1; osc.start(); osc.stop(audioCtx.currentTime + 0.4); } catch (_) {} }
      function setT(s, btn) { if (isRunning) return; timeLeft = baseTime = s; updateT(); document.querySelectorAll(".btn-t").forEach(b => b.classList.remove("active")); btn.classList.add("active"); }
      function updateT() { const m = Math.floor(timeLeft / 60); const s = timeLeft % 60; document.getElementById("timerDisplay").innerText = `${m}:${s < 10 ? "0" : ""}${s}`; }
      function toggleT() { if (audioCtx.state === "suspended") { try { audioCtx.resume(); } catch (_) {} } const btn = document.getElementById("ctrlBtn"); if (isRunning) { clearInterval(timerInt); isRunning = false; btn.innerText = "CONTINUAR"; btn.style.background = "var(--green)"; } else { isRunning = true; btn.innerText = "PAUSAR"; btn.style.background = "var(--orange)"; timerInt = setInterval(() => { if (timeLeft > 0) { timeLeft--; updateT(); } else { clearInterval(timerInt); isRunning = false; playBeep(); setTimeout(playBeep, 600); btn.innerText = "INICIAR"; btn.style.background = "var(--green)"; timeLeft = baseTime; updateT(); } }, 1000); } }
      function resetT() { clearInterval(timerInt); isRunning = false; timeLeft = baseTime; updateT(); document.getElementById("ctrlBtn").innerText = "INICIAR"; document.getElementById("ctrlBtn").style.background = "var(--green)"; }

      /* =========================================
         3. GERA√á√ÉO E L√ìGICA DE EXERC√çCIOS
         ========================================= */
      let currentExId = null;
      let isAddingNew = false;
      let pressTimer = null;

      function addLongPressListener(el, callback) {
        const start = (e) => {
          if(e.target.tagName === 'INPUT') return;
          pressTimer = setTimeout(() => {
             el.setAttribute("data-long-pressed", "true");
             callback();
          }, 800); 
        };
        const end = () => { clearTimeout(pressTimer); };
        el.addEventListener("mousedown", start);
        el.addEventListener("touchstart", start, {passive: true});
        el.addEventListener("mouseup", end);
        el.addEventListener("touchend", end);
      }

      function gerarProtocolo() {
        const f = document.getElementById("freq").value;
        const obj = document.getElementById("obj").value;
        const nav = document.getElementById("nav");
        const cont = document.getElementById("container");
        
        nav.innerHTML = ""; 
        cont.innerHTML = "";

        let preset = TREINOS_PRONTOS[f]?.[obj] || TREINOS_PRONTOS[f]?.["hipertrofia"];

        if (preset) {
           preset.forEach((treino, i) => {
             const letra = String.fromCharCode(65 + i); 
             nav.innerHTML += `<div class="pill ${i === 0 ? "active" : ""}" id="p${i}" onclick="tabClick(${i}, this)">TREINO ${letra}</div>`;
             
             const sec = document.createElement("div");
             sec.id = `sec${i}`;
             sec.className = `section ${i === 0 ? "active" : ""}`;
             sec.setAttribute("data-treino-key", treino.nome);
             cont.appendChild(sec);
             treino.exs.forEach(exNome => { criarCard(exNome, sec.id); });
           });
        }
        addPillControls();
        scheduleDraftSave();
      }

      function criarCard(nome, sectionId, series = null, reps = null, rpe = null, values = null) {
        const o = document.getElementById("obj").value;
        const meta = reps || (o === "forca" ? "3-5 Reps" : (o === "hipertrofia" ? "6-15 Reps" : "15-20+ Reps"));
        const sets = series || (o === "forca" ? 3 : (o === "resistencia" ? 3 : 4));
        const id = "ex-" + Math.random().toString(36).substr(2, 7);

        const card = document.createElement("div");
        card.className = "exercise-card";
        card.setAttribute("data-ex-id", id);
        card.setAttribute("data-ex-name", nome);

        addLongPressListener(card, () => {
           if(confirm(`Excluir "${nome}"?`)) { card.remove(); scheduleDraftSave(); }
        });

        let rowsHtml = "";
        for(let s=0; s<sets; s++) {
          const v = values && values[s] ? values[s] : { kg: "", reps: "", rpe: "" };
          rowsHtml += `
            <div class="series-grid">
              <span style="font-size:0.7rem; color:#718096; text-align:center;">S${s + 1}</span>
              <div class="input-box ${v.kg && v.reps ? 'filled' : ''}"><input type="number" inputmode="decimal" value="${v.kg}" oninput="updateSuggests('${id}')" enterkeyhint="next"></div>
              <div class="input-box ${v.kg && v.reps ? 'filled' : ''}"><input type="number" inputmode="decimal" value="${v.reps}" oninput="updateSuggests('${id}')" enterkeyhint="next"></div>
              <div class="input-box"><input type="number" inputmode="decimal" placeholder="RPE" value="${v.rpe}" oninput="updateSuggests('${id}')" style="color:var(--orange)" enterkeyhint="done"></div>
            </div>`;
        }

        card.innerHTML = `
          <span class="ex-title" id="${id}" onclick="abrirLibParaTrocar('${id}')">${nome}</span>
          <span class="ex-target">${sets} Sets x ${meta}</span>
          <span class="rpe-suggest">1RM Est: <span id="1rm-${id}">-</span> | <span id="rpe-${id}">-</span></span>
          <div class="series-grid header-grid"><span>SET</span><span>KG</span><span>REPS</span><span>RPE</span></div>
          ${rowsHtml}
        `;

        document.getElementById(sectionId).appendChild(card);
        attachAutosaveToCard(card);
        updateSuggests(id);
      }

      function updateSuggests(id) {
        const card = document.querySelector(`[data-ex-id="${id}"]`);
        if (!card) return;
        const name = card.getAttribute("data-ex-name");
        const inputs = card.querySelectorAll("input");
        let maxRM = 0, currentRpe = 0;

        for (let i = 0; i < inputs.length; i += 3) {
           const kg = parseFloat(inputs[i].value) || 0;
           const reps = parseFloat(inputs[i+1].value) || 0;
           const rpe = parseFloat(inputs[i+2].value) || 0;
           
           if(kg > 0 && reps > 0) {
              inputs[i].parentElement.classList.add("filled");
              inputs[i+1].parentElement.classList.add("filled");
              const rm = kg * (1 + reps/30);
              if(rm > maxRM) { maxRM = rm; currentRpe = rpe; }
           } else {
              inputs[i].parentElement.classList.remove("filled");
              inputs[i+1].parentElement.classList.remove("filled");
           }
        }

        const elRM = document.getElementById(`1rm-${id}`);
        const elStat = document.getElementById(`rpe-${id}`);

        if (maxRM > 0) {
            const histMax = prMapCache.get(name) || 0;
            let icon = "";
            if (histMax > 0) {
                if (maxRM > histMax + 0.5) icon = " <span style='color:var(--green)'>‚ñ≤Pr</span>";
                else if (maxRM < histMax - 0.5) icon = " <span style='color:var(--red)'>‚ñº</span>";
                else icon = " <span style='color:#718096'>=</span>";
            }
            elRM.innerHTML = Math.round(maxRM) + "kg" + icon;
            elStat.textContent = currentRpe >= 9 ? "üî• Falha" : (currentRpe >= 7 ? "‚úÖ OK" : "Intensid?");
            elStat.style.color = currentRpe >= 7 ? "var(--green)" : "var(--orange)";
        }
      }

      // Constr√≥i o cache de Recordes para n√£o precisar ler o hist√≥rico toda hora
      function buildPRCache() {
          prMapCache.clear();
          const hist = JSON.parse(localStorage.getItem(STORAGE.historyKey) || "[]");
          hist.forEach(h => {
              h.state.sections.forEach(s => {
                  s.cards.forEach(c => {
                      let best = 0;
                      c.values.forEach(v => {
                          const k = parseFloat(v.kg)||0, r = parseFloat(v.reps)||0;
                          if(k>0 && r>0) { const rm = k * (1 + r/30); if(rm > best) best = rm; }
                      });
                      if(best > (prMapCache.get(c.name)||0)) prMapCache.set(c.name, best);
                  });
              });
          });
      }

      /* =========================================
         4. AUXILIARES E PERSIST√äNCIA
         ========================================= */
      function attachAutosaveToCard(card) { card.querySelectorAll("input").forEach(inp => { inp.addEventListener("input", scheduleDraftSave); }); }
      
      let draftSaveTimer = null;
      function scheduleDraftSave() { 
        if (draftSaveTimer) clearTimeout(draftSaveTimer); 
        draftSaveTimer = setTimeout(() => { localStorage.setItem(STORAGE.draftKey, JSON.stringify(serializeCurrentState())); }, 500); 
      }

      function serializeCurrentState() {
        const sections = Array.from(document.querySelectorAll("#container .section")).map(sec => ({
          treinoKey: sec.getAttribute("data-treino-key"),
          cards: Array.from(sec.querySelectorAll(".exercise-card")).map(card => ({
            name: card.getAttribute("data-ex-name"),
            values: Array.from(card.querySelectorAll(".series-grid")).slice(1).map(row => {
              const ins = row.querySelectorAll("input");
              return { kg: ins[0].value, reps: ins[1].value, rpe: ins[2].value };
            })
          }))
        }));
        return { freq: document.getElementById("freq").value, obj: document.getElementById("obj").value, sections, activeIdx: getActiveIdx() };
      }

      function loadState(st) {
        if(!st) return;
        document.getElementById("freq").value = st.freq;
        document.getElementById("obj").value = st.obj;
        const nav = document.getElementById("nav");
        const cont = document.getElementById("container");
        nav.innerHTML = ""; cont.innerHTML = "";
        
        st.sections.forEach((s, i) => {
            nav.innerHTML += `<div class="pill ${i === st.activeIdx ? "active" : ""}" id="p${i}" onclick="tabClick(${i}, this)">TREINO ${String.fromCharCode(65+i)}</div>`;
            const sec = document.createElement("div");
            sec.id = `sec${i}`;
            sec.className = `section ${i === st.activeIdx ? "active" : ""}`;
            sec.setAttribute("data-treino-key", s.treinoKey);
            cont.appendChild(sec);
            s.cards.forEach(c => criarCard(c.name, sec.id, c.values.length, null, null, c.values));
        });
        addPillControls();
      }

      function getActiveIdx() { 
        const active = document.querySelector(".pill.active");
        return active ? parseInt(active.id.replace("p", "")) : 0; 
      }

      function tabClick(idx, el) {
        if (el.getAttribute("data-long-pressed") === "true") { el.removeAttribute("data-long-pressed"); return; }
        document.querySelectorAll(".section, .pill").forEach(x => x.classList.remove("active"));
        document.getElementById(`sec${idx}`).classList.add("active");
        el.classList.add("active");
        scheduleDraftSave();
      }

      function salvarTreino() {
        const st = serializeCurrentState();
        const hist = JSON.parse(localStorage.getItem(STORAGE.historyKey) || "[]");
        hist.unshift({ createdAt: new Date().toISOString(), state: st });
        localStorage.setItem(STORAGE.historyKey, JSON.stringify(hist.slice(0, STORAGE.maxHistory)));
        buildPRCache();
        alert("‚úÖ Sess√£o Salva!");
      }

      function limparApenasValores() {
        if(!confirm("Zerar pesos para nova semana?")) return;
        document.querySelectorAll(".input-box input").forEach(i => { i.value = ""; i.parentElement.classList.remove("filled"); });
        scheduleDraftSave();
      }

      function verHistorico() {
        const hist = JSON.parse(localStorage.getItem(STORAGE.historyKey) || "[]");
        const list = document.getElementById("histList");
        list.innerHTML = hist.length ? "" : "<div class='hist-item'>Vazio</div>";
        hist.forEach(h => {
          const div = document.createElement("div");
          div.className = "hist-item";
          div.innerHTML = `<strong>${new Date(h.createdAt).toLocaleDateString()}</strong> - ${h.state.sections.length} Treinos`;
          div.onclick = () => { if(confirm("Carregar este treino?")) { loadState(h.state); document.getElementById("modalHIST").close(); } };
          list.appendChild(div);
        });
        document.getElementById("modalHIST").showModal();
      }

      // Fun√ß√µes de Modal e Biblioteca (Apenas repassando)
      function abrirLibParaNovo() { isAddingNew = true; mostrarLib(); }
      function abrirLibParaTrocar(id) { isAddingNew = false; currentExId = id; mostrarLib(); }
      function mostrarLib() { 
        const lib = document.getElementById("libContent"); lib.innerHTML = "";
        for (let cat in biblioteca) {
          lib.innerHTML += `<div style="color:var(--blue); font-weight:bold; margin-top:10px;">${cat}</div>`;
          biblioteca[cat].forEach(ex => {
            const item = document.createElement("div"); item.className="lib-item"; item.textContent = ex;
            item.onclick = () => { selecionar(ex); }; lib.appendChild(item);
          });
        }
        document.getElementById("modalLib").showModal();
      }
      function selecionar(n) { 
        if (isAddingNew) { const active = document.querySelector(".section.active"); if (active) criarCard(n, active.id); } 
        else { const el = document.getElementById(currentExId); el.innerText = n; el.closest(".exercise-card").setAttribute("data-ex-name", n); }
        document.getElementById("modalLib").close(); scheduleDraftSave();
      }
      function adicionarManual() { const v = document.getElementById("manualName").value; if(v) { selecionar(v); document.getElementById("manualName").value = ""; } }
      function addPillControls() {
        const nav = document.getElementById("nav");
        nav.querySelectorAll(".add-pill").forEach(x => x.remove());
        const add = document.createElement("div"); add.className="pill add-pill"; add.innerText="+"; 
        add.onclick = () => {
          const st = serializeCurrentState();
          st.sections.push({ treinoKey: "Novo", cards: [] });
          st.activeIdx = st.sections.length - 1;
          loadState(st);
        };
        nav.appendChild(add);
      }

      window.onload = () => {
        document.getElementById("displayDate").innerText = new Date().toLocaleDateString("pt-BR");
        buildPRCache();
        const saved = localStorage.getItem(STORAGE.draftKey);
        if(saved) loadState(JSON.parse(saved)); else gerarProtocolo();
        openConfig();
      };
    </script>
  </body>
</html>
