<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Smart Log</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>

    <link rel="icon" href="Logo.png" type="image/png" />

    <style>
      :root {
        --bg: #0b1220;
        --card: #161e2e;
        --blue: #3182ce;
        --text: #f7fafc;
        --orange: #f6ad55;
        --green: #38b2ac;
        --red: #e53e3e;
      }

      body {
        background: var(--bg);
        color: var(--text);
        font-family: -apple-system, sans-serif;
        margin: 0;
        padding-bottom: 20px;
      }

      .top-header {
        padding: 15px;
        background: var(--card);
        border-bottom: 1px solid #2d3748;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .date-badge {
        font-size: 0.8rem;
        color: var(--orange);
        font-weight: bold;
        background: #0b1220;
        padding: 4px 10px;
        border-radius: 15px;
      }

      /* Painel de Configura√ß√£o */
      .setup-panel {
        background: var(--card);
        padding: 20px;
        border-bottom: 3px solid var(--blue);
        display: block;
      }
      .field {
        margin-bottom: 15px;
      }
      .field label {
        font-size: 0.7rem;
        color: #a0aec0;
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .field select,
      .field input {
        width: 100%;
        padding: 12px;
        background: #0b1220;
        color: #fff;
        border: 1px solid var(--blue);
        border-radius: 8px;
        box-sizing: border-box;
      }

      .nav-pills {
        display: flex;
        gap: 8px;
        padding: 10px;
        background: var(--bg);
        overflow-x: auto;
        border-bottom: 1px solid #2d3748;
      }
      .pill {
        flex: none;
        padding: 12px 20px;
        border-radius: 8px;
        background: #1a202c;
        font-weight: bold;
        font-size: 0.75rem;
        border: 1px solid #2d3748;
        cursor: pointer;
        color: #a0aec0;
        position: relative;
      }
      .pill.active {
        background: var(--blue);
        border-color: var(--blue);
        color: #fff;
      }
      .pill.add-pill {
        border: 2px dashed var(--blue);
        color: var(--blue);
      }

      .section {
        display: none;
      }
      .section.active {
        display: block;
      }

      /* Exercise Card */
      .exercise-card {
        background: var(--card);
        border-radius: 12px;
        padding: 15px;
        margin: 10px;
        border: 1px solid #2d3748;
        animation: fadeIn 0.3s ease;
        position: relative;
      }
      .ex-title {
        font-weight: 800;
        font-size: 1.1rem;
        color: var(--blue);
        text-decoration: underline dotted;
        cursor: pointer;
      }
      .ex-target {
        font-size: 0.75rem;
        color: var(--orange);
        font-weight: bold;
        margin: 4px 0 5px 0;
        display: block;
        cursor: pointer;
      }

      /* e1RM por s√©rie */
      .rm-mini-badge {
        font-size: 0.6rem;
        color: var(--green);
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        display: block;
        margin-top: 2px;
        line-height: 1.1;
      }

      .series-grid {
        display: grid;
        grid-template-columns: 40px 1fr 1fr 1fr;
        gap: 8px;
        align-items: center;
        margin-bottom: 8px;
      }
      .header-grid {
        text-align: center;
        font-size: 0.6rem;
        color: #718096;
        font-weight: bold;
      }

      .input-box {
        background: #0b1220;
        border: 1px solid #2d3748;
        border-radius: 6px;
      }
      .input-box input {
        background: transparent;
        border: none;
        color: #fff;
        width: 100%;
        text-align: center;
        font-size: 1.1rem;
        padding: 8px 0;
        outline: none;
        font-weight: bold;
      }
      .input-box input::placeholder {
        color: rgba(255, 255, 255, 0.15);
      }

      /* Seletor RPE minimalista (1-10) */
      .input-box select {
        background: transparent;
        border: none;
        color: #fff;
        width: 100%;
        text-align: center;
        font-size: 1.05rem;
        padding: 8px 0;
        outline: none;
        font-weight: 800;
        appearance: none;
        -webkit-appearance: none;
      }
      .input-box select option {
        background: var(--bg);
        color: #fff;
      }

      .btn-add-ex {
        background: #1a202c;
        color: var(--blue);
        border: 2px dashed var(--blue);
        width: calc(100% - 20px);
        margin: 15px 10px;
        padding: 15px;
        border-radius: 12px;
        font-weight: 800;
        cursor: pointer;
      }

      .footer-actions {
        padding: 20px 10px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .btn {
        padding: 15px;
        border-radius: 10px;
        border: none;
        font-weight: 800;
        cursor: pointer;
        flex: 1;
        text-align: center;
        font-size: 0.75rem;
        text-transform: uppercase;
        min-width: 80px;
      }
      .btn-save {
        background: var(--green);
        color: #fff;
        box-shadow: 0 4px 0 #2d8a84;
      }
      .btn-config {
        background: #2d3748;
        color: var(--blue);
        border: 1px solid var(--blue);
      }
      .btn-ia {
        background: #1a202c;
        color: var(--orange);
        border: 1px solid var(--orange);
      }

      dialog {
        background: #161e2e;
        color: #fff;
        border: 1px solid var(--blue);
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        padding: 20px;
      }

      #csvTextarea {
        width: 100%;
        height: 200px;
        padding: 12px;
        background: #0b1220;
        border: 1px solid var(--blue);
        border-radius: 8px;
        color: #fff;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        resize: none;
        outline: none;
      }

      /* Hist√≥rico e Templates */
      #histList,
      #tplList {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #2d3748;
        border-radius: 10px;
      }
      .hist-item,
      .tpl-item {
        padding: 12px;
        border-bottom: 1px solid #2d3748;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body>
    <div class="top-header">
      <div class="header-left">
        <h1 style="margin: 0; font-size: 1.1rem; color: var(--blue)">
          TITAN <span style="color: #fff">PRO</span>
        </h1>
      </div>
      <div class="date-badge" id="displayDate">--/--/--</div>
    </div>

    <div class="setup-panel" id="setupPanel">
      <div class="field">
        <label>NVIDIA API KEY (Nemotron-70B)</label>
        <div style="display: flex; gap: 8px; align-items: center">
          <input
            type="password"
            id="apiKeyInput"
            placeholder="Cole aqui (fica s√≥ no seu navegador)"
            autocomplete="off"
            onchange="saveApiKey()"
            style="flex: 1; width: auto"
          />
          <button
            onclick="clearApiKey()"
            title="Apagar chave salva"
            style="
              flex: 0 0 auto;
              padding: 12px 14px;
              background: #2d3748;
              color: var(--red);
              border: 1px solid #2d3748;
              border-radius: 8px;
              font-weight: 800;
              cursor: pointer;
            "
          >
            LIMPAR
          </button>
        </div>
        <div id="apiKeyStatus" style="margin-top: 6px; font-size: 0.7rem; color: #a0aec0"></div>
      </div>

      <div class="field">
        <label>Frequ√™ncia Semanal</label>
        <select id="freq" onchange="gerarProtocolo()">
          <option value="2">2 Dias (Full Body)</option>
          <option value="3" selected>3 Dias (ABC)</option>
          <option value="4">4 Dias (Upper/Lower)</option>
          <option value="5">5 Dias (ABCDE)</option>
          <option value="6">6 Dias (PPL x2)</option>
        </select>
      </div>

      <div class="field">
        <label>Objetivo Principal</label>
        <select id="obj" onchange="gerarProtocolo()">
          <option value="hipertrofia">Hipertrofia (8-12 reps)</option>
          <option value="forca">For√ßa Bruta (3-5 reps)</option>
        </select>
      </div>

      <button class="btn btn-save" onclick="closeConfig()" style="margin-top: 12px">ABRIR TREINO</button>
    </div>

    <div class="nav-pills" id="nav"></div>
    <main id="container"></main>
    <button class="btn-add-ex" onclick="abrirLibParaNovo()">+ ADICIONAR EXERC√çCIO</button>

    <div class="footer-actions">
      <button class="btn btn-config" onclick="openConfig()">‚öôÔ∏è CONFIG</button>
      <button class="btn btn-ia" onclick="enviarParaIA()">ü§ñ IA ANALYST</button>
      <button class="btn btn-save" onclick="salvarTreino()">SALVAR SESS√ÉO</button>
      <button class="btn btn-config" onclick="abrirCSVModal()" style="background: var(--orange); color: white; flex: 0.5">
        üìä ARQUIVOS
      </button>
      <button class="btn btn-config" onclick="verHistorico()" style="flex: 0.4">üìú HIST</button>
    </div>

    <dialog id="modalLib">
      <h3 id="libHeader" style="margin: 0 0 15px 0; color: var(--orange)">Trocar Exerc√≠cio</h3>
      <div style="margin-bottom: 15px; display: flex; gap: 5px">
        <input
          type="text"
          id="manualName"
          placeholder="Nome personalizado..."
          style="
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--blue);
            background: #0b1220;
            color: white;
            outline: none;
          "
        />
        <button
          onclick="adicionarManual()"
          style="background: var(--blue); color: white; border: none; border-radius: 8px; padding: 0 15px; font-weight: bold"
        >
          +
        </button>
      </div>
      <div id="libContent" style="max-height: 300px; overflow-y: auto"></div>
      <button
        class="btn"
        onclick="document.getElementById('modalLib').close()"
        style="width: 100%; margin-top: 10px; background: #2d3748; color: white"
      >
        Fechar
      </button>
    </dialog>

    <dialog id="modalCSV">
      <h3 style="margin: 0 0 15px 0; color: var(--orange)">Arquivos e Fichas</h3>
      <div style="font-size: 0.7rem; color: #a0aec0; margin-bottom: 12px; line-height: 1.4">
        <strong>PDF:</strong> Use "LER PDF" para extrair texto da sua ficha.<br />
        <strong>CSV:</strong> Cole o texto ou salve modelos para uso r√°pido.
      </div>
      <textarea id="csvTextarea" placeholder="Cole o CSV aqui..."></textarea>
      <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px">
        <label
          class="btn"
          style="
            background: var(--blue);
            color: white;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
          "
        >
          üìÑ LER PDF
          <input type="file" id="pdfUpload" accept=".pdf" style="display: none" onchange="extrairTextoPDF(this)" />
        </label>
        <button class="btn" style="background: var(--green); color: white; flex: 1" onclick="importarCSV()">‚úì IMPORTAR</button>
        <button class="btn" style="background: #2d3748; color: var(--orange); flex: 1" onclick="salvarModeloCSV()">üíæ SALVAR MOD</button>
        <button class="btn" style="background: #2d3748; color: var(--blue); flex: 1" onclick="mostrarModelosCSV()">üìö MODELOS</button>
      </div>
      <div id="tplArea" style="display: none; margin-top: 12px">
        <div id="tplList"></div>
        <button class="btn" onclick="limparModelosCSV()" style="width: 100%; background: var(--red); color: white; margin-top: 5px">
          LIMPAR TUDO
        </button>
      </div>
      <button
        class="btn"
        onclick="document.getElementById('modalCSV').close()"
        style="width: 100%; margin-top: 10px; background: #2d3748; color: white"
      >
        Fechar
      </button>
    </dialog>

    <dialog id="modalHIST">
      <h3 style="margin: 0 0 15px 0; color: var(--orange)">Hist√≥rico de Sess√µes</h3>
      <div id="histList"></div>
      <div style="display: flex; gap: 8px; margin-top: 12px">
        <button class="btn" style="background: var(--red); color: white" onclick="limparHistorico()">üóëÔ∏è LIMPAR</button>
        <button class="btn" style="background: var(--blue); color: white" onclick="document.getElementById('modalHIST').close()">
          FECHAR
        </button>
      </div>
    </dialog>

    <dialog id="modalIA">
      <h3 style="margin: 0 0 12px 0; color: var(--orange)">Nemotron Analyst</h3>
      <pre
        id="iaOutput"
        style="
          white-space: pre-wrap;
          word-break: break-word;
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace;
          font-size: 0.85rem;
          background: #0b1220;
          padding: 12px;
          border-radius: 8px;
          border: 1px solid #2d3748;
          max-height: 55vh;
          overflow: auto;
          margin: 0;
        "
      ></pre>
      <button
        class="btn"
        onclick="document.getElementById('modalIA').close()"
        style="width: 100%; margin-top: 10px; background: #2d3748; color: white"
      >
        Fechar
      </button>
    </dialog>

    <script>
      // =========================
      // STORAGE / CONFIG
      // =========================
      const STORAGE = Object.freeze({
        draftKey: "titanpro_draft_v2",
        historyKey: "titanpro_history_v2",
        csvTplKey: "titanpro_csv_templates_v1",
        prevKey: "titanpro_prev_v1",
        apiKey: "titanpro_nvidia_key",
        maxHistory: 80,
      });

      // NVIDIA (endpoint + modelo)
      // Endpoint /v1/chat/completions e modelo "nvidia/llama-3.1-nemotron-70b-instruct" conforme docs atuais.
      const NVIDIA = Object.freeze({
        endpoint: "https://integrate.api.nvidia.com/v1/chat/completions",
        model: "nvidia/llama-3.1-nemotron-70b-instruct",
      });

      function saveApiKey() {
        const input = document.getElementById("apiKeyInput");
        const raw = (input?.value || "").trim();
        if (!raw) {
          localStorage.removeItem(STORAGE.apiKey);
        } else {
          localStorage.setItem(STORAGE.apiKey, raw);
          // Limpa o campo para n√£o ficar ‚Äúexposto‚Äù na tela
          input.value = "";
        }
        renderApiKeyStatus();
      }

      function clearApiKey() {
        const ok = confirm("Apagar a chave salva neste dispositivo?");
        if (!ok) return;
        localStorage.removeItem(STORAGE.apiKey);
        const input = document.getElementById("apiKeyInput");
        if (input) input.value = "";
        renderApiKeyStatus();
      }

      function renderApiKeyStatus() {
        const el = document.getElementById("apiKeyStatus");
        if (!el) return;
        const hasKey = !!localStorage.getItem(STORAGE.apiKey);
        el.textContent = hasKey ? "Chave salva neste dispositivo." : "Nenhuma chave salva.";
        el.style.color = hasKey ? "var(--green)" : "#a0aec0";
      }

      function getApiKey() {
        return localStorage.getItem(STORAGE.apiKey) || "";
      }

      // =========================
      // HELPERS (parsing / escape)
      // =========================
      function toNumber(value) {
        const s = String(value ?? "").trim().replace(",", ".");
        const n = Number(s);
        return Number.isFinite(n) ? n : NaN;
      }

      function clampNumber(n, min, max, fallback) {
        const v = Number(n);
        if (!Number.isFinite(v)) return fallback;
        return Math.min(max, Math.max(min, v));
      }

      function clampInt(value, min, max, fallback) {
        const n = Number.parseInt(String(value ?? ""), 10);
        if (!Number.isFinite(n)) return fallback;
        return Math.min(max, Math.max(min, n));
      }

      function escapeHtml(str) {
        return String(str ?? "").replace(/[&<>"']/g, (m) => {
          const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" };
          return map[m] || m;
        });
      }

      function escapeAttr(str) {
        return String(str ?? "").replace(/"/g, "&quot;");
      }

      // =========================
      // e1RM (Brzycki) + RPE/RIR
      // =========================
      // Regras:
      // e1RM = Peso / (1.0278 - (0.0278 * RepsEfetivas))
      // RepsEfetivas = Reps + RIR, onde RIR = (10 - RPE), se RPE < 10.
      function calcSetMetrics(peso, reps, rpe) {
        const weight = toNumber(peso);
        const r = toNumber(reps);
        const rpeClamped = clampInt(rpe, 1, 10, 10);

        if (!(weight > 0) || !(r > 0)) {
          return { rpe: rpeClamped, rir: null, repsEff: null, e1rm: 0 };
        }

        const rir = Math.max(0, 10 - rpeClamped);
        const repsEff = r + (rpeClamped < 10 ? rir : 0);

        const denom = 1.0278 - 0.0278 * repsEff;
        if (!(denom > 0)) {
          return { rpe: rpeClamped, rir, repsEff, e1rm: 0 };
        }

        const e1rm = weight / denom;
        return { rpe: rpeClamped, rir, repsEff, e1rm };
      }

      function renderRpeOptions(selected) {
        const sel = clampInt(selected, 1, 10, 10);
        let html = "";
        for (let v = 10; v >= 1; v--) {
          html += `<option value="${v}" ${v === sel ? "selected" : ""}>${v}</option>`;
        }
        return html;
      }

      // =========================
      // PDF EXTRACTION (seu fluxo)
      // =========================
      async function extrairTextoPDF(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const btn = input.parentElement;
        const originalTxt = btn.innerText;
        btn.innerText = "LENDO...";
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
          let fullText = "TREINO,EXERC√çCIO,S√âRIES,REPS\n";
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            fullText += content.items.map((item) => item.str).join(" ") + "\n";
          }
          document.getElementById("csvTextarea").value = fullText;
          alert("‚úÖ Texto extra√≠do! Ajuste se necess√°rio e clique em IMPORTAR.");
        } catch (err) {
          alert("‚ùå Erro ao ler PDF.");
        } finally {
          btn.innerText = originalTxt;
        }
      }

      // =========================
      // BIBLIOTECA (mantida)
      // =========================
      let prevMap = Object.create(null);
      const biblioteca = {
        Peito: ["Supino Inclinado", "Supino Reto", "Crossover", "Voador"],
        Costas: ["Puxada Alta", "Remada Curvada", "Remada Baixa", "Terra"],
        Pernas: ["Agachamento", "Leg Press 45", "Extensora", "Flexora", "Stiff", "Panturrilha"],
        Ombros: ["Desenvolvimento", "Eleva√ß√£o Lateral", "Crucifixo Inverso"],
        Bra√ßos: ["Rosca Direta", "Tr√≠ceps Corda", "Rosca Martelo", "Tr√≠ceps Testa"],
      };

      // =========================
      // CRIAR CARD (RPE SELECT + e1RM)
      // =========================
      function criarCard(nome, sectionId, series = 4, repsMeta = "8-12", values = null) {
        const id = "ex-" + Math.random().toString(36).slice(2, 9);
        const sec = document.getElementById(sectionId);
        const safeName = escapeHtml(nome);

        const card = document.createElement("div");
        card.className = "exercise-card";
        card.setAttribute("data-ex-id", id);
        card.setAttribute("data-ex-name", nome);

        let rowsHtml = "";
        for (let s = 0; s < series; s++) {
          const v = values && values[s] ? values[s] : { kg: "", reps: "", rpe: 10 };
          const rpeOptions = renderRpeOptions(v.rpe);

          rowsHtml += `
            <div class="series-grid">
              <div style="text-align:center">
                <span style="font-size:0.7rem; font-weight:bold; color:#718096">S${s + 1}</span>
                <span class="rm-mini-badge" id="rm-val-${id}-${s}">-</span>
              </div>

              <div class="input-box">
                <input
                  data-field="kg"
                  type="number"
                  inputmode="decimal"
                  placeholder="KG"
                  value="${escapeAttr(v.kg)}"
                  oninput="updateRowRM('${id}', ${s})"
                />
              </div>

              <div class="input-box">
                <input
                  data-field="reps"
                  type="number"
                  inputmode="numeric"
                  placeholder="REPS"
                  value="${escapeAttr(v.reps)}"
                  oninput="updateRowRM('${id}', ${s})"
                />
              </div>

              <div class="input-box">
                <select data-field="rpe" onchange="updateRowRM('${id}', ${s})" aria-label="RPE">
                  ${rpeOptions}
                </select>
              </div>
            </div>`;
        }

        card.innerHTML = `
          <span class="ex-title" onclick="abrirLibParaTrocar('${id}')">${safeName}</span>
          <span class="ex-target" onclick="confirmDeleteExercise(this)">${series} Sets x ${escapeHtml(repsMeta)} (Toque p/ Apagar)</span>
          <div class="series-grid header-grid"><span>SET/e1RM</span><span>KG</span><span>REPS</span><span>RPE</span></div>
          ${rowsHtml}
        `;

        sec.appendChild(card);

        // Calcula e1RM inicial (se houver valores)
        for (let s = 0; s < series; s++) updateRowRM(id, s);
      }

      function updateRowRM(exId, rowIdx) {
        const card = document.querySelector(`[data-ex-id="${exId}"]`);
        if (!card) return;

        const row = card.querySelectorAll(".series-grid:not(.header-grid)")[rowIdx];
        if (!row) return;

        const kg = row.querySelector('[data-field="kg"]')?.value ?? "";
        const reps = row.querySelector('[data-field="reps"]')?.value ?? "";
        const rpe = row.querySelector('[data-field="rpe"]')?.value ?? "10";

        const { e1rm } = calcSetMetrics(kg, reps, rpe);
        const display = document.getElementById(`rm-val-${exId}-${rowIdx}`);
        if (display) display.innerText = e1rm > 0 ? `e1RM ${Math.round(e1rm)}kg` : "-";

        scheduleDraftSave();
      }

      // =========================
      // DELETE (mantido)
      // =========================
      function bindPillDeleteHandlers() {
        const pills = document.querySelectorAll(".pill:not(.add-pill)");
        pills.forEach((pill, idx) => {
          pill.oncontextmenu = (e) => {
            e.preventDefault();
            if (confirm("Excluir este treino inteiro?")) excluirTreino(idx);
          };
        });
      }

      function excluirTreino(idx) {
        const st = serializeCurrentState();
        st.sections.splice(idx, 1);
        loadState(st);
      }

      function confirmDeleteExercise(el) {
        if (confirm("Deseja apagar este exerc√≠cio?")) {
          el.closest(".exercise-card").remove();
          scheduleDraftSave();
        }
      }

      // =========================
      // SERIALIZA√á√ÉO (inclui m√©tricas por set)
      // =========================
      function serializeCurrentState() {
        const sections = Array.from(document.querySelectorAll(".section")).map((sec) => ({
          treinoKey: sec.getAttribute("data-treino-key"),
          cards: Array.from(sec.querySelectorAll(".exercise-card")).map((card) => ({
            name: card.getAttribute("data-ex-name"),
            values: Array.from(card.querySelectorAll(".series-grid:not(.header-grid)")).map((row) => {
              const kg = row.querySelector('[data-field="kg"]')?.value ?? "";
              const reps = row.querySelector('[data-field="reps"]')?.value ?? "";
              const rpe = row.querySelector('[data-field="rpe"]')?.value ?? "10";
              const m = calcSetMetrics(kg, reps, rpe);
              return { kg, reps, rpe, rir: m.rir, repsEff: m.repsEff, e1rm: m.e1rm };
            }),
          })),
        }));

        return {
          sections,
          freq: document.getElementById("freq")?.value ?? "3",
          obj: document.getElementById("obj")?.value ?? "hipertrofia",
        };
      }

      function scheduleDraftSave() {
        localStorage.setItem(STORAGE.draftKey, JSON.stringify(serializeCurrentState()));
      }

      function salvarTreino() {
        const st = serializeCurrentState();
        const hist = JSON.parse(localStorage.getItem(STORAGE.historyKey) || "[]");
        hist.unshift({ date: new Date().toISOString(), state: st });
        localStorage.setItem(STORAGE.historyKey, JSON.stringify(hist.slice(0, STORAGE.maxHistory)));
        alert("Sess√£o Salva! Ghost Mode Ativado para o pr√≥ximo treino.");
        location.reload();
      }

      function loadState(st) {
        const cont = document.getElementById("container");
        const nav = document.getElementById("nav");
        cont.innerHTML = "";
        nav.innerHTML = "";

        st.sections.forEach((sec, i) => {
          nav.innerHTML += `<div class="pill ${i === 0 ? "active" : ""}" onclick="tab(${i})">${escapeHtml(sec.treinoKey)}</div>`;
          const div = document.createElement("div");
          div.id = `sec${i}`;
          div.className = `section ${i === 0 ? "active" : ""}`;
          div.setAttribute("data-treino-key", sec.treinoKey);
          cont.appendChild(div);

          sec.cards.forEach((c) => criarCard(c.name, div.id, c.values.length, "Meta", c.values));
        });

        bindPillDeleteHandlers();
        scheduleDraftSave();
      }

      function tab(idx) {
        document.querySelectorAll(".section, .pill").forEach((el) => el.classList.remove("active"));
        document.getElementById(`sec${idx}`).classList.add("active");
        document.querySelectorAll(".pill")[idx].classList.add("active");
      }

      function openConfig() {
        document.getElementById("setupPanel").style.display = "block";
        renderApiKeyStatus();
      }
      function closeConfig() {
        document.getElementById("setupPanel").style.display = "none";
      }

      function abrirCSVModal() {
        document.getElementById("modalCSV").showModal();
      }
      function verHistorico() {
        document.getElementById("modalHIST").showModal();
      }

      // =========================
      // BUILD JSON (Nemotron) + envio
      // =========================
      function buildWorkoutForNemotron() {
        const st = serializeCurrentState();

        const sections = st.sections.map((sec) => {
          const exercises = sec.cards.map((card) => {
            const sets = (card.values || []).map((set) => ({
              kg: toNumber(set.kg),
              reps: toNumber(set.reps),
              rpe: clampInt(set.rpe, 1, 10, 10),
              rir: set.rir ?? null,
              repsEff: set.repsEff ?? null,
              e1rm: set.e1rm ?? 0,
            }));

            const valid = sets.filter((s) => s.kg > 0 && s.reps > 0);
            const bestE1RM = valid.reduce((m, s) => Math.max(m, s.e1rm || 0), 0);
            const volume = valid.reduce((sum, s) => sum + s.kg * s.reps, 0);
            const avgRPE = valid.length ? valid.reduce((sum, s) => sum + (s.rpe || 0), 0) / valid.length : null;

            return {
              name: card.name,
              sets,
              bestE1RM: bestE1RM ? Math.round(bestE1RM * 10) / 10 : 0,
              volume: volume ? Math.round(volume) : 0,
              avgRPE: avgRPE ? Math.round(avgRPE * 10) / 10 : null,
            };
          });

          return { treinoKey: sec.treinoKey, exercises };
        });

        return {
          schema: "titanpro_session_v3",
          capturedAt: new Date().toISOString(),
          objetivo: st.obj,
          frequenciaSemanal: st.freq,
          sections,
        };
      }

      function buildNemotronPayload(workout) {
        return {
          model: NVIDIA.model,
          temperature: 0.2,
          max_tokens: 900,
          messages: [
            {
              role: "system",
              content:
                "Voc√™ √© um analista de treino focado em autorregula√ß√£o por RPE/RIR e e1RM (Brzycki). Responda em pt-BR. Entregue: (1) resumo por treino e exerc√≠cio; (2) melhores e1RM por exerc√≠cio; (3) ajustes de carga/reps para a pr√≥xima sess√£o com base em RPE; (4) alertas de excesso (ex.: queda de e1RM, RPE alto com carga menor). Seja objetivo e pr√°tico.",
            },
            { role: "user", content: JSON.stringify(workout) },
          ],
        };
      }

      function showNemotronOutput(text) {
        const out = document.getElementById("iaOutput");
        out.textContent = String(text || "(sem conte√∫do)");
        document.getElementById("modalIA").showModal();
      }

      async function enviarParaIA() {
        const key = getApiKey();
        if (!key) {
          alert("‚ö†Ô∏è Insira a NVIDIA API Key nas configura√ß√µes primeiro.");
          openConfig();
          return;
        }

        const workout = buildWorkoutForNemotron();
        const payload = buildNemotronPayload(workout);

        try {
          const res = await fetch(NVIDIA.endpoint, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${key}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          });

          const data = await res.json().catch(() => null);

          if (!res.ok) {
            const msg = data?.error?.message || `HTTP ${res.status}`;
            throw new Error(msg);
          }

          const content = data?.choices?.[0]?.message?.content;
          showNemotronOutput(content || JSON.stringify(data, null, 2));
        } catch (e) {
          showNemotronOutput(`Erro ao conectar: ${e?.message || "falha desconhecida"}`);
        }
      }

      // =========================
      // INIT / PROTOCOLO (mantido)
      // =========================
      window.onload = () => {
        document.getElementById("displayDate").innerText = new Date().toLocaleDateString("pt-BR");
        renderApiKeyStatus();

        const draft = localStorage.getItem(STORAGE.draftKey);
        if (draft) loadState(JSON.parse(draft));
        else gerarProtocolo();
      };

      function gerarProtocolo() {
        const f = Number(document.getElementById("freq").value || 3);
        const nav = document.getElementById("nav");
        const cont = document.getElementById("container");
        nav.innerHTML = "";
        cont.innerHTML = "";

        for (let i = 0; i < f; i++) {
          const label = "Treino " + String.fromCharCode(65 + i);
          nav.innerHTML += `<div class="pill ${i === 0 ? "active" : ""}" onclick="tab(${i})">${label}</div>`;
          const sec = document.createElement("div");
          sec.id = "sec" + i;
          sec.className = "section " + (i === 0 ? "active" : "");
          sec.setAttribute("data-treino-key", label);
          cont.appendChild(sec);
          criarCard("Supino Reto", sec.id);
        }

        bindPillDeleteHandlers();
        scheduleDraftSave();
      }

      // =========================
      // Placeholders do seu fluxo (mantidos)
      // =========================
      function importarCSV() {
        alert("Processando CSV...");
        document.getElementById("modalCSV").close();
      }
      function mostrarModelosCSV() {
        document.getElementById("tplArea").style.display = "block";
      }
      function abrirLibParaNovo() {
        document.getElementById("modalLib").showModal();
      }
      function abrirLibParaTrocar(id) {
        document.getElementById("modalLib").showModal();
      }

      // TODO: se voc√™ j√° tem essas fun√ß√µes em outro trecho, mantenha-as.
      function adicionarManual() {
        const name = (document.getElementById("manualName")?.value || "").trim();
        if (!name) return;
        const activeSec = document.querySelector(".section.active");
        if (!activeSec) return;
        criarCard(name, activeSec.id);
        document.getElementById("manualName").value = "";
        document.getElementById("modalLib").close();
        scheduleDraftSave();
      }

      function limparHistorico() {
        if (!confirm("Apagar todo o hist√≥rico?")) return;
        localStorage.removeItem(STORAGE.historyKey);
        document.getElementById("histList").innerHTML = "";
      }
    </script>
  </body>
</html>