<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0b1220" />
    <title>TITAN PRO - Smart Log</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <link rel="icon" href="Logo.png" type="image/png" />

    <style>
      :root { --bg:#0b1220; --card:#161e2e; --blue:#3182ce; --text:#f7fafc; --orange:#f6ad55; --green:#38b2ac; --red:#e53e3e; }
      body { background:var(--bg); color:var(--text); font-family:-apple-system,sans-serif; margin:0; padding-bottom:20px; }

      .top-header { padding:15px; background:var(--card); border-bottom:1px solid #2d3748; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; }
      .date-badge { font-size:.8rem; color:var(--orange); font-weight:bold; background:#0b1220; padding:4px 10px; border-radius:15px; }

      .header-left { display:flex; align-items:center; gap:12px; }
      .logo-img { height:45px; width:auto; object-fit:contain; filter:drop-shadow(0 0 8px rgba(49,130,206,.6)); }

      .timer-area { background:#1a202c; padding:12px; border-bottom:2px solid var(--blue); text-align:center; }
      #timerDisplay { font-size:2.2rem; font-weight:800; color:var(--blue); font-family:monospace; margin-bottom:8px; }
      .timer-btns { display:flex; gap:6px; justify-content:center; margin-bottom:5px; }
      .btn-t { background:#2d3748; color:#fff; border:none; padding:8px 12px; border-radius:8px; font-size:.75rem; cursor:pointer; font-weight:bold; }
      .btn-t.active { background:var(--blue); }
      .btn-ctrl { background:var(--green); color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; font-size:.8rem; }

      .setup-panel { background:var(--card); padding:20px; border-bottom:3px solid var(--blue); display:block; }
      .field { margin-bottom:15px; }
      .field label { font-size:.7rem; color:#a0aec0; display:block; margin-bottom:5px; font-weight:bold; text-transform:uppercase; }
      .field select { width:100%; padding:12px; background:#0b1220; color:#fff; border:1px solid var(--blue); border-radius:8px; font-weight:bold; }

      .nav-pills { display:flex; gap:8px; padding:10px; background:var(--bg); overflow-x:auto; border-bottom:1px solid #2d3748; }
      .pill { flex:none; padding:12px 20px; border-radius:8px; background:#1a202c; font-weight:bold; font-size:.75rem; border:1px solid #2d3748; cursor:pointer; color:#a0aec0; position:relative; padding-right:34px; }
      .pill.active { background:var(--blue); border-color:var(--blue); color:#fff; }

      .pill .pill-x {
        position:absolute; right:10px; top:50%; transform:translateY(-50%);
        color:var(--red); font-weight:900; font-size:1rem; line-height:1;
        padding:2px 6px; border-radius:8px; cursor:pointer;
      }

      .pill.add-pill {
        padding-right:20px;
        border:2px dashed var(--blue);
        color:var(--blue);
        background:#1a202c;
      }

      .section { display:none; }
      .section.active { display:block; }

      .exercise-card { background:var(--card); border-radius:12px; padding:15px; margin:10px; border:1px solid #2d3748; animation:fadeIn .3s ease; position:relative; }
      .ex-title { font-weight:800; font-size:1.1rem; color:var(--blue); text-decoration:underline dotted; cursor:pointer; }
      .ex-target { font-size:.75rem; color:var(--orange); font-weight:bold; margin:4px 0 5px 0; display:block; }
      .remove-ex { position:absolute; top:10px; right:10px; color:var(--red); font-size:1.2rem; cursor:pointer; font-weight:bold; padding:5px; }

      /* Estilo para sugest√£o RPE/1RM */
      .rpe-suggest { display:block; font-size:0.7rem; color:var(--green); margin-bottom:10px; font-family:monospace; }

      .series-grid { display:grid; grid-template-columns:40px 1fr 1fr 1fr; gap:8px; align-items:center; margin-bottom:8px; }
      .header-grid { text-align:center; font-size:.6rem; color:#718096; font-weight:bold; }
      .input-box { background:#0b1220; border:1px solid #2d3748; border-radius:6px; padding:8px 0; }
      .input-box input { background:transparent; border:none; color:#fff; width:100%; text-align:center; font-size:1.1rem; outline:none; font-weight:bold; }

      .btn-add-ex { background:#1a202c; color:var(--blue); border:2px dashed var(--blue); width:calc(100% - 20px); margin:15px 10px; padding:15px; border-radius:12px; font-weight:800; cursor:pointer; }

      .footer-actions { padding:20px 10px 40px 10px; display:flex; gap:12px; background:transparent; flex-wrap:wrap;}
      .btn { padding:15px; border-radius:10px; border:none; font-weight:800; cursor:pointer; flex:1; text-align:center; font-size:.75rem; text-transform:uppercase; min-width: 80px; }
      .btn-save { background:var(--green); color:#fff; box-shadow:0 4px 0 #2d8a84; flex:2; }
      .btn-config { background:#2d3748; color:var(--blue); border:1px solid var(--blue); }

      dialog { background:#161e2e; color:#fff; border:1px solid var(--blue); border-radius:12px; width:90%; max-width:500px; padding:20px; }
      .lib-item { padding:12px; border-bottom:1px solid #2d3748; cursor:pointer; }

      #csvTextarea { width:100%; height:220px; padding:12px; background:#0b1220; border:1px solid var(--blue); border-radius:8px; color:#fff; font-family:monospace; font-size:.8rem; resize:none; margin-bottom:12px; outline:none; }
      .csv-info { font-size:.7rem; color:#a0aec0; margin-bottom:12px; line-height:1.4; }
      .csv-buttons { display:flex; gap:8px; flex-wrap:wrap; }
      .csv-buttons button, .csv-buttons label { flex:1; padding:12px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; min-width:130px; text-align:center; font-size: 0.8rem; }
      .btn-import { background:var(--green); color:#fff; }
      .btn-cancel { background:#2d3748; color:var(--blue); }

      #histList { max-height:360px; overflow-y:auto; border:1px solid #2d3748; border-radius:10px; }
      .hist-item { padding:12px; border-bottom:1px solid #2d3748; cursor:pointer; }
      .hist-item strong { color:var(--orange); }
      .hist-actions { display:flex; gap:8px; margin-top:12px; }
      .hist-actions button { flex:1; padding:12px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; }

      #tplList { max-height:220px; overflow-y:auto; border:1px solid #2d3748; border-radius:10px; margin-top:10px; }
      .tpl-item { padding:10px 12px; border-bottom:1px solid #2d3748; cursor:pointer; }
      .tpl-item small { color:#a0aec0; display:block; margin-top:4px; font-size:.7rem; }
      .tpl-actions { display:flex; gap:8px; margin-top:10px; }
      .tpl-actions button { flex:1; padding:12px; border-radius:8px; border:none; font-weight:bold; cursor:pointer; }

      @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to { opacity:1; transform:translateY(0);} }
    </style>
  </head>

  <body>
    <div class="top-header">
      <div class="header-left">
        <img src="Logo.png" alt="Logo Le√£o Azul" class="logo-img" />
        <h1 style="margin:0; font-size:1.1rem; color:var(--blue);">TITAN <span style="color:#fff">PRO</span></h1>
      </div>
      <div class="date-badge" id="displayDate">--/--/--</div>
    </div>

    <div class="timer-area">
      <div id="timerDisplay">01:00</div>
      <div class="timer-btns">
        <button class="btn-t active" onclick="setT(60, this)">1m</button>
        <button class="btn-t" onclick="setT(120, this)">2m</button>
        <button class="btn-t" onclick="setT(180, this)">3m</button>
        <button class="btn-t" onclick="setT(300, this)">5m</button>
      </div>
      <div class="timer-btns">
        <button id="ctrlBtn" class="btn-ctrl" onclick="toggleT()">INICIAR</button>
        <button class="btn-ctrl" style="background:var(--red)" onclick="resetT()">ZERAR</button>
      </div>
    </div>

    <div class="setup-panel" id="setupPanel">
      <div class="field">
        <label>Frequ√™ncia Base</label>
        <select id="freq" onchange="gerarProtocolo()">
          <option value="2">2 Dias (Full Body)</option>
          <option value="3" selected>3 Dias (ABC)</option>
          <option value="4">4 Dias (Upper/Lower)</option>
          <option value="5">5 Dias (ABCDE)</option>
          <option value="6">6 Dias (PPL x2)</option>
        </select>
      </div>

      <div class="field">
        <label>Objetivo (Define Reps)</label>
        <select id="obj" onchange="gerarProtocolo()">
          <option value="hipertrofia">Hipertrofia (8-12 reps)</option>
          <option value="forca">For√ßa Bruta (3-5 reps)</option>
          <option value="definicao">Defini√ß√£o/RML (15-20 reps)</option>
        </select>
      </div>
      <button class="btn btn-save" onclick="closeConfig()" style="margin-top:12px;">ABRIR PLANILHA</button>
    </div>

    <div class="nav-pills" id="nav"></div>
    <main id="container"></main>
    <button class="btn-add-ex" onclick="abrirLibParaNovo()">+ ADICIONAR EXERC√çCIO</button>

    <div class="footer-actions">
      <button class="btn btn-config" onclick="openConfig()">‚öôÔ∏è CONFIG</button>
      <button class="btn btn-config" onclick="showEvoChart()">üìà EVOLU√á√ÉO</button>
      <button class="btn btn-save" onclick="salvarTreino()">SALVAR SESS√ÉO</button>
      <button class="btn btn-config" onclick="abrirCSVModal()" style="flex:0.5; background:var(--orange); color:white;">üìä CSV</button>
      <button class="btn btn-config" onclick="verHistorico()" style="flex:0.4">üìú HIST</button>
    </div>

    <dialog id="modalLib">
      <h3 id="libHeader" style="margin:0 0 15px 0; color:var(--orange)">Trocar Exerc√≠cio</h3>
      <div style="margin-bottom:15px; display:flex; gap:5px;">
        <input type="text" id="manualName" placeholder="Nome personalizado..." style="flex:1; padding:10px; border-radius:8px; border:1px solid var(--blue); background:#0b1220; color:white; outline:none;">
        <button onclick="adicionarManual()" style="background:var(--blue); color:white; border:none; border-radius:8px; padding:0 15px; font-weight:bold;">+</button>
      </div>
      <div id="libContent" style="max-height:300px; overflow-y:auto;"></div>
      <button class="btn" onclick="document.getElementById('modalLib').close()" style="width:100%; margin-top:10px; background:#2d3748; color:white;">Fechar</button>
    </dialog>

    <dialog id="modalCSV">
      <h3 style="margin:0 0 15px 0; color:var(--orange)">Importar Treino</h3>
      <div class="csv-info">
        <strong>Op√ß√£o 1:</strong> Cole o CSV do Excel/Sheets.<br />
        <strong>Op√ß√£o 2:</strong> Use o bot√£o "Ler PDF" para extrair texto de fichas.<br /><br />
        Formato CSV esperado: TREINO,EXERC√çCIO,S√âRIES,REPS...
      </div>

      <textarea id="csvTextarea" placeholder="Cole seu CSV aqui ou carregue um PDF..."></textarea>

      <div class="csv-buttons">
        <label class="btn-cancel" style="background:var(--blue); color:white; display:flex; align-items:center; justify-content:center;">
          üìÑ LER PDF
          <input type="file" id="pdfUpload" accept=".pdf" style="display:none" onchange="extrairTextoPDF(this)">
        </label>
        
        <button class="btn-import" onclick="importarCSV()">‚úì IMPORTAR</button>
        <button class="btn-cancel" onclick="salvarModeloCSV()">üíæ SALVAR MOD</button>
        <button class="btn-cancel" onclick="mostrarModelosCSV()">üìö MODELOS</button>
        <button class="btn-cancel" onclick="document.getElementById('modalCSV').close()">‚úï FECHAR</button>
      </div>

      <div id="tplArea" style="display:none; margin-top:12px;">
        <div style="color:var(--orange); font-weight:bold; margin-bottom:8px;">Modelos salvos</div>
        <div id="tplList"></div>
        <div class="tpl-actions">
          <button class="btn-cancel" onclick="limparModelosCSV()">üóëÔ∏è LIMPAR MODELOS</button>
          <button class="btn-import" onclick="hideModelosCSV()">OK</button>
        </div>
      </div>
    </dialog>

    <dialog id="modalHIST">
      <h3 style="margin:0 0 15px 0; color:var(--orange)">Hist√≥rico de Sess√µes</h3>
      <div id="histList"></div>
      <div class="hist-actions">
        <button class="btn-cancel" onclick="limparHistorico()">üóëÔ∏è LIMPAR</button>
        <button class="btn-import" onclick="document.getElementById('modalHIST').close()">FECHAR</button>
      </div>
    </dialog>

    <script>
      /* === CATALOGO DE TREINOS INTELIGENTES (2-6 DIAS) === */
      const TREINOS_PRONTOS = {
        // 2 DIAS: FULL BODY A/B (Ideal para frequ√™ncia)
        "2": [
            { nome: "A (Full Body Foco Agacho)", exs: ["Agachamento Livre", "Supino Reto", "Remada Curvada", "Desenvolvimento Halteres", "Panturrilha em P√©"] },
            { nome: "B (Full Body Foco Terra)", exs: ["Levantamento Terra", "Leg Press 45", "Puxada Alta", "Supino Inclinado", "Rosca Direta"] }
        ],
        // 3 DIAS: PUSH / PULL / LEGS (Cl√°ssico Moderno)
        "3": [
            { nome: "A (Push: Peito/Ombro/Tri)", exs: ["Supino Reto", "Supino Inclinado Halteres", "Desenvolvimento Militar", "Eleva√ß√£o Lateral", "Tr√≠ceps Corda", "Tr√≠ceps Testa"] },
            { nome: "B (Pull: Costas/B√≠ceps)", exs: ["Puxada Alta", "Remada Curvada", "Remada Baixa", "Crucifixo Inverso", "Rosca Direta", "Rosca Martelo"] },
            { nome: "C (Legs: Pernas Completo)", exs: ["Agachamento Livre", "Leg Press 45", "Cadeira Extensora", "Mesa Flexora", "Stiff", "Panturrilha Sentado"] }
        ],
        // 4 DIAS: UPPER / LOWER (Padr√£o Ouro)
        "4": [
            { nome: "A (Upper For√ßa)", exs: ["Supino Reto", "Remada Curvada", "Desenvolvimento Barra", "Barra Fixa (ou Graviton)"] },
            { nome: "B (Lower For√ßa)", exs: ["Agachamento Livre", "Leg Press 45", "Cadeira Extensora", "Panturrilha em P√©"] },
            { nome: "C (Upper Hipertrofia)", exs: ["Supino Inclinado Halteres", "Puxada Alta", "Eleva√ß√£o Lateral", "Voador/Peck Deck", "Rosca Direta", "Tr√≠ceps Corda"] },
            { nome: "D (Lower Posterior)", exs: ["Levantamento Terra (ou Stiff)", "Mesa Flexora", "Passada/Afundo", "Panturrilha Sentado"] }
        ],
        // 5 DIAS: ABCDE (Body Part Split - Est√©tica)
        "5": [
            { nome: "A (Peito)", exs: ["Supino Reto", "Supino Inclinado", "Crucifixo M√°quina", "Crossover Polia Alta", "Flex√£o de Bra√ßo"] },
            { nome: "B (Costas)", exs: ["Puxada Alta", "Remada Curvada", "Remada Serrote", "Pulldown", "Lombar/Hiperextens√£o"] },
            { nome: "C (Pernas)", exs: ["Agachamento", "Leg Press", "Extensora", "Flexora", "Stiff", "Panturrilha"] },
            { nome: "D (Ombros)", exs: ["Desenvolvimento", "Eleva√ß√£o Lateral", "Eleva√ß√£o Frontal", "Crucifixo Inverso", "Encolhimento"] },
            { nome: "E (Bra√ßos)", exs: ["Rosca Direta", "Tr√≠ceps Testa", "Rosca Scott", "Tr√≠ceps Corda", "Rosca Punho"] }
        ],
        // 6 DIAS: PPL x2 (Alta Frequ√™ncia/Volume)
        "6": [
            { nome: "A (Push 1)", exs: ["Supino Reto", "Desenvolvimento", "Tr√≠ceps Testa", "Eleva√ß√£o Lateral"] },
            { nome: "B (Pull 1)", exs: ["Puxada Alta", "Remada Curvada", "Rosca Direta", "Face Pull"] },
            { nome: "C (Legs 1)", exs: ["Agachamento", "Extensora", "Panturrilha em P√©"] },
            { nome: "D (Push 2)", exs: ["Supino Inclinado", "Crossover", "Tr√≠ceps Corda", "Eleva√ß√£o Lateral"] },
            { nome: "E (Pull 2)", exs: ["Remada Baixa", "Puxada Tri√¢ngulo", "Rosca Martelo", "Crucifixo Inverso"] },
            { nome: "F (Legs 2)", exs: ["Levantamento Terra", "Leg Press", "Mesa Flexora", "Panturrilha Sentado"] }
        ]
      };

      const STORAGE = Object.freeze({
        draftKey: "titanpro_draft_v2",
        historyKey: "titanpro_history_v2",
        csvTplKey: "titanpro_csv_templates_v1",
        maxHistory: 80,
        maxTemplates: 20
      });

      function openConfig() {
        const p = document.getElementById("setupPanel");
        if (p) p.style.display = "block";
      }
      function closeConfig() {
        const p = document.getElementById("setupPanel");
        if (p) p.style.display = "none";
      }

      /* ===== TIMER ===== */
      let timeLeft = 60, baseTime = 60, timerInt = null, isRunning = false;
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      function playBeep() {
        try {
          const osc = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          osc.connect(gain); gain.connect(audioCtx.destination);
          osc.frequency.value = 880; gain.gain.value = 0.1;
          osc.start(); osc.stop(audioCtx.currentTime + 0.4);
        } catch (_) {}
      }

      function setT(s, btn) {
        if (isRunning) return;
        timeLeft = baseTime = s; updateT();
        document.querySelectorAll(".btn-t").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      }

      function updateT() {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        document.getElementById("timerDisplay").innerText = `${m}:${s < 10 ? "0" : ""}${s}`;
      }

      function toggleT() {
        if (audioCtx.state === "suspended") { try { audioCtx.resume(); } catch (_) {} }
        const btn = document.getElementById("ctrlBtn");
        if (isRunning) {
          clearInterval(timerInt); isRunning = false;
          btn.innerText = "CONTINUAR"; btn.style.background = "var(--green)";
        } else {
          isRunning = true; btn.innerText = "PAUSAR"; btn.style.background = "var(--orange)";
          timerInt = setInterval(() => {
            if (timeLeft > 0) { timeLeft--; updateT(); }
            else {
              clearInterval(timerInt); isRunning = false;
              playBeep(); setTimeout(playBeep, 600);
              btn.innerText = "INICIAR"; btn.style.background = "var(--green)";
              timeLeft = baseTime; updateT();
            }
          }, 1000);
        }
      }

      function resetT() {
        clearInterval(timerInt); isRunning = false;
        timeLeft = baseTime; updateT();
        document.getElementById("ctrlBtn").innerText = "INICIAR";
        document.getElementById("ctrlBtn").style.background = "var(--green)";
      }

      /* ===== DADOS & UI ===== */
      const biblioteca = {
        "Peito": ["Supino Inclinado", "Supino Reto", "Crossover", "Voador", "Flex√£o"],
        "Costas": ["Puxada Alta", "Remada Curvada", "Remada Baixa", "Terra", "Pulldown"],
        "Pernas": ["Agachamento", "Leg Press 45", "Extensora", "Flexora", "Stiff", "Panturrilha"],
        "Ombros": ["Desenvolvimento", "Eleva√ß√£o Lateral", "Crucifixo Inverso", "Encolhimento"],
        "Bra√ßos": ["Rosca Direta", "Tr√≠ceps Corda", "Rosca Martelo", "Tr√≠ceps Testa", "Rosca Scott"]
      };

      let currentExId = null;
      let isAddingNew = false;

      function escapeAttr(v) {
        return String(v ?? "").replace(/&/g, "&amp;").replace(/"/g, "&quot;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

      function attachAutosaveToCard(card) {
        card.querySelectorAll("input").forEach(inp => {
          inp.addEventListener("input", scheduleDraftSave, { passive: true });
          inp.addEventListener("change", scheduleDraftSave, { passive: true });
        });
      }

      // Fun√ß√£o principal de cria√ß√£o dos cards de exerc√≠cio
      function criarCard(nome, sectionId, series = null, reps = null, rpe = null, values = null) {
        const o = document.getElementById("obj").value;
        const meta = reps || (o === "forca" ? "3-5 Reps" : (o === "hipertrofia" ? "8-12 Reps" : "15-20 Reps"));
        const sets = series || (o === "forca" ? 5 : (o === "definicao" ? 3 : 4));
        const id = "ex-" + Math.random().toString(36).substr(2, 7);

        const card = document.createElement("div");
        card.className = "exercise-card";
        card.setAttribute("data-ex-id", id);
        card.setAttribute("data-ex-name", nome);
        card.setAttribute("data-ex-sets", String(sets));
        card.setAttribute("data-ex-meta", meta);
        card.setAttribute("data-ex-rpehint", rpe || "");

        const rows = Array.from({ length: sets }, (_, s) => {
          const kgVal = values && values[s] ? (values[s].kg ?? "") : "";
          const repsVal = values && values[s] ? (values[s].reps ?? "") : "";
          const rpeVal = values && values[s] ? (values[s].rpe ?? "") : "";
          const placeholderRpe = (rpe || "");
          
          return `
            <div class="series-grid">
              <span style="font-size:0.7rem; color:#718096; text-align:center;">S${s + 1}</span>
              <div class="input-box"><input type="number" inputmode="decimal" value="${escapeAttr(kgVal)}" oninput="updateSuggests('${id}')"></div>
              <div class="input-box"><input type="number" value="${escapeAttr(repsVal)}" oninput="updateSuggests('${id}')"></div>
              <div class="input-box"><input type="number" placeholder="${escapeAttr(placeholderRpe)}" value="${escapeAttr(rpeVal)}"></div>
            </div>`;
        }).join("");

        // Estrutura com feedback de 1RM/RPE
        card.innerHTML = `
          <span class="remove-ex" onclick="this.parentElement.remove(); scheduleDraftSave();">√ó</span>
          <span class="ex-title" id="${id}" onclick="abrirLibParaTrocar('${id}')">${nome}</span>
          <span class="ex-target">${sets} Sets x ${meta}</span>
          <span class="rpe-suggest">1RM est: <span id="1rm-${id}">-</span> | <span id="rpe-${id}">-</span></span>
          <div class="series-grid header-grid"><span>SET</span><span>KG</span><span>REPS</span><span>RPE</span></div>
          ${rows}
        `;

        document.getElementById(sectionId).appendChild(card);
        attachAutosaveToCard(card);
        scheduleDraftSave();
      }

      function abrirLibParaNovo() {
        isAddingNew = true;
        document.getElementById("libHeader").innerText = "Adicionar Exerc√≠cio";
        mostrarLib();
      }
      function abrirLibParaTrocar(id) {
        isAddingNew = false;
        currentExId = id;
        document.getElementById("libHeader").innerText = "Trocar Exerc√≠cio";
        mostrarLib();
      }

      function mostrarLib() {
        const lib = document.getElementById("libContent");
        lib.innerHTML = "";
        for (let cat in biblioteca) {
          lib.innerHTML += `<div style="color:var(--blue); font-weight:bold; margin:15px 0 5px; border-bottom:1px solid #2d3748">${cat}</div>`;
          biblioteca[cat].forEach(ex => { lib.innerHTML += `<div class="lib-item" onclick="selecionar('${ex}')">${ex}</div>`; });
        }
        document.getElementById("modalLib").showModal();
      }

      function selecionar(n) {
        if (isAddingNew) {
          const active = document.querySelector(".section.active");
          if (active) criarCard(n, active.id);
        } else {
          const el = document.getElementById(currentExId);
          if (el) {
            el.innerText = n;
            const card = el.closest(".exercise-card");
            if (card) card.setAttribute("data-ex-name", n);
            scheduleDraftSave();
          }
        }
        document.getElementById("modalLib").close();
      }

      function adicionarManual() {
        const val = document.getElementById("manualName").value;
        if (val) { selecionar(val); document.getElementById("manualName").value = ""; }
      }

      function tab(idx) {
        document.querySelectorAll(".section, .pill").forEach(el => el.classList.remove("active"));
        const sec = document.getElementById(`sec${idx}`);
        const pill = document.getElementById(`p${idx}`);
        if (sec) sec.classList.add("active");
        if (pill) pill.classList.add("active");
        scheduleDraftSave();
      }

      function abrirCSVModal() {
        document.getElementById("csvTextarea").value = "";
        hideModelosCSV();
        document.getElementById("modalCSV").showModal();
      }

      /* ===== IMPORTA√á√ÉO CSV & PDF ===== */
      function normalizeTreinoKey(raw) {
        const s = String(raw || "").trim().replace(/\s+/g, " ");
        return s ? s : null;
      }

      function treinoLabel(key) {
        const k = String(key || "").trim();
        if (!k) return "Treino";
        const up = k.toUpperCase();
        if (/^[A-F]$/.test(up)) return `Treino ${up}`;
        if (up.startsWith("TREINO ")) return k;
        return `Treino ${k}`;
      }

      function splitCSVLine(line, delim) {
        const out = [];
        let cur = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
            else { inQuotes = !inQuotes; }
          } else if (!inQuotes && ch === delim) {
            out.push(cur.trim()); cur = "";
          } else {
            cur += ch;
          }
        }
        out.push(cur.trim());
        return out;
      }

      function detectDelimiter(headerLine) {
        const cComma = (headerLine.match(/,/g) || []).length;
        const cSemi = (headerLine.match(/;/g) || []).length;
        const cTab = (headerLine.match(/\t/g) || []).length;
        const best = cTab >= cSemi && cTab >= cComma ? "\t" : cSemi >= cComma ? ";" : ",";
        const bestCount = Math.max(cComma, cSemi, cTab);
        return bestCount <= 0 ? "," : best;
      }

      function sortTreinoKeys(keys, order) {
        const map = { A:1, B:2, C:3, D:4, E:5, F:6 };
        const up = keys.map(k => String(k).trim().toUpperCase());
        const allLetter = up.every(k => /^[A-F]$/.test(k));
        if (allLetter) {
          return keys.slice().sort((a,b) => (map[String(a).trim().toUpperCase()]||999) - (map[String(b).trim().toUpperCase()]||999));
        }
        return order.slice();
      }

      function buildTabsFromGrouped(grouped, orderOfAppearance) {
        const nav = document.getElementById("nav");
        const container = document.getElementById("container");
        nav.innerHTML = "";
        container.innerHTML = "";

        const rawKeys = Object.keys(grouped || {});
        if (!rawKeys.length) return;

        const orderedKeys = sortTreinoKeys(rawKeys, orderOfAppearance).slice(0, 6);

        orderedKeys.forEach((key, idx) => {
          nav.innerHTML += `<div class="pill ${idx === 0 ? "active" : ""}" id="p${idx}" onclick="tab(${idx})">${treinoLabel(key)}</div>`;
          const sec = document.createElement("div");
          sec.id = `sec${idx}`;
          sec.className = `section ${idx === 0 ? "active" : ""}`;
          sec.setAttribute("data-treino-key", key);
          container.appendChild(sec);

          (grouped[key] || []).forEach(ex => {
            criarCard(ex.exercicio, sec.id, ex.series, ex.reps, ex.rpe);
          });
        });

        addPillControls();
      }

      // IMPORTA√á√ÉO CSV CORRIGIDA
      function importarCSVFromText(csvText, alsoSaveAsTemplate = false) {
        const csv = String(csvText || "").trim();
        if (!csv) { alert("‚ö†Ô∏è Cole o CSV primeiro!"); return false; }

        const linhas = csv.split(/\r?\n/).filter(l => l.trim());
        if (linhas.length < 2) { alert("‚ö†Ô∏è CSV inv√°lido ou muito curto!"); return false; }

        const delim = detectDelimiter(linhas[0]);
        const header = splitCSVLine(linhas[0], delim).map(h => h.trim().toUpperCase());

        const idxTreino = header.indexOf("TREINO");
        const idxEx = header.indexOf("EXERC√çCIO") >= 0 ? header.indexOf("EXERC√çCIO") : header.indexOf("EXERCICIO");
        const idxSeries = header.indexOf("S√âRIES") >= 0 ? header.indexOf("S√âRIES") : header.indexOf("SERIES");
        const idxReps = header.indexOf("REPS");
        const idxRpe = header.indexOf("META RPE") >= 0 ? header.indexOf("META RPE") : header.indexOf("RPE");
        const idxDesc = header.indexOf("DESCANSO");

        if (idxTreino < 0 || idxEx < 0) {
          alert("‚ö†Ô∏è Header precisa ter: TREINO e EXERC√çCIO/EXERCICIO.");
          return false;
        }

        const grouped = {};
        const orderOfAppearance = [];

        for (let i = 1; i < linhas.length; i++) {
          const cols = splitCSVLine(linhas[i], delim);
          const treinoKey = normalizeTreinoKey(cols[idxTreino]);
          if (!treinoKey) continue;
          const exercicio = (cols[idxEx] || "").trim();
          if (!exercicio) continue;

          const seriesRaw = idxSeries >= 0 ? (cols[idxSeries] || "").trim() : "";
          const seriesNum = parseInt(String(seriesRaw).replace(/\D/g, ""), 10);
          const series = Number.isFinite(seriesNum) && seriesNum > 0 ? seriesNum : 4;

          const reps = idxReps >= 0 ? (cols[idxReps] || "").trim() : "";
          const rpe = idxRpe >= 0 ? (cols[idxRpe] || "").trim() : "";
          const descanso = idxDesc >= 0 ? (cols[idxDesc] || "").trim() : "";

          if (!grouped[treinoKey]) { grouped[treinoKey] = []; orderOfAppearance.push(treinoKey); }
          grouped[treinoKey].push({ exercicio, series, reps, rpe, descanso });
        }

        const treinoCount = Object.keys(grouped).length;
        if (treinoCount < 1) { alert("‚ö†Ô∏è N√£o encontrei linhas v√°lidas."); return false; }
        if (treinoCount > 6) { alert("‚ö†Ô∏è O CSV tem mais de 6 treinos. Usarei apenas os 6 primeiros."); }

        buildTabsFromGrouped(grouped, orderOfAppearance);
        scheduleDraftSave();

        if (alsoSaveAsTemplate) trySaveTemplate(csv);
        
        return true;
      }

      function importarCSV() {
        const sucesso = importarCSVFromText(document.getElementById("csvTextarea").value, false);
        if (sucesso) {
          document.getElementById("modalCSV").close();
          alert("‚úÖ Treino importado com sucesso!");
        }
      }

      // FUN√á√ÉO DE LEITURA DE PDF
      async function extrairTextoPDF(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        const btnLabel = input.parentElement;
        const originalText = btnLabel.innerText;
        
        btnLabel.innerText = "Lendo...";
        
        try {
          const arrayBuffer = await file.arrayBuffer();
          const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
          let fullText = "TREINO,EXERC√çCIO,S√âRIES,REPS\n"; 

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items.map(item => item.str).join(" ");
            const linhas = pageText.split(/ {2,}|\n/).filter(l => l.trim().length > 3);
            
            linhas.forEach(linha => {
               if(/[a-zA-Z]/.test(linha)) {
                   fullText += `Treino A,${linha.trim()},4,10-12\n`; 
               }
            });
          }
          document.getElementById("csvTextarea").value = fullText;
          alert("‚úÖ Texto extra√≠do! Agora ajuste o texto na caixa e clique em IMPORTAR.");
        } catch (err) {
          console.error(err);
          alert("‚ùå Erro ao ler PDF (Pode ser imagem escaneada).");
        } finally {
          btnLabel.innerHTML = `üìÑ LER PDF <input type="file" id="pdfUpload" accept=".pdf" style="display:none" onchange="extrairTextoPDF(this)">`;
          input.value = "";
        }
      }

      // GERA√á√ÉO DE PROTOCOLO INTELIGENTE (USA O CAT√ÅLOGO TREINOS_PRONTOS)
      function gerarProtocolo() {
        const f = document.getElementById("freq").value;
        const nav = document.getElementById("nav");
        const cont = document.getElementById("container");
        nav.innerHTML = ""; cont.innerHTML = "";

        const preset = TREINOS_PRONTOS[f];

        if (preset) {
           preset.forEach((treino, i) => {
             const labelCurto = treino.nome.split(" ")[0]; 
             nav.innerHTML += `<div class="pill ${i === 0 ? "active" : ""}" id="p${i}" onclick="tab(${i})">${labelCurto}</div>`;
             
             const sec = document.createElement("div");
             sec.id = `sec${i}`;
             sec.className = `section ${i === 0 ? "active" : ""}`;
             sec.setAttribute("data-treino-key", treino.nome);
             cont.appendChild(sec);

             treino.exs.forEach(exNome => {
               criarCard(exNome, sec.id); // criarCard j√° ajusta REPS baseado no OBJ
             });
           });
        } else {
           // Fallback gen√©rico caso n√£o ache o preset
           divisoes[f].forEach((nome, i) => {
             nav.innerHTML += `<div class="pill ${i === 0 ? "active" : ""}" id="p${i}" onclick="tab(${i})">${nome}</div>`;
             const sec = document.createElement("div");
             sec.id = `sec${i}`;
             sec.className = `section ${i === 0 ? "active" : ""}`;
             sec.setAttribute("data-treino-key", nome);
             cont.appendChild(sec);
             criarCard("Exerc√≠cio Base", sec.id);
           });
        }

        addPillControls();
        scheduleDraftSave();
      }

      /* ===== RASCUNHO + HIST√ìRICO ===== */
      let draftSaveTimer = null;

      function scheduleDraftSave() {
        if (draftSaveTimer) clearTimeout(draftSaveTimer);
        draftSaveTimer = setTimeout(() => {
          try {
            const st = serializeCurrentState();
            localStorage.setItem(STORAGE.draftKey, JSON.stringify(st));
          } catch (_) {}
        }, 300);
      }

      function getActiveIdx() {
        const pills = Array.from(document.querySelectorAll("#nav .pill")).filter(p => !p.classList.contains("add-pill"));
        const active = pills.find(p => p.classList.contains("active"));
        const idx = pills.indexOf(active);
        return idx >= 0 ? idx : 0;
      }

      function serializeCurrentState() {
        const freq = document.getElementById("freq").value;
        const obj = document.getElementById("obj").value;
        const pillEls = Array.from(document.querySelectorAll("#nav .pill")).filter(p => !p.classList.contains("add-pill"));
        const pills = pillEls.map((p, i) => ({ idx: i, label: p.textContent.replace("√ó", "").trim() }));

        const sections = Array.from(document.querySelectorAll("#container .section")).map((sec, secIdx) => {
          const treinoKey = sec.getAttribute("data-treino-key") || pills[secIdx]?.label || `Treino ${secIdx + 1}`;
          const cards = Array.from(sec.querySelectorAll(".exercise-card")).map(card => {
            const nameEl = card.querySelector(".ex-title");
            const exName = nameEl ? nameEl.textContent.trim() : (card.getAttribute("data-ex-name") || "Exerc√≠cio");
            const exSets = parseInt(card.getAttribute("data-ex-sets") || "0", 10) || 0;
            const metaEl = card.querySelector(".ex-target");
            const meta = metaEl ? metaEl.textContent.trim() : "";
            const rows = Array.from(card.querySelectorAll(".series-grid")).slice(1);
            const values = rows.map(r => {
              const inputs = r.querySelectorAll("input");
              return { kg: inputs[0]?.value ?? "", reps: inputs[1]?.value ?? "", rpe: inputs[2]?.value ?? "" };
            });
            return { name: exName, sets: exSets, meta, values };
          });
          return { treinoKey, cards };
        });

        return { v: 2, savedAt: new Date().toISOString(), freq, obj, activeIdx: getActiveIdx(), pills, sections };
      }

      function loadState(state) {
        if (!state || !Array.isArray(state.sections)) return false;
        try {
          if (state.freq) document.getElementById("freq").value = state.freq;
          if (state.obj) document.getElementById("obj").value = state.obj;
        } catch (_) {}

        document.getElementById("nav").innerHTML = "";
        document.getElementById("container").innerHTML = "";
        const sections = state.sections.slice(0, 6);

        sections.forEach((secData, idx) => {
          const label = (state.pills && state.pills[idx] && state.pills[idx].label) ? state.pills[idx].label : treinoLabel(secData.treinoKey);
          document.getElementById("nav").innerHTML += `<div class="pill ${idx === 0 ? "active" : ""}" id="p${idx}" onclick="tab(${idx})">${label}</div>`;
          const sec = document.createElement("div");
          sec.id = `sec${idx}`;
          sec.className = `section ${idx === 0 ? "active" : ""}`;
          sec.setAttribute("data-treino-key", secData.treinoKey || label);
          document.getElementById("container").appendChild(sec);

          (secData.cards || []).forEach(c => {
            let metaReps = null;
            if (typeof c.meta === "string") {
              const m = c.meta.split("Sets x");
              if (m.length === 2) metaReps = m[1].trim();
            }
            criarCard(c.name, sec.id, c.sets || null, metaReps, null, c.values || null);
          });
        });

        addPillControls();
        const idx = Math.min(Math.max(parseInt(state.activeIdx || 0, 10), 0), Math.max(0, sections.length - 1));
        tab(idx);
        return true;
      }

      function getHistory() {
        try {
          const raw = localStorage.getItem(STORAGE.historyKey);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch (_) { return []; }
      }

      function setHistory(arr) {
        try { localStorage.setItem(STORAGE.historyKey, JSON.stringify(arr)); } catch (_) {}
      }

      function salvarTreino() {
        try {
          const pesoAtual = prompt("Peso atual (kg)? Digite apenas o n√∫mero.");
          const st = serializeCurrentState();
          const item = { 
            id: "sess_" + Math.random().toString(36).slice(2) + "_" + Date.now(), 
            createdAt: new Date().toISOString(), 
            state: st,
            bodyWeight: pesoAtual ? parseFloat(pesoAtual) : null 
          };
          
          const hist = getHistory();
          hist.unshift(item);
          if (hist.length > STORAGE.maxHistory) hist.length = STORAGE.maxHistory;
          setHistory(hist);
          localStorage.setItem(STORAGE.draftKey, JSON.stringify(st));
          
          checkDeload();
          alert("‚úÖ Sess√£o salva no hist√≥rico!");
        } catch (e) {
          console.error(e);
          alert("‚ö†Ô∏è Armazenamento cheio ou bloqueado.");
        }
      }

      /* ===== COACH LOGIC: VOL, RPE, GR√ÅFICOS ===== */
      function calcVolumeTotal(state) {
        if (!state || !state.sections) return 0;
        let vol = 0;
        state.sections.forEach(sec => {
            sec.cards.forEach(card => {
                card.values.forEach(v => {
                    const k = parseFloat(v.kg) || 0;
                    const r = parseFloat(v.reps) || 0;
                    vol += (k * r);
                });
            });
        });
        return vol;
      }

      function checkDeload() {
        const hist = getHistory().slice(0, 7).reverse();
        if (hist.length < 2) return;
        const volumes = hist.map(h => calcVolumeTotal(h.state)); 
        const ultimo = volumes[volumes.length-1];
        const penultimo = volumes[volumes.length-2];
        if (ultimo > 0 && penultimo > 0) {
           const trend = (ultimo - penultimo) / penultimo * 100;
           if (trend < -15) alert("‚ö†Ô∏è ALERTA: Volume caiu bruscamente (-15%). Se n√£o for Deload planejado, revise a dieta/sono.");
        }
      }

      function updateSuggests(id) {
        const card = document.querySelector(`[data-ex-id="${id}"]`);
        if(!card) return;
        const inputs = card.querySelectorAll("input");
        let kg = 0, reps = 0;
        for(let i=0; i < inputs.length; i+=3) {
           if(inputs[i].value && inputs[i+1].value) {
               kg = parseFloat(inputs[i].value);
               reps = parseFloat(inputs[i+1].value);
               break; 
           }
        }
        if (kg && reps) {
            const epley1rm = kg * (1 + reps/30);
            const el1rm = document.getElementById(`1rm-${id}`);
            const elRpe = document.getElementById(`rpe-${id}`);
            if(el1rm) el1rm.textContent = Math.round(epley1rm) + "kg";
            if(elRpe) elRpe.textContent = reps > 10 ? "RPE 8-9 (Resist√™ncia)" : "RPE 9-10 (For√ßa)";
        }
      }

      function showEvoChart() {
        const hist = getHistory().reverse();
        if(hist.length === 0) { alert("Sem hist√≥rico para gerar gr√°ficos."); return; }

        const data = hist.map(h => ({ 
            date: formatSaoPaulo(h.createdAt).split(' ')[0], 
            vol: calcVolumeTotal(h.state)
        }));

        const modal = document.createElement('dialog');
        modal.style.cssText = "background:#161e2e; border:1px solid var(--blue); border-radius:12px; width:95%; max-width:600px; padding:20px;";
        
        const canvas = document.createElement('canvas'); 
        canvas.width=300; canvas.height=200;

        const closeBtn = document.createElement('button');
        closeBtn.innerText = "FECHAR GR√ÅFICO";
        closeBtn.className = "btn";
        closeBtn.style.cssText = "background:var(--red); color:white; margin-top:10px; width:100%";
        closeBtn.onclick = () => { modal.close(); modal.remove(); };

        modal.appendChild(canvas); 
        modal.appendChild(closeBtn);
        document.body.appendChild(modal); 
        modal.showModal();
        
        new Chart(canvas, {
            type: 'line',
            data: { 
                labels: data.map(d => d.date), 
                datasets: [{ 
                    label: 'Volume Total (Kg Total)', 
                    data: data.map(d => d.vol),
                    borderColor: '#38b2ac',
                    backgroundColor: 'rgba(56, 178, 172, 0.2)',
                    tension: 0.3,
                    fill: true
                }] 
            },
            options: { 
                responsive: true, 
                plugins: { legend: { labels: { color: 'white' } } },
                scales: { 
                    y: { beginAtZero: true, ticks: { color: '#a0aec0' }, grid: { color: '#2d3748'} },
                    x: { ticks: { color: '#a0aec0' }, grid: { color: '#2d3748'} }
                } 
            }
        });
      }

      function formatSaoPaulo(iso) {
        try {
          const d = iso ? new Date(iso) : new Date();
          return new Intl.DateTimeFormat("pt-BR", {
            timeZone: "America/Sao_Paulo",
            year: "numeric", month: "2-digit", day: "2-digit",
            hour: "2-digit", minute: "2-digit"
          }).format(d);
        } catch (_) { return iso || ""; }
      }

      function renderHistorico() {
        const list = document.getElementById("histList");
        const hist = getHistory();
        if (!hist.length) { list.innerHTML = `<div class="hist-item">Nenhuma sess√£o salva.</div>`; return; }

        list.innerHTML = "";
        hist.forEach(item => {
          const dt = formatSaoPaulo(item.createdAt);
          const peso = item.bodyWeight ? ` | ${item.bodyWeight}kg` : "";
          const treinoCount = (item.state && item.state.sections) ? item.state.sections.length : 0;
          const exCount = (item.state && item.state.sections) ? item.state.sections.reduce((acc, s) => acc + (s.cards ? s.cards.length : 0), 0) : 0;

          const row = document.createElement("div");
          row.className = "hist-item";
          row.innerHTML = `<strong>${dt}${peso}</strong><div style="color:#a0aec0; font-size:0.75rem; margin-top:4px;">${treinoCount} treinos ‚Ä¢ ${exCount} exerc√≠cios</div>`;
          row.onclick = () => {
            try {
              if (item.state) {
                loadState(item.state);
                scheduleDraftSave();
                document.getElementById("modalHIST").close();
                alert("‚úÖ Sess√£o carregada!");
              }
            } catch (_) { alert("‚ö†Ô∏è Erro ao carregar sess√£o."); }
          };
          list.appendChild(row);
        });
      }

      function verHistorico() { renderHistorico(); document.getElementById("modalHIST").showModal(); }
      function limparHistorico() { try { localStorage.removeItem(STORAGE.historyKey); renderHistorico(); } catch (_) {} }

      function adicionarTreino() {
        const st = serializeCurrentState();
        if (!st.sections) st.sections = [];
        if (!st.pills) st.pills = [];
        if (st.sections.length >= 6) { alert("‚ö†Ô∏è Limite m√°ximo: 6 treinos."); return; }
        const nome = prompt("Nome do novo treino (ex.: Treino D):");
        if (!nome) return;
        const key = normalizeTreinoKey(nome);
        if (!key) return;
        st.sections.push({ treinoKey: key, cards: [] });
        st.pills.push({ idx: st.pills.length, label: treinoLabel(key) });
        st.activeIdx = st.sections.length - 1;
        loadState(st); scheduleDraftSave();
      }

      function excluirTreinoPorIdx(idx) {
        const st = serializeCurrentState();
        if (!st.sections || st.sections.length <= 1) { alert("‚ö†Ô∏è Mantenha pelo menos 1 treino."); return; }
        if (!confirm("Excluir esta aba e exerc√≠cios?")) return;
        st.sections.splice(idx, 1);
        if (Array.isArray(st.pills)) st.pills.splice(idx, 1);
        st.pills = (st.pills || []).map((p, i) => ({ idx: i, label: p.label }));
        st.activeIdx = Math.min(Math.max(0, st.activeIdx || 0), st.sections.length - 1);
        loadState(st); scheduleDraftSave();
      }

      function addPillControls() {
        const nav = document.getElementById("nav");
        const oldAdd = nav.querySelector(".pill.add-pill");
        if (oldAdd) oldAdd.remove();
        const pills = Array.from(nav.querySelectorAll(".pill")).filter(p => !p.classList.contains("add-pill"));
        pills.forEach((pill, idx) => {
          const existing = pill.querySelector(".pill-x");
          if (existing) existing.remove();
          const x = document.createElement("span");
          x.className = "pill-x"; x.textContent = "√ó";
          x.onclick = (ev) => { ev.preventDefault(); ev.stopPropagation(); excluirTreinoPorIdx(idx); };
          pill.appendChild(x);
        });
        const add = document.createElement("div");
        add.className = "pill add-pill"; add.textContent = "+";
        add.onclick = () => adicionarTreino();
        nav.appendChild(add);
      }

      /* ===== TEMPLATES CSV ===== */
      function getCSVTemplates() { try { return JSON.parse(localStorage.getItem(STORAGE.csvTplKey)) || []; } catch { return []; } }
      function setCSVTemplates(arr) { try { localStorage.setItem(STORAGE.csvTplKey, JSON.stringify(arr)); } catch {} }
      
      function trySaveTemplate(csv) {
        const name = prompt("Nome do modelo (ex.: Upper-Lower):");
        if (!name) return;
        const arr = getCSVTemplates();
        arr.unshift({ id: "tpl_" + Date.now(), name: String(name).trim(), createdAt: new Date().toISOString(), csv: String(csv) });
        if (arr.length > STORAGE.maxTemplates) arr.length = STORAGE.maxTemplates;
        setCSVTemplates(arr);
        alert("‚úÖ Modelo salvo!");
      }

      function salvarModeloCSV() {
        const csv = document.getElementById("csvTextarea").value.trim();
        if (!csv) { alert("‚ö†Ô∏è Cole o CSV primeiro!"); return; }
        trySaveTemplate(csv);
      }

      function mostrarModelosCSV() {
        document.getElementById("tplArea").style.display = "block";
        const list = document.getElementById("tplList");
        const arr = getCSVTemplates();
        if (!arr.length) { list.innerHTML = `<div class="tpl-item">Sem modelos salvos.</div>`; return; }
        list.innerHTML = "";
        arr.forEach(tpl => {
          const row = document.createElement("div");
          row.className = "tpl-item";
          row.innerHTML = `<strong style="color:var(--orange);">${escapeHTML(tpl.name)}</strong><small>${formatSaoPaulo(tpl.createdAt)}</small>`;
          row.onclick = () => { if(confirm(`Carregar "${tpl.name}"?`)) { importarCSVFromText(tpl.csv, false); document.getElementById("modalCSV").close(); alert("‚úÖ Carregado!"); }};
          row.oncontextmenu = (e) => { e.preventDefault(); if(confirm(`Excluir "${tpl.name}"?`)) { deleteTemplateById(tpl.id); }};
          list.appendChild(row);
        });
        list.innerHTML += `<div class="tpl-item"><small>Toque para carregar. Segure para excluir.</small></div>`;
      }

      function deleteTemplateById(id) { setCSVTemplates(getCSVTemplates().filter(t => t.id !== id)); mostrarModelosCSV(); }
      function limparModelosCSV() { if(confirm("Apagar tudo?")) localStorage.removeItem(STORAGE.csvTplKey); mostrarModelosCSV(); }
      function hideModelosCSV() { document.getElementById("tplArea").style.display = "none"; }
      function escapeHTML(s) { return String(s ?? "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }

      window.onload = () => {
        try { document.getElementById("displayDate").innerText = new Date().toLocaleDateString("pt-BR", { timeZone: "America/Sao_Paulo" }); } catch {}
        let loaded = false;
        try { const raw = localStorage.getItem(STORAGE.draftKey); if (raw) loaded = loadState(JSON.parse(raw)); } catch {}
        if (!loaded) gerarProtocolo();
        document.getElementById("freq").addEventListener("change", gerarProtocolo, { passive: true });
        document.getElementById("obj").addEventListener("change", gerarProtocolo, { passive: true });
        openConfig();
      };
    </script>
  </body>
</html>
